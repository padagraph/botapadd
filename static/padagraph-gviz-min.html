<html><head><meta charset="UTF-8"></head><body><div hidden="" by-vulcanize=""><dom-module id="padagraph-node-completion-card" assetpath=""><template><style>:host {
    width: 100%;
}

.content .actions {
    margin-top: 3px;
    cursor: link;
}
span.nodetype{
    color: #333;
    font-size:24px;
}

.metadata .nodetype{
    font-size: 16px !important;
    margin-left: 24px !important;
}

    </style><div class="content"><template is="dom-if" if="{{ actionmap.select }}"><i class="circle thin icon"></i><a on-click="handleSelect" class="author">{{model.label}}</a><div class="metadata"><div class="rating">{{model.nodetype}}</div></div></template><template is="dom-if" if="{{ !actionmap.select }}"><i class="circle thin icon nodetype"></i><span class="nodetype">{{model.label}}</span><template is="dom-if" if="{{ notext }}"><div class="text"></div></template><div class="metadata"><div class="nodetype">{{model.nodetype}}</div></div></template><template is="dom-if" if="{{actions}}"><div class="actions"><template is="dom-if" if="{{actionmap.add}}"><a on-click="handleAdd"><i class="plus icon"></i> Add to view</a></template><template is="dom-if" if="{{actionmap.explore}}"><a on-click="handleExplore"><i class="bullseye icon"></i> Explore</a></template><template is="dom-if" if="{{actionmap.remove}}"><a on-click="handleRemove"><i class="remove icon"></i> Remove</a></template></div></template></div></template><script>'use strict';

require(['backbone', 'underscore'], function (Backbone, _) {
  Polymer({
    is: "padagraph-node-completion-card",
    properties: {
      model: Object,

      actions: {
        type: Object,
        observer: '_updateActions'
      },

      actionmap: Object,
      options: String,

      notext: {
        type: Number,
        computed: "has_hext(options)"
      }
    },

    _updateActions: function _updateActions() {

      var actions = _.isNull(this.actions) ? [] : this.actions;
      actions = _.isString(actions) ? actions.split(',') : actions;
      actions = _.isArray(actions) ? actions : [actions];

      this.actionmap = {
        'add': _.indexOf(actions, "add") > -1,
        'explore': _.indexOf(actions, "explore") > -1,
        'select': _.indexOf(actions, "select") > -1,
        'expand': _.indexOf(actions, "expand") > -1,
        'remove': _.indexOf(actions, "remove") > -1
      };

      this.notifyPath('actionmap', this.actionmap);
    },

    has_text: function has_text() {
      return options != "notext";
    },

    handleSelect: function handleSelect() {
      this.fire('completion-select', this.model);
      this.fire('completion-close');
    },

    handleRemove: function handleRemove() {
      this.fire('completion-remove', this.model);
      this.fire('completion-close');
    },

    handleAdd: function handleAdd() {
      Backbone.trigger('engine:additive_nodes', [this.model.uuid]);
      this.fire('completion-close');
    },

    handleExplore: function handleExplore() {
      var params = { graph: this.graph, query: this.model.uuid };
      Backbone.trigger('engine:explore', params);
      this.fire('completion-close');
    }
  });
});</script></dom-module><dom-module id="padagraph-node-search" assetpath="./"><template><style>.scrollable {
  min-width:400px !important;
  max-height:400px;
  overflow:auto;
  text-align:left !important;
}

span.nodetype{
  font-size: 16px !important;
  margin-left: 24px !important;
  color: rgba(0,0,0,.4);
  font-size:24px;
}
</style><div class="ui icon input"><input id="search" name="search" type="text" autocomplete="off" value="{{value::input}}" placeholder="{{placeholder}}" on-keyup="keyHandler"><i class="search icon"></i></div><div class="ui fluid popup bottom left transition"><div class="ui left aligned column"><div class="ui scrollable comments"><template is="dom-repeat" items="[[completions]]"><template is="dom-if" if="{{item.model}}"><div style="display:inline;" class="card"><padagraph-vertex-card-xs model="{{item.model}}" actions="select"></padagraph-vertex-card-xs><span class="nodetype">{{item.model.nodetype.label}}</span></div></template><template is="dom-if" if="{{!item.model}}"><padagraph-node-completion-card option="notext" actions="{{actions}}" model="{{item}}" on-completion-close="handleClose" class="comment"></padagraph-node-completion-card></template><div class="ui divider"></div></template></div></div></div></template><script>'use strict';

require(['jquery', 'backbone', 'semantic'], function ($, Backbone) {
  Polymer({

    is: "padagraph-node-search",

    properties: {
      placeholder: String,
      graph: Object,
      actions: String,
      value: String
    },

    attached: function attached() {
      var _this = this;

      this.completions = [];

      this.async(function () {
        var $popup = $('.input', Polymer.dom(_this).node);
        $popup.popup({
          on: 'click',
          onShow: (function () {
            return _this.completions.length > 0;
          }).bind(_this),
          inline: true,
          hoverable: true,
          position: 'bottom left',
          delay: {
            show: 0,
            hide: 100
          }
        });
        var oldSearchValue = "";
        window.setInterval(function () {
          var currentSearchValue = _this.value;
          if (oldSearchValue != currentSearchValue) {
            if (currentSearchValue && currentSearchValue.length > 0) _this.complete();
            oldSearchValue = currentSearchValue;
          }
        }, 1000);
      });
    },

    hide: function hide() {
      $('.input', Polymer.dom(this).node).popup('hide');
    },

    show: function show() {

      $('.input', Polymer.dom(this).node).popup('show');
    },

    handleClose: function handleClose() {
      this.completions = [];
      this.value = "";
      this.hide();
    },

    keyHandler: function keyHandler(e) {

      if (!this.value || !this.value.length) return;

      if (e.keyCode == 13) {

        // add first node to the view
        //if (this.completions.length){
        //var model = this.completions[0];
        //Backbone.trigger('engine:additive_nodes', [model.uuid]);
        //this.handleClose();
        //}
        //else {
        //}
        this.fire("complete:valid", { complete: null, value: this.value });
      }
      //else
      //    this.complete();
    },

    complete: function complete() {

      var self = this;
      var url_root = this.graph.url();

      $.ajax({
        url: url_root + '/complete',
        type: "POST",
        data: JSON.stringify({
          obj_type: "node",
          prefix: this.value,
          start: 0
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function success(data) {

          var complete = data.complete;
          complete.forEach(function (e, i) {
            var m = self.graph.vs.get(e.uuid);
            e.model = m ? m : null;
          });

          self.completions = complete;
          self.show();
        },
        error: function error() {
          Backbone.trigger('complete:error'); // our custom event
        }
      });
    }

  });
});</script></dom-module><dom-module id="padagraph-keb-sample" assetpath="./"><style></style><template><template is="dom-if" if="{{ locutions.length }}"><template is="dom-repeat" items="[[locutions]]">{{item}}</template></template></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-keb-sample",

    properties: {

      app: { type: Object, value: function value() {} },
      graph: { type: Object, value: function value() {} },
      options: { type: Object, value: function value() {} }

    },

    observers: ["create_once(app, graph, options)"]

  });
});</script></dom-module><dom-module id="keb-option" assetpath="./"><style>label .name { font-weight:bold; }
</style><template><template is="dom-if" if="{{ isBoolean(option) }}"><div class="ui checkbox"><input type="checkbox" on-change="bool_changed" checked="{{value::input}}"><label>{{option.name}}</label></div></template><template is="dom-if" if="{{ isEditable(option) }}"><label><span class="name">{{option.name}} :</span><br><span class="help">{{option.otype.help}}</span></label><input value="{{value::input}}"><br></template><template is="dom-if" if="{{ isChoice(option) }}"><label>{{option.name}} {{option.otype.help}}</label><select value="{{value}}" multiple$="{{option.otype.multi}}" on-change="observe_input"><template is="dom-repeat" items="[[option.otype.choices]]"><option selected$="{{isSelected(option, item)}}" value="{{item}}">{{item}} </option></template></select></template></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
    Polymer({
        is: "keb-option",

        properties: {
            comp: Object,
            option: Object,
            value: String
        },

        observers: ["observe(comp, option)", "observe_input(value)"],

        observe: function observe(comp, option) {
            var _this = this;

            console.log(comp, option, this.value);
            if (this.value != option.value) this.value = option.value;

            this.option.on('change', function (option) {
                if (!_this.option.otype.multi) if (_this.value != option.value) _this.value = option.value;
            });
        },

        observe_input: function observe_input(value) {

            console.log("setting ", this.option.name, value);

            if (this.option.otype.type == 'Boolean') {
                return;
            }
            if (this.option.otype.choices) {
                var values = null;
                var $select = this.$$("select");
                if ($select) {
                    var options = Array.from($select.selectedOptions);
                    values = options.map(function (e) {
                        return e.value;
                    });
                    if (this.option.otype.multi) {
                        this.option.set('value', values);
                    } else {
                        this.option.value = values.length ? values[0] : "";
                    }
                }
            } else if (this.option.value != value) {
                this.option.value = this.option.parse(value);
            }
        },

        isBoolean: function isBoolean(option) {
            return option.otype.type == 'Boolean';
        },
        bool_changed: function bool_changed() {
            this.option.value = !this.option.value;
        },

        isChoice: function isChoice(option) {
            return option.otype.choices != null;
        },
        isSelected: function isSelected(option, item) {
            if (option.otype.multi) return option.value.indexOf(option.parse(item)) >= 0;else return option.value == option.parse(item);
        },

        isEditable: function isEditable(option) {
            return !this.isChoice(option) && (this.isText(this.option) || this.isNumeric(this.option));
        },
        isText: function isText(option) {
            return option.otype.type == 'Text';
        },
        isNumeric: function isNumeric(option) {
            return option.otype.type == 'Numeric';
        }

    });
});</script></dom-module><dom-module id="keb-optionable" assetpath="./"><style>.options_form_menu {
    margin: 4px;
}
.options_form_menu.hidden {
    display:none;
}
.optionable.item {
    cursor:pointer;
    padding: 5px;
    margin-bottom: 12px;
    background: #FAFAFA;
}
.optionable.selected.item {
    background: #EAEAEA;
    border: 1px solid #CCC;
}

.optionable a.button {
    padding: 2px;
    margin-left: 0px;
    background: none;
}
  </style><template><div>{{comp.description}}</div><div class$="{{optionable_css(comp.selected)}}" on-tap="select_component" class="optionable item"><template is="dom-if" if="{{ !comp.selected }}"><a> <i class="caret right icon"></i>{{comp.name}}</a></template><template is="dom-if" if="{{ comp.selected }}"><a class="selected"><i class="checkmark icon"></i>{{comp.name}}</a><a on-tap="play" class="ui right floated button"><i class="video play icon"></i></a></template><template is="dom-if" if="{{comp.options.models.length}}"><div class="options_form_menu"><div class="ui small form"><fieldset><template is="dom-repeat" items="[[comp.options.models]]" as="opt"><div class="inline field"><keb-option comp="{{comp}}" option="{{opt}}"></keb-option></div></template><!--template(is="dom-if", if="{{ comp.selected }}"  )//template(is="dom-if", if="{{ !comp.selected }}" )
  //label {{ opt.name }} : 
  //span {{opt.value}}
  //br/
--></fieldset></div></div></template></div></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "keb-optionable",

    properties: {
      engine: Object,
      block: Object,
      comp: Object
    },

    observers: ["observe(comp)"],

    created: function created() {
      this._listener = {};
      _.extend(this._listener, Backbone.Events);
    },

    observe: function observe(comp) {
      var _this = this;

      this._listener.stopListening();
      this._listener.listenTo(comp, 'change:selected', function () {
        _this.notifyPath('comp.selected');
      });
    },

    optionable_css: function optionable_css(selected) {
      var classes = 'optionable item';
      if (selected) classes += ' selected';
      return classes;
    },

    select_component: function select_component(e, detail) {
      if (this.comp.get("selected") == false) this.block.select(this.comp);
    },

    play: function play() {
      this.block.select(this.comp);
      this.engine.play();
    }

  });
});</script></dom-module><dom-module id="padagraph-keb" assetpath="./"><style>.options_form_menu {
    margin: 4px;
}

a {
    color:#333;

}

a.selected {
    color:teal;
}


</style><template><div class="ui segment"> <template is="dom-repeat" items="[[engines]]" as="engine"><a name="{{engine.name}}"></a><h2 class="ui sub header"><a>{{engine.name}}</a></h2><p>{{engine.description}} </p><div class="menu"></div><template is="dom-if" if="{{ engine.blocks.models.length }}"><template is="dom-repeat" items="[[engine.blocks.models]]" as="block"><div class="block item"><!--a {{block.name}}--><div class="menu"> </div><template is="dom-repeat" items="[[block.components.models]]" as="optionable"><keb-optionable engine="[[engine]]" block="[[block]]" comp="[[optionable]]"></keb-optionable></template></div></template></template></template></div></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-keb",

    properties: {

      engines: Object

    },

    observers: ["observe_model(engines)"],

    observe_model: function observe_model(engines) {}
  });
});</script></dom-module><dom-module id="padagraph-node-property" assetpath=""><template><label>{{name}}</label><input type="text" value="{{value::input}}"></template><script>"use strict";

Polymer({
  is: "padagraph-node-property",
  properties: {
    model: Object,
    name: String,
    value: {
      type: String,
      notify: true
    }
  },
  ready: function ready() {}
});</script></dom-module><dom-module id="padagraph-node-properties-list" assetpath=""><template><style>#main {
  height: 200px;
  max-height: 200px;
  overflow-y: scroll;
 }
</style><template is="dom-repeat" items="[[model_props]]"><padagraph-node-property model="{{item.model}}" name="{{item.name}}" value="{{item.value}}" on-value-changed="handleUpdate"></padagraph-node-property></template></template><script>"use strict";

require(['backbone'], function (Backbone) {
  Polymer({
    is: "padagraph-node-properties-list",
    properties: {
      model: {
        type: Object,
        observer: "setProperties",
        value: null
      },
      // - not necessary but for create node
      uuid: {
        type: String,
        notify: true,
        observer: "setProperties"
      },

      model_props: {
        type: Array,
        notify: true,
        value: []
      }
    },

    setProperties: function setProperties() {

      var model = this.model;
      var types = null;

      if (model && model.nodetype) types = model.nodetype.attributes;else if (model && model.edgetype) types = model.edgetype.attributes;

      var props = [];

      if (model && types && types.properties) {
        props = types.properties.map(function (k) {

          var value = "";

          if (model.attributes.properties) value = model.properties.get(k.name);

          return { 'name': k.name, 'value': value, 'model': model };
        });
      }

      this.model_props = props;
    },

    handleUpdate: function handleUpdate(ev, details) {

      var model = ev.model.item.model;
      var key = ev.model.item.name;
      var value = ev.model.item.value;

      model.properties.set(key, value);
    },

    handleAdd: function handleAdd() {
      return alert('should popup missing props?');
    }

  });
});</script></dom-module><dom-module id="padagraph-vertex-card-m" assetpath=""><style>.ui.items { margin: 0px; margin-right: 6px; cursor: hand; }
.ui.items .item { margin-bottom:2px }
.ui.items .item .content { padding-left: 0.5em; }
.ui.items .item .content .header { margin-top: 0.1em; }
.ui.items .item .content .meta { margin: 0.1em .4em; }

.ui.accordion { padding-top: 0.2em;}
.ui.accordion .title { padding: 0em; font-size: 0.9em;}

.ui.comments { margin: 0px; }
.ui.comments .comment {  padding: 0em; }
.ui.comments .comment .author { font-size: 0.9em; font-weight: initial; }
.ui.comments.vertex-actions { padding-top: 0.3em; }
.ui.comments.vertex-actions .actions {
    margin-left: 40px;
    margin-top: 4px;
}
</style><template><div on-mouseover="intersect" on-mouseout="desintersect" class="ui items"><div class="item"><div on-click="select" class="ui mini image"><template is="dom-if" if="{{is_selected}}"><svg width="36px" height="36px"><circle cx="18" cy="18" r="15" fill$="{{rgb_color}}" stroke="white" stroke-width="3"></circle><text x="50%" y="55%" alignment-baseline="middle" text-anchor="middle" fill="black">{{letter}}</text></svg></template><template is="dom-if" if="{{!is_selected}}"><svg width="36px" height="36px"><circle cx="18" cy="18" r="15" fill$="{{rgb_color}}"></circle><text x="50%" y="55%" alignment-baseline="middle" text-anchor="middle" fill="black">{{letter}}</text></svg></template></div><div on-click="select" class="content"><div title="{{model.id}}" class="header">{{model.label}}</div><div class="meta"><div class="date">{{ model.nodetype.label }}</div></div></div><div style="height:12px" data-rating="1" on-click="toggle_star" class="ui star rating"><i class="icon"></i></div></div><!--.ui.accordion.vertex-actions
  .title
    b Node attributes
    i.dropdown.icon
  .content
    .ui.comments
    
      template(is="dom-repeat",items="[[model_attributes]]" )  
        .comment
          .content
            span.author {{item.name}}
            span.metadata
                .rating {{item.value}}
  
--><template is="dom-if" if="{{actions}}"><div class="ui comments vertex-actions"><div class="comment"><div class="content"><div class="actions"><!--a(on-click='edit')//| <i class="edit icon"></i> Edit
--><!--a(on-click='add_link')//| <i class="linkify icon"></i> Link
  --><a on-click="expand"><i class="share alternate icon"></i> Expand</a><a on-click="explore"><i class="eye icon"></i> Explore</a><a on-click="remove"><i class="remove icon"></i> Hide</a></div></div></div></div></template></div></template><script>'use strict';

require(['backbone', 'jquery', 'pdgconst'], function (Backbone, $, Const) {
  Polymer({
    is: "padagraph-vertex-card-m",
    properties: {
      graph: String,
      model: {
        type: Object,
        notify: true,
        observer: 'computeProperties'
      },

      // computed properties

      label: String,
      letter: String,
      rgb_color: String,
      style_color: String,
      color: Array,
      model_attributes: Array,

      is_selected: Boolean,
      has_actions: Boolean,

      actions: {
        type: Boolean,
        value: false
      },

      intersects: {
        type: Boolean,
        value: true
      }

    },

    created: function created() {
      if (!this._listener) {
        this._listener = {};
        _.extend(this._listener, Backbone.Events);
      }
    },

    attached: function attached() {
      this.async(function () {
        //$('.accordion' , this).accordion()
      });

      this.computeProperties();
    },

    handleSave: function handleSave() {
      console.log('saving', this.model);
      this.model.save();
    },

    handleSelected: function handleSelected() {
      console.log("select", this.label);
    },

    handleEditType: function handleEditType() {

      Backbone.trigger(Const.ui_edit_nodetype, this.model.nodetype);
      console.log('trigger Const.ui_edit_nodetype', this.model.nodetype);
    },
    //- computed properties

    computeProperties: function computeProperties(vertex) {

      if (vertex == null || !vertex.nodetype) return;

      this._listener.stopListening();

      this._listener.listenTo(vertex, 'addflag:selected', this.computeProperties.bind(this));
      this._listener.listenTo(vertex, 'rmflag:selected', this.computeProperties.bind(this));
      this._listener.listenTo(vertex, 'change', this.computeProperties.bind(this));

      this.degree = vertex.degree();
      this.color = vertex.get('color');

      this.is_selected = vertex.has_flag('selected');
      this.has_actions = vertex.has_flag('selected') | vertex.has_flag('intersected');
      this.rgb_color = "rgb(" + vertex.get('color') + ")";
      this.style_color = "background-color: rgb(" + vertex.get('color') + ")";

      this.model_attributes = Object.keys(vertex.attributes).map(function (k) {
        return { "name": k, "value": vertex.attributes[k] };
      });

      if (vertex.get('starred')) $(".rating i.icon", this).addClass('active');else $(".rating i.icon", this).removeClass('active');
    },

    //- actions

    toggle_star: function toggle_star() {
      if (this.model.get('starred')) this.model.unstar();else this.model.star();
      this.model.fetch();
    },

    desintersect: function desintersect(event) {
      if (this.intersects) Backbone.trigger('vertex:mouseout', this.model, event);
      //this.has_actions = this.model.has_flag('selected') | this.model.has_flag('intersected');
    },

    intersect: function intersect(event) {
      if (this.intersects) Backbone.trigger('vertex:mouseover', this.model, event);
      //this.has_actions = this.model.has_flag('selected') | this.model.has_flag('intersected');
    },

    select: function select(event) {
      Backbone.trigger(Const.select_node, this.model);
      this.computeProperties();
    },

    explore: function explore() {
      var params = { graph: this.graph, query: this.model.id };
      Backbone.trigger('engine:explore', params);
    },

    edit: function edit() {
      Backbone.trigger(Const.ui_edit_node, this.model);
    },

    add_link: function add_link() {
      Backbone.trigger(Const.ui_create_edge, { source: this.model });
    },

    expand: function expand() {

      var params = { graph: this.graph, expand: [this.model.id], weights: [] };
      Backbone.trigger('engine:expand_prox', params);
    },

    remove: function remove() {
      Backbone.trigger(Const.remove_node, this.model);
    },

    _setHeaderStyle: function _setHeaderStyle() {
      return "background-color:" + this.rgb_color;
    },

    model_attributes: function model_attributes(model) {
      return;
    },

    model_properties: function model_properties(model) {
      return;
    }

  });
});</script></dom-module><dom-module id="padagraph-vertex-card-xs" assetpath=""><template><a on-click="select" on-mouseover="intersect" class="ui label"><i style$="{{fontcolor}}" class="ui circle icon"></i>{{ model.label}}</a></template><script>'use strict';

require(['backbone', 'pdgconst'], function (Backbone, Const) {
  Polymer({
    is: "padagraph-vertex-card-xs",
    properties: {
      model: {
        type: Object,
        observer: "compute_properties"
      },

      css_class: { type: String, value: "label" },

      bgcolor: { type: String },
      fontcolor: { type: String }
    },

    ready: function ready() {
      var listener = {};
      _.extend(listener, Backbone.Events);
      this._listener = listener;
    },

    attached: function attached() {
      var _this = this;

      this._listener.stopListening();

      this._listener.listenTo(this.model, 'change', (function () {
        _this.compute_properties();
      }).bind(this));

      this.compute_properties();
    },

    //- computed properties
    compute_properties: function compute_properties() {
      this.bgcolor = "background-color:rgb(" + (this.model ? this.model.color : [0, 0, 0]) + ")";
      this.fontcolor = "color:rgb(" + (this.model ? this.model.color : [0, 0, 0]) + ")";
    },

    //- actions

    intersect: function intersect(event) {
      Backbone.trigger('vertex:mouseover', this.model, event);
    },

    select: function select(e) {
      Backbone.trigger(Const.select_node, this.model);
    }
  });
});</script></dom-module><dom-module id="padagraph-card-property" assetpath=""><style>.video-link { margin-top:3px }

.propvalue  ::content.header {cursor:pointer;}

.propvalue ::content.name {color:gray;}

.propvalue ::content .array {background-color:#FFD8BB;border:thin solid #FFB780;}
.propvalue ::content .object {background-color:#E7F1FE;border:thin solid #7DA2CE;}
.propvalue ::content .string {color:red;}
.propvalue ::content .number {color:blue;}
.propvalue ::content .function {color:green;}
.propvalue ::content .open .children {display:block;}
.propvalue ::content .closed .children {display:none;}

.propvalue ::content .arrow {background-image:url("../img/d.png"); background-repeat:no-repeat; background-color:transparent; height:15px; width:15px; display:inline-block;}

.propvalue ::content .open .arrow {background-position:-20px 0;}
.propvalue ::content .closed .arrow {background-position:0 0;}
.propvalue ::content .type {color:gray;font-size:8pt;float:right;}

.propvalue ::content .hide {display:none;}

.propvalue {width:100%;height:500px;overflow-y:scroll;}
</style><template><div style="display:inline" class="propvalue"><content id="content"></content></div></template><script>'use strict';

require(['backbone', 'underscore', 'jquery', 'pdgconst', 'json2html'], function (Backbone, _, $, Const, json2html) {

    var transforms = {
        'object': { 'tag': 'div', 'class': 'package ${show} ${type}', 'children': [{ 'tag': 'div', 'class': 'header', 'children': [{ 'tag': 'div', 'class': function _class(obj) {

                        var classes = ["arrow"];

                        if (getValue(obj.value) !== undefined) classes.push("hide");

                        return classes.join(' ');
                    } }, { 'tag': 'span', 'class': 'name', 'html': '${name}' }, { 'tag': 'span', 'class': 'value', 'html': function html(obj) {
                        var value = getValue(obj.value);
                        if (value !== undefined) return " : " + value;else return '';
                    } }, { 'tag': 'span', 'class': 'type', 'html': '${type}' }] }, { 'tag': 'div', 'class': 'children', 'children': function children(obj) {
                    return _children(obj.value);
                } }] }
    };

    function getValue(obj) {
        var type = $.type(obj);

        //Determine if this object has children
        switch (type) {
            case 'array':
            case 'object':
                return undefined;
                break;

            case 'function':
                //none
                return 'function';
                break;

            case 'string':
                return "'" + obj + "'";
                break;

            default:
                return obj;
                break;
        }
    }

    //Transform the children
    function _children(obj) {
        var type = $.type(obj);

        //Determine if this object has children
        switch (type) {
            case 'array':
            case 'object':
                return json2html.transform(obj, transforms.object);
                break;

            default:
                //This must be a litteral
                break;
        }
    }

    function convert(name, obj, show) {

        var type = $.type(obj);

        if (show === undefined) show = 'closed';

        var children = [];

        //Determine the type of this object
        switch (type) {
            case 'array':
                //Transform array
                //Itterrate through the array and add it to the elements array
                var len = obj.length;
                for (var j = 0; j < len; ++j) {
                    //Concat the return elements from this objects tranformation
                    children[j] = convert(j, obj[j]);
                }
                break;

            case 'object':
                //Transform Object
                var j = 0;
                for (var prop in obj) {
                    children[j] = convert(prop, obj[prop]);
                    j++;
                }
                break;

            default:
                //This must be a litteral (or function)
                children = obj;
                break;
        }

        return { 'name': name, 'value': children, 'type': type, 'show': show };
    }
    function regEvents(el) {

        $('.header', el).click(function () {
            var parent = $(this).parent();

            if (parent.hasClass('closed')) {
                parent.removeClass('closed');
                parent.addClass('open');
            } else {
                parent.removeClass('open');
                parent.addClass('closed');
            }
        });
    }

    Polymer({
        is: "padagraph-card-property",
        properties: {
            prop: {
                type: Object,
                observer: 'observeModel'
            }
        },

        re: {
            url: /(\b(?:https?):\/\/[-A-z0-9À-ú+&()@#\/%?=~|!:,.;]*[-A-z0-9+&@#\/%=~|])/ig,
            youtube: /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((?:\w|-){11})\??(\S+)?$/,
            vimeo: /http:\/\/(www\.)?vimeo.com\/(\d+)($|\/)/,
            dailymotion: /http:\/\/(www\.)?dailymotion.com\/video\/(\d+)($|\/)/
        },

        observeModel: function observeModel(prop) {
            var _this = this;

            var re = this.re;

            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
                for (var _iterator = Polymer.dom(this).childNodes[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    var child = _step.value;

                    Polymer.dom(this).removeChild(child);
                }
            } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
            } finally {
                try {
                    if (!_iteratorNormalCompletion && _iterator['return']) {
                        _iterator['return']();
                    }
                } finally {
                    if (_didIteratorError) {
                        throw _iteratorError;
                    }
                }
            }

            if (prop == null) return;

            var ismulti = false; // text, tags
            var value = null;
            var labels = null;

            if (_.isArray(prop.value)) {
                ismulti = true;
                labels = document.createElement("div");
                labels.setAttribute('class', 'ui labels');
                value = prop.value;
            } else if (prop.type == "json") {
                var json = JSON.parse(prop.value);
                var html = document.createElement("div");
                html.innerHTML = json2html.transform(convert('json', json, 'open'), transforms.object);
                html.setAttribute('class', 'json');
                Polymer.dom(this).appendChild(html);
                return;
            } else if (prop.value == null) {
                value = "";
                return;
            } else if (_.isString(prop.value)) {
                value = prop.value.split("\n");
            } else if (_.isNumber(prop.value)) {
                value = ["" + prop.value];
            } else {
                value = [prop.value];
            }

            var html = document.createElement("div");

            for (var i in value) {

                // no url in full text
                if (_.isObject(value[i])) {
                    var json = value[i];
                    var html = document.createElement("div");
                    html.innerHTML = json2html.transform(convert('json', json, 'open'), transforms.object);
                    html.setAttribute('class', 'json');
                    Polymer.dom(this).appendChild(html);
                }

                if (_.isString(value[i])) {
                    var text = value[i].trim();
                    if (text == "") continue;
                    if (text.match(re.url) == null) {

                        if (ismulti) {
                            // multi tags
                            var div = document.createElement("div");
                            div.setAttribute('class', 'ui label');
                            div.innerText = text;
                            labels.appendChild(div);
                        } else {
                            var span = document.createElement("span");
                            span.innerText = text;
                            if (value.length == 1) {
                                Polymer.dom(this).appendChild(span);
                                return;
                            } else {
                                html.appendChild(span);
                                var br = document.createElement("br");
                                html.appendChild(br);
                            }
                        }
                    } else {
                        // url
                        var _replace = function _replace(url) {
                            var innerHTML = "<a target='_blank' href='" + url + "'>" + url + "</a><i class='external icon video-link'> </i><br/>";
                            // Videos
                            var videos = _this._get_embed(url).filter(function (e) {
                                if (e) return true;
                            });
                            _.each(videos, function (video) {
                                innerHTML += video + "<br/>";
                            });
                            return innerHTML;
                        };

                        var content = document.createElement("div");
                        content.innerHTML = text.replace(re.url, _replace);
                        html.appendChild(content);
                    }
                }
            }
            if (labels) Polymer.dom(this).appendChild(labels);
            Polymer.dom(this).appendChild(html);
            regEvents(Polymer.dom(this).children);
        },

        _get_embed: function _get_embed(text) {

            var re = this.re;
            return _.map(text.match(re.url), function (url) {
                var video = null;
                // is youtube
                if (url.match(re.youtube)) {

                    var id = url.match(re.youtube)[1];
                    var params = url.match(re.youtube)[2] || "";
                    params = params.replace(/(^|&)t=/, "$1start=");

                    video = ['<div class="ui embed">', ' <iframe src="https://www.youtube.com/embed/' + id + '?' + params + '"', ' width="100%" ', ' frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>', '</div>'].join(' ');
                }

                // is vimeo
                else if (url.match(re.vimeo)) {

                        var id = url.match(re.vimeo)[2];
                        video = ['<div class="ui embed">', '  <iframe src="https://player.vimeo.com/video/' + id + '"', '  width="100%"', '  frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>', '</div>'].join(' ');
                    }

                    // is dailymotion
                    else if (url.match(re.dailymotion)) {

                            var id = url.match(re.dailymotion)[2];
                            video = ['<div class="ui embed">', '  <iframe src="https://www.dailymotion.com/embed/video/' + id + '"', '  width="100%"', '  frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>', '</div>'].join(' ');
                        }

                // Google maps
                //  https://www.google.fr/maps/place//@43.5297514,1.7668858,16z
                // <iframe src="https://www.google.com/maps?q=43.5297514,1.7668858,16z&output=embed"></iframe>

                if (video) return video;
            });
        }

    });
});</script></dom-module><dom-module id="padagraph-edge-card-vtx" assetpath=""><style><div id="vtx">{}</div><div class="ui items">.item { margin: 0px;  }</div><div class="ui items">.item .content { padding-left: 0.5em; text-align: center }</div><div class="ui items">.item .content .header { margin-top: 0.1em; }</div><div class="ui items">.item .content .meta { margin: 0.1em .4em; }</div></style><template><div class="ui items"> <div on-mouseover="intersect" on-click="select" style=" cursor: hand; display: inline-flex;text-align: left !important; " class="item"><div class="ui mini image"><svg width="36px" height="36px"><circle cx="18" cy="18" r="15" fill$="{{rgb_color}}" stroke="white" stroke-width="3"></circle></svg></div><div on-click="select" class="content"><div class="header">{{ model.label }}</div><div class="meta"><div class="date">{{ model.nodetype.name }}</div></div></div></div></div></template><script>'use strict';

require(['backbone', 'jquery', 'pdgconst'], function (Backbone, $, Const) {
  Polymer({
    is: "padagraph-edge-card-vtx",
    properties: {
      graph: String,
      model: {
        type: Object,
        observer: "compute_properties"
      },
      rgb_color: String

    },

    compute_properties: function compute_properties() {
      if (this.model == null) return;

      this.rgb_color = "rgb(" + this.model.get('color') + ")";
    },

    intersect: function intersect(event) {
      Backbone.trigger('vertex:mouseover', this.model, event);
    },

    select: function select(event) {
      Backbone.trigger(Const.select_node, this.model);
    }

  });
});</script></dom-module><dom-module id="padagraph-edge-card-xl" assetpath=""><style>.step {
  padding: 12px !important;
}

.ui.items { margin: 0px; }
.ui.items .item .content { margin-left: 4px; text-align: left !important;  }
.ui.items .item h3 {
  padding-top: 30px;
  width: 100%;
  text-align: center;
}

.ui.comments { margin: 0px; }
.ui.comments .comment {  padding: 0em; }

#properties { display: block; }
#properties .name {
      display: inline-block;
      color: #333;
      font-weight: bold;
      font-size: 1em;
      margin-right: 6px;
}

#properties .value { display:inline }
</style><template><div class="ui items"><div class="item"><div class="ui fluid vertical steps"><div class="step"><padagraph-edge-card-vtx model="{{model.source}}"></padagraph-edge-card-vtx></div><div class="step"><div on-mouseover="intersect" on-click="select" style="padding: 0px; display: inline-flex;text-align: left !important; " class="item"><div class="ui mini image"><i class="big long arrow right iconflex"></i></div><div on-click="select" class="content"><h3 style="padding:0; margin:0px;">{{ model.edgetype.name }}</h3></div></div></div><div class="step"><padagraph-edge-card-vtx model="{{model.target}}"></padagraph-edge-card-vtx></div></div></div><div id="properties" class="item"><h3>Properties</h3><div class="ui comments"><template is="dom-repeat" items="[[model_attributes]]"> <div class="comment"><div class="content"><span class="name">{{item.name}}</span><padagraph-card-property prop="{{item}}" class="value"></padagraph-card-property></div></div></template></div></div></div></template><script>'use strict';

require(['backbone', 'pdgconst', 'semantic'], function (Backbonen, Consts) {
  Polymer({

    is: "padagraph-edge-card-xl",

    properties: {

      model: {
        type: Object,
        observer: 'observeModel'
      },
      model_attributes: Array
    },

    observeModel: function observeModel() {
      var _this = this;

      if (!this._listener) {

        this._listener = {};
        _.extend(this._listener, Backbone.Events);
      }

      this._listener.stopListening();

      if (this.model) {
        this._computeProperties();
        this._listener.listenTo(this.model, 'change', function () {
          return _this._computeProperties();
        });
        //this._listener.listenTo(this.model.graph.es, 'change', () => this._update_neighbors());
      }
    },
    //- computed properties
    _computeProperties: function _computeProperties() {
      var _this2 = this;

      if (this.model == null) return;
      if (this.model.edgetype == null) return;

      var f = function f(name) {
        return _this2.model.properties.get(name);
      };

      this.model_attributes = this.model.edgetype.properties.models.map(function (e) {
        return {
          "name": e.name,
          "value": f(e.name)
        };
      });
    },

    _isUrl: function _isUrl(value) {
      var regex = new RegExp(/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi);
      return value != null && _.isString(value) && value.match(regex);
    },
    _isMulti: function _isMulti(name) {
      if (this.model && name) {
        var props = this.model.edgetype.properties;
        var prop = props.get(name);
        return prop.is_multi();
      }
      return false;
    }

  });
});</script></dom-module><dom-module id="padagraph-edge-type" assetpath="./"><style>.family {
    font-weight: bold;
    color: #333;
}

.edgetypelabel {
    margin-left: 1em;
}

.inline {
  display: inline;
}
</style><template><div class="inline"><span class="family normal-font">{{edgetype.name}}</span></div></template><script>'use strict';

require(['backbone', 'pdgconst'], function (Backbone, Const) {
  Polymer({
    is: "padagraph-edge-type",
    properties: {
      model: {
        type: Object
      },
      family: { type: Boolean, value: false }
    },

    observers: ["parse(model)"],

    parse: function parse(model) {

      if (!model) return;

      this.edgetype = model.parse_label();
    }

  });
});</script></dom-module><dom-module id="padagraph-vertex-xs" assetpath="./"><style>a { cursor: pointer; }
a.link:hover {text-decoration: underline}
</style><template><template is="dom-if" if="{{ vertex }}"><a class$="{{css}}" on-click="mouseclicked" on-mouseover="mouseover" on-mouseout="mouseout"><template is="dom-if" if="{{vertex.icon}}"><i style$="{{vertex.fontcolor}}" class="ui circle icon"></i></template><template is="dom-if" if="{{!vertex.icon}}"><i class="ui small black circle thin icon"></i></template><template is="dom-if" if="{{vertex.label}}"><span class="normal-font">{{vertex.label}} </span></template></a></template></template><script>'use strict';

require(['backbone', 'pdgconst'], function (Backbone, Const) {
    Polymer({
        is: "padagraph-vertex-xs",
        properties: {
            graph: Object,
            model: Object,
            id: String,
            form: { type: String, value: "" },
            css: String,

            complete: String

        },
        observers: ["observe_id(graph, id, form)", "observe(graph, model)"],

        created: function created() {

            var listener = {};
            _.extend(listener, Backbone.Events);
            this._listener = listener;
        },

        detached: function detached() {
            this._listener.stopListening();
        },

        observe_id: function observe_id(graph, id, form) {

            if (!graph || !id) return;
            if (id) {
                var _this = this;
                var vertex = this.graph.vs.filter(function (e) {
                    return e.get('uuid') == id;
                });

                if (vertex.length) {
                    this.set('model', vertex[0]);
                } else {
                    $.ajax({
                        url: "/graphs/" + id,
                        success: function success(r) {
                            var complete = r.results.response.complete;
                            if (complete.length) {
                                var model = complete[0];
                                model.id = model.uuid;
                                _this.model = model;
                            }
                        }
                    });
                }
            }
        },

        observe: function observe(graph, model) {
            var _this2 = this;

            this._listener.stopListening();

            if (this.is_model()) {
                this._listener.listenTo(this.model, 'change', function () {
                    _this2.compute_properties();
                });
            }

            if (this.is_model() == false) {
                this._listener.listenTo(this.graph.vs, 'add', function (v) {
                    if (model) {
                        var match = v.id == model.id || v.id == model.uuid;
                        if (match) _this2.set("model", v);
                    }
                });
            }

            this.compute_properties();
        },

        is_model: function is_model() {
            var _ismodel = this.model && this.model.graph;
            return _ismodel;
        },

        compute_properties: function compute_properties() {
            var model = this.model;
            var vertex = null;

            if (!model) return;

            var keys = ['label'];

            if (model.properties) {
                if (model.id) {
                    vertex = keys.map(function (e) {
                        return [e, model.properties.get(e)];
                    });
                } else {
                    vertex = keys.map(function (e) {
                        return [e, model.properties[e]];
                    });
                }
            }

            if (!vertex) {
                vertex = keys.map(function (e) {
                    return [e, model[e]];
                });
            }

            vertex = _.object(vertex);
            vertex.fontcolor = "color:rgb(" + (this.is_model() ? model.color : [0, 0, 0]) + ")";
            vertex.icon = this.is_model();

            this.vertex = vertex;
        },

        mouseout: function mouseout(event) {
            this.do_action("mouseout", event, this.model);
        },
        mouseover: function mouseover(event) {
            this.do_action("intersect", event, this.model);
        },

        mouseclicked: function mouseclicked(event) {
            var ismodel = this.is_model();
            this.do_action(ismodel ? "select" : "add", event, this.model);
        },

        do_action: function do_action(action, event, model) {

            if (!model) return;

            var ismodel = this.is_model();

            if (action == 'add') {
                if (model.uuid) {
                    Backbone.trigger('engine:additive_nodes', [model.uuid]);
                } else {
                    $.ajax({
                        url: "../complete/uuid/" + model.id,
                        success: function success(r) {
                            var node = r.results.response.node;
                            if (node) {
                                Backbone.trigger('engine:additive_nodes', [node.uuid]);
                            }
                        }
                    });
                }
            } else if (action == 'mouseout') {
                if (ismodel) Backbone.trigger('vertex:mouseout', model, event);
            } else if (action == 'intersect') {
                if (ismodel) Backbone.trigger('vertex:mouseover', model, event);
            } else if (action == 'select') {
                if (ismodel) Backbone.trigger('select_node', model);
            } else if (action == 'explore') {
                if (ismodel) {
                    var params = { graph: this.model.graph.id, query: this.model.id };
                    Backbone.trigger('engine:explore', params);
                }
            } else if (action == 'expand') {
                var params = { graph: this.model.graph.id, expand: [this.model.id], weights: [] };
                Backbone.trigger('engine:expand_prox', params);
            } else if (action == 'remove') {
                Backbone.trigger(Const.remove_node, this.model);
            }
        }

    });
});</script></dom-module><dom-module id="padagraph-vtx-neighbors" assetpath="./"><style>h4 { color : #333; }
</style><template><div id="neighbourhood" class="item"><template is="dom-repeat" items="[[by_edgetypes]]" as="item"><template is="dom-if" if="[[ item.neighbors.length ]]"><div class="content"><padagraph-edge-type model="[[item.edgetype]]"></padagraph-edge-type><div class="neighbors"><template is="dom-repeat" items="[[item.neighbors]]" as="neighbor"><div class="neighbor"><i class$="[[neighbor.icon]]" title="{{neighbor.direction}}"></i><padagraph-vertex-xs graph="[[graph]]" model="{{neighbor.node}}"></padagraph-vertex-xs></div></template></div></div></template></template></div></template><script>'use strict';

var _slicedToArray = (function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i['return']) _i['return'](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError('Invalid attempt to destructure non-iterable instance'); } }; })();

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
    Polymer({
        is: "padagraph-vtx-neighbors",
        properties: {
            graph: Object,
            model: Object,
            mode: { type: String, value: "OUT" }
        },

        observers: ['observe(graph, model)'],

        observe: function observe(graph, model) {
            var _this = this;

            //this.lfs = model ? Object.values(JSON.parse(model.properties.get('lfs'))) : []

            if (!this._listener) {
                this._listener = {};
                _.extend(this._listener, Backbone.Events);
            }

            this._listener.stopListening();

            if (!graph || !model) return;

            var fetch = function fetch() {

                var success = function success(data) {
                    _this._update_neighbors();
                };

                if (model.fetch_neighbors) model.fetch_neighbors(_this.mode, success);
            };

            this._listener.listenTo(this.model.graph.vs, 'add', function (m) {
                return fetch(m);
            });

            fetch(model);
        },

        _update_neighbors: function _update_neighbors() {

            if (this.model == null || this.model.graph == null) return;

            var neighbors = this.model._neighbors;
            var nodetypes = _.chain(neighbors).map(function (d) {
                return d[2].nodetype;
            }).uniq().map(function (d) {
                return [d, []];
            }).object().value();

            var edgetypes = _.chain(neighbors).map(function (d) {
                return d[0].edgetype;
            }).uniq().map(function (d) {
                return [d, []];
            }).object().value();

            var graph = this.model.graph;
            var vs = this.model.graph.vs;
            var es = this.model.graph.es;

            var _iteratorNormalCompletion = true;
            var _didIteratorError = false;
            var _iteratorError = undefined;

            try {
                for (var _iterator = neighbors[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                    var _step$value = _slicedToArray(_step.value, 3);

                    var edge = _step$value[0];
                    var relation = _step$value[1];
                    var node = _step$value[2];

                    var _node = vs.get(node.uuid) ? vs.get(node.uuid) : node;
                    var _edge = es.get(edge.uuid) ? es.get(edge.uuid) : edge;

                    //or 'resize horizontal icon' the day we have undirected links
                    var direction_icon = relation == "IN" ? 'long arrow left icon' : 'long arrow right icon';

                    var edgetype = graph.edgetypes.get(edge.edgetype);
                    var nodetype = graph.nodetypes.get(node.nodetype);

                    nodetypes[nodetype.id].push({ 'edgetype': edgetype.name, // name
                        'edge': _edge, // bb model or dict
                        'relation': relation, // str
                        'node': _node, //- bb model or dict
                        'icon': direction_icon
                    });

                    edgetypes[edgetype.id].push({ 'edgetype': edgetype.name, //name
                        'edge': _edge, // bb model or dict
                        'relation': relation, // str
                        'node': _node, //- bb model or dict
                        'icon': direction_icon
                    });
                }
            } catch (err) {
                _didIteratorError = true;
                _iteratorError = err;
            } finally {
                try {
                    if (!_iteratorNormalCompletion && _iterator['return']) {
                        _iterator['return']();
                    }
                } finally {
                    if (_didIteratorError) {
                        throw _iteratorError;
                    }
                }
            }

            this.by_nodetypes = _.chain(nodetypes).pairs().sortBy(function (_ref) {
                var _ref2 = _slicedToArray(_ref, 2);

                var k = _ref2[0];
                var e = _ref2[1];
                return e.length;
            }).map(function (_ref3) {
                var _ref32 = _slicedToArray(_ref3, 2);

                var k = _ref32[0];
                var e = _ref32[1];
                return {
                    nodetype: graph.nodetypes.get(k),
                    neighbors: e
                };
            }).value();

            var edgetype_filter = function edgetype_filter(e) {
                return true;
            };

            var sort_neighbors = function sort_neighbors(a, b) {
                return 1;
            };

            this.by_edgetypes = _.chain(edgetypes).pairs().sortBy(function (_ref4) {
                var _ref42 = _slicedToArray(_ref4, 2);

                var k = _ref42[0];
                var e = _ref42[1];
                return e.length;
            }).reverse().map(function (_ref5) {
                var _ref52 = _slicedToArray(_ref5, 2);

                var k = _ref52[0];
                var e = _ref52[1];

                var family = graph.edgetypes.get(k).parse_label()['family'];
                return {
                    uuid: k,
                    edgetype: graph.edgetypes.get(k),
                    family: family,
                    neighbors: e.sort(sort_neighbors)
                };
            }).filter(edgetype_filter).sort(function (a, b) {
                return 1;
            }).value();
        }

    });
});</script></dom-module><dom-module id="padagraph-cluster-popup" assetpath="./"><style>.card { width:400px}
.card .intersected { margin:4px; padding: 2px; border:none; }
a.more { padding-right:12px; margin-top: -12px; }

span.name {
       display: inline-block;
       color: #333;
       font-weight: bold;
       font-size: 1em;
       margin-right: 6px;
   }
//.position {
   //position:absolute;
   //top: 12px;
   //left: 12px;
   //max-height: calc(100% - 24px);
   //overflow-y: auto;
   //z-index:1;
//}
</style><template><template is="dom-if" if="{{ clusters }}"> <div class="ui card"></div></template></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-cluster-popup",

    properties: {
      clustering: { type: Object, value: function value() {}, observer: 'clusters_changed' }
    },

    created: function created() {
      this._listener = {};
      _.extend(this._listener, Backbone.Events);
    },

    clusters_changed: function clusters_changed(clustering) {

      this._listener.stopListening();
      if (!clustering) return;
    }

  });
});</script></dom-module><dom-module id="padagraph-collection-popup" assetpath="./"><style>.card { width:360px !important}
     </style><template><template is="dom-if" if="{{ graph }}"> <div class="ui card"><padagraph-collection app="{{app}}" mode="node" graph="{{graph}}"></padagraph-collection></div></template></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-collection-popup",

    properties: {
      app: Object,
      graph: Object
    },

    created: function created() {
      this._listener = {};
      _.extend(this._listener, Backbone.Events);
    }

  });
});</script></dom-module><dom-module id="padagraph-model-popup" assetpath="./"><style>:host([hidden]) {
   display: none !important;
 }   
.ui.card {
   width: 360px !important;
   margin: 4px 0px 4px 0px !important;
   height: calc(100% - 15px);
}
.card .intersected {
   margin: 6px 0px 0px 4px;
   padding-bottom: 16px;
}
a.more { padding-right:12px; margin-top: -12px; }

span.name {
       display: inline-block;
       color: #333;
       font-weight: bold;
       font-size: 1em;
       margin-right: 6px;
   }

.sub.header {
   padding-top: 7px;
   padding-left: 40px;
   margin-bottom: -5px;
}
</style><template><template is="dom-if" if="{{ model }}"> <div class="ui card"><template is="dom-if" if="{{ is_edge }}"><div class="item"><padagraph-edge-card-xl model="{{model}}"></padagraph-edge-card-xl></div></template><template is="dom-if" if="{{ is_vertex }}"> <div class="intersected"><padagraph-vertex-card-m model="{{model}}"></padagraph-vertex-card-m><div class="sub header"><a href="#expand" on-click="expand" class="ui small basic label">+10 </a><a href="#explore" on-click="explore" class="ui small basic label">explore </a><a href="{{ geturl(model) }}/neighbors" target="_blank" class="ui small basic label">neighbors</a><a href="{{ geturl(model) }}" target="_blank" title="{{ model.id }}" class="ui small basic label">{{ shortuuid(model) }}</a></div></div><div style="overflow: auto; height: calc(100% - 128px ); overflow-x: hidden" class="content"><template is="dom-if" if="{{image}}"> <img src="{{image}}" class="ui small centered image"><div class="ui divider"></div></template><template is="dom-repeat" items="[[props]]"> <div class="comment"><div class="content"><span class="name">{{item.name}}</span><padagraph-card-property prop="{{item}}" class="value"></padagraph-card-property></div></div></template><padagraph-vtx-neighbors graph="{{graph}}" model="{{model}}"></padagraph-vtx-neighbors></div></template></div></template></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-model-popup",

    properties: {
      graph: { type: Object, value: function value() {}, observer: 'graph_changed' },
      model: { type: Object, observer: "modelChanged" },
      is_vertex: { type: Boolean, computed: 'isVertex(model)' },
      is_edge: { type: Boolean, computed: 'isEdge(model)' }
    },

    created: function created() {
      this._listener = {};
      _.extend(this._listener, Backbone.Events);
    },

    geturl: function geturl() {
      return this.model ? this.model.url() : "";
    },

    graph_changed: function graph_changed(graph) {
      var _this = this;

      this._listener.stopListening();
      if (!graph || !_.size(graph)) return;

      this._listener.listenTo(this.graph.vs, 'remove', (function (model) {
        if (_this.model == model) _this.model = null;
      }).bind(this));
      this._listener.listenTo(this.graph.es, 'remove', (function (model) {
        if (_this.model == model) _this.model = null;
      }).bind(this));
      this._listener.listenTo(this.graph.vs, 'addflag:selected', (function (model) {
        _this.model = model;
      }).bind(this));
      this._listener.listenTo(this.graph.vs, 'rmflag:selected', (function (model) {
        _this.model = null;
      }).bind(this));
      this._listener.listenTo(this.graph.es, 'addflag:selected', (function (model) {
        _this.model = model;
      }).bind(this));
      this._listener.listenTo(this.graph.es, 'rmflag:selected', (function (model) {
        _this.model = null;
      }).bind(this));
    },

    isEdge: function isEdge(model) {
      return model && model.get('edgetype') != null;
    },
    isVertex: function isVertex(model) {
      return model && model.get('nodetype') != null;
    },
    isGraph: function isGraph(model) {
      return model && model.nodetypes && model.edgetypes;
    },

    modelChanged: function modelChanged(model) {

      this.hidden = model == null;
      if (!model) return;

      this.image = model.properties.get('image');
      var exclude = { 'label': true, 'image': true };
      var _type = function _type(key) {
        if (model.type && model.type.properties) {
          var t = model.type.properties.get(key);
          if (t && t.otype) return t.otype.type.toLowerCase();
        }
        return "text";
      };
      this.props = Object.keys(model.properties.attributes).filter(function (e) {
        return !exclude[e];
      }).map(function (e) {
        return {
          "type": _type(e),
          "name": e,
          "value": model.properties.get(e)
        };
      });
    },

    rmflag: function rmflag(model) {
      this.model = null;
    },

    expand: function expand() {
      var graph = this.model.graph;
      var params = { graph: graph.id, expand: [this.model.id], weights: [] };
      Backbone.trigger('engine:expand_prox', params);
    },

    explore: function explore() {
      var graph = this.model.graph;
      var params = { graph: graph.id, query: this.model.id };
      Backbone.trigger('engine:explore', params);
    },

    shortuuid: function shortuuid(model) {
      var uuid = null;
      if (model) {
        uuid = "" + model.id;
        if (uuid.length > 6) return uuid.substring(0, 6) + '...' + uuid.substring(uuid.length - 4);
      }
      return uuid;
    }

  });
});</script></dom-module><dom-module id="padagraph-mouse-popup" assetpath="./"><style>#pdg-mouse-popup {
   max-width: 600px;
   position: fixed;
   padding: 0 2 4 4px;
   margin-left: 12px;
   max-height: calc(100% - 24px);
}
.meta {
   margin: 2 2 8 8px;
 }
.intersected.ui.popup {
   max-width: 520px;
   position: relative;
   padding: 0.42em;
}
.intersected h4 {
   margin: 2 2 8 8px;
}
   </style><template><div id="pdg-mouse-popup" hidden$="{{!is_visible}}"><div class="intersected ui popup visible"><template is="dom-if" if="{{ edge }}"> <h4><i class="ellipsis horizontal icon"> </i>{{edge.type.label}}</h4><padagraph-vertex-card-xs id="source" model="[[edge_source]]"></padagraph-vertex-card-xs><a on-click="select" class="edge"><i class="ellipsis horizontal icon"></i></a><padagraph-vertex-card-xs id="target" model="[[edge_target]]"> </padagraph-vertex-card-xs><div class="meta"> {{edge.label}}</div></template><template is="dom-if" if="{{ vertex }}"> <h4><i class="square outline icon"></i>{{vertex.nodetype.name}}</h4><padagraph-vertex-card-xs model="[[vertex]]"></padagraph-vertex-card-xs></template></div></div></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
  Polymer({
    is: "padagraph-mouse-popup",

    properties: {
      graph: { type: Object, observer: 'graph_changed' },
      edge: { type: Object, value: null, observer: 'computed(edge)' },
      edge_source: {
        type: Object,
        computed: 'get_source_model(edge)'
      },
      edge_target: {
        type: Object,
        computed: 'get_target_model(edge)'
      },
      vertex: { type: Object, value: null },
      is_visible: {
        type: Boolean,
        computed: 'shouldShow(vertex, edge)'
      }
    },

    created: function created() {
      this._listener = {};
      _.extend(this._listener, Backbone.Events);
    },

    graph_changed: function graph_changed() {
      this._listener.stopListening();

      this._listener.listenTo(Backbone, 'edge:mouseover', (function (edge, event) {
        if (edge && edge.id) {
          this.edge = edge;
          this.vertex = null;
          this.setPopupPosition(event);
        }
      }).bind(this));

      this._listener.listenTo(Backbone, 'edge:mouseout', (function (edge, event) {
        this.edge = null;
        this.vertex = null;
      }).bind(this));

      this._listener.listenTo(Backbone, 'vertex:mouseover', (function (vertex, event) {
        if (vertex && vertex.id) {
          if (this.edge == null) {
            if (this.vertex != vertex) this.setPopupPosition(event);
            this.vertex = vertex;
          }
        }
      }).bind(this));

      this._listener.listenTo(Backbone, 'vertex:mouseout', (function (vertex, event) {
        this.edge = null;
        this.vertex = null;
      }).bind(this));
    },

    shouldShow: function shouldShow(vertex, edge) {
      return this.edge != null || this.vertex != null;
    },

    select: function select() {
      Backbone.trigger(Const.select_edge, this.edge);
    },

    get_source_model: function get_source_model(model) {
      if (model) return model.source;
    },
    get_target_model: function get_target_model(model) {
      if (model) return model.target;
    },

    setPopupPosition: function setPopupPosition(event) {
      var nav = navigator.userAgent.toLowerCase();
      var $el = $('#pdg-mouse-popup');
      var $parent = $el.parent();

      var browser = {
        webkit: nav.indexOf("webkit") > 0,
        mozilla: nav.indexOf("firefox") > 0
      };

      var height = $el.height();
      var top = $(this).parent().position().top,
          left = 0;

      if (browser.webkit) {
        //top  = event.pageY - top,
        //left = event.pageX - left;
        top = event.y;
        left = event.x;
      } else {
        top = event.pageY - top - $('body').scrollTop();
        //left = event.pageX  - left - $('body').scrollLeft();
        left = event.clientX;
      }

      $el.css({ 'top': top - 12,
        'left': left });
    },

    computed: function computed(obj) {

      if (!obj) return;

      var exclude = { 'label': true, 'image': true };

      var _type = function _type(key) {
        if (model.type && model.type.properties) {
          var t = model.type.properties.get(key);
          if (t && t.otype) return t.otype.type.toLowerCase();
        }
        return "text";
      };
      this.props = Object.keys(obj.properties.attributes).filter(function (e) {
        return !exclude[e];
      }).map(function (e) {
        return {
          "type": _type(e),
          "name": e,
          "value": obj.properties.get(e)
        };
      });
    }

  });
});</script></dom-module><dom-module id="padagraph-gviz-json" assetpath="./"><template><content></content></template><script>'use strict';

require(['backbone', 'jquery', 'semantic', 'cello', 'gviz', 'materials', 'pdgconst', 'embed'], function (Backbone, $, S, Cello, Gviz, Materials, Const, App) {
  Polymer({
    is: "padagraph-gviz-json",

    properties: {

      config: { type: Object, value: function value() {
          return null;
        } },

      routes: Object,
      data: { type: Object, value: null },
      sync: { type: String, value: null }, // url
      app: { type: Object, value: function value() {
          return null;
        } },

      on_complete: Object,

      /* privates */
      completed: Boolean,
      graph: Object
    },

    observers: ["configure(config)", "parse(routes, data, sync)", "onComplete(on_complete)"],
    //observers:["parse(pdgroot)"],

    onComplete: function onComplete(complete) {
      if (this.completed && complete) complete();
    },

    configure: function configure(config) {
      if (_.isString(config)) {
        // external configuration
        $.ajax({
          url: config,
          success: this.configure
        });
        return;
      }
      if (_.isObject(config)) {
        this.routes = config.routes;
        this.data = config.data;
        this.sync = config.sync;
      }
    },

    refresh: function refresh() {
      this.parse(this.routes, this.data, this.sync);
    },

    parse: function parse(routes, data, sync) {

      var parse = this;
      this.completed = false;

      var isurl = function isurl(e) {
        return _.isString(e);
      };

      if (isurl(routes)) {
        $.ajax({
          url: routes,
          success: function success(routes) {
            parse.set('routes', routes.routes);
          }
        });
        return;
      }

      if (isurl(data)) {
        $.ajax({
          url: data,
          success: function success(r) {
            parse.set('data', r);
          }
        });
        return;
      }

      if (!routes || !data) return;

      // app, models & engines
      var app;
      var app_params = {
        $el: $(this),
        'routes': routes
      };

      app = new App.Iframe(app_params);
      app.create_clustering_model();
      this.app = app;

      if (sync) {
        var gid = sync.substring(sync.lastIndexOf('/') + 1);
        var urlRoot = sync.substring(0, sync.lastIndexOf('/') + 1);
        app.create_graph_model({ urlRoot: urlRoot, url: sync });
        app.models.graph.set('gid', gid);
        app.create_query_model();
        app.models.query.graph = app.models.graph.id;
      } else {
        app.create_graph_model({});
        app.models.graph.attributes['gid'] = "g" + this.id;
      }

      var complete = function complete(app) {

        var graph = app.models.graph;
        var viz = $("padagraph-gviz", parse)[0];
        viz.graph = graph;
        viz.app = app;
        viz.options = Gviz.DEFAULTS;

        app.gviz = viz.gviz;
        app.set_auto_compute(false);

        var reset = function reset() {
          graph.reset(data, { silent: true });

          graph.vs.each(function (vtx) {
            vtx.add_flag("form");
          });

          app.set_auto_compute(true);
          app.auto_compute();
        };

        if (sync) {
          graph.on('sync', reset);
          graph.fetch({ parse: true });
        } else reset();

        parse.completed = true;
        parse.onComplete();
        parse.fire('engines-complete', { app: app, engines: app.engines });
      };

      app.create_engines();
      app.fetch_engines(complete);

      this.graph = app.models.graph;
      this.app = app;

      var _window_resized = function _window_resized() {
        if (app.gviz) app.gviz.resize_rendering();
      };

      $(window).on('resize', _window_resized);
    }
  });
});</script></dom-module><dom-module id="padagraph-gviz" assetpath="./"><template><div id="gviz_model_imgs" style="display:none"></div><canvas id="gviz_imgs_cache_canvas" style="display:none"></canvas><content> </content></template><script>'use strict';

require(['backbone', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, Cello, Gviz, Materials, Const) {
    Polymer({
        is: "padagraph-gviz",

        properties: {

            app: { type: Object, value: function value() {} },
            graph: { type: Object, value: function value() {} },
            options: { type: Object, value: function value() {} }

        },

        observers: ["create_once(app, graph, options)"],

        attached: function attached() {
            var event = new Event("gviz_ready", { "bubbles": true, "cancelable": false });
            console.log("gviz_ready", event);
            document.dispatchEvent(event);
        },

        init: function init(app, graph, options) {
            this.create_once(app, graph, options);
        },

        create_once: function create_once(app, graph, vizoptions) {

            if (app === undefined || graph === undefined) return;
            if (!app || graph == null || !graph.vs) return;
            if (this.gviz) return;

            _.each($("padagraph-engine-control", this), function (el, i, l) {
                if (el) {
                    var engine = app.engines[el.engine];
                    el.app = app;
                    if (engine.blocks.models.length) el.block = engine.blocks.models[0];
                }
            });

            var filters = $("padagraph-collection-filter", this);
            if (filters.length) {
                _(filters).forEach(function (f) {
                    f.app = app;
                    f.graph = graph;
                });
            }

            //graph.on('reset', ()=>{
            //_(filters).forEach((f) => {
            //f.reset_filters()
            //});
            //});

            var search = $("padagraph-node-search");
            if (search.length) {
                search = search[0];
                search.graph = graph;
            }

            var popup = $("padagraph-model-popup", this);
            if (popup.length) {
                popup = popup[0];
                popup.graph = graph;
            }

            var ctrl = $("padagraph-labels-control", this);
            if (ctrl.length) {
                ctrl = ctrl[0];
                ctrl.app = app;
                ctrl.graph = graph;
            }

            var options = _.extend({}, Gviz.DEFAULTS, vizoptions);
            if (!options['el']) options['el'] = "#vz_threejs_main" + Math.round(Math.random() * 10000);

            options.materials = Materials;

            var has_el = $(options.el, this).length > 0;
            var div = has_el ? $(options.el, this)[0] : document.createElement('div');
            div.setAttribute('id', options.el.substring(1));
            div.setAttribute('style', "height:100%");
            if (!has_el) this.appendChild(div);

            if (this.debug) {
                this.appendChild("<div class='gviz-debug'></div>");
            }

            this.options.wnode_scale = function (vtx) {
                var v = vtx.get('_size') * 8;
                return gviz.initial_size + gviz.user_vtx_size + v;
            };

            var gviz = Gviz.SimpleViz(graph, options);
            gviz.enable();
            gviz.clustering = app.models.clustering;
            gviz.animate();

            app.set_viz(gviz);

            var ctrl = $("padagraph-gviz-control");
            if (ctrl.length) {
                ctrl = ctrl[0];
                ctrl.app = app;
                ctrl.gviz = gviz;
            }

            this.gviz = gviz;

            var event = new Event("gviz_attached", { "bubbles": true, "cancelable": false });
            document.dispatchEvent(event);
        }

    });
});</script></dom-module><dom-module id="padagraph-collection-filter" assetpath="./"> <style>.menu .form {padding:6px}

.ui.typefilter.checkbox {
    margin-left: 12px;
}
.ui.groupfilter.checkbox {
    margin-top: 12px;
}
</style><template><div on-click="filter_count" class$="{{button_class('ui dropdown', asitem, aslabel)}}" class="ui dropdown"><template is="dom-if" if="{{is_mode_node}}"> <i class="ui circle thin icon"></i></template><template is="dom-if" if="{{is_mode_edge}}"> <i class="ui minus icon"></i></template><span>{{ filtered_count }} </span><div class="ui vertical menu">       <template is="dom-if" if="{{ filter_visible(filters, 'all') }}"> <div on-click="reset_filters" class="link item">All</div></template><template is="dom-if" if="[[ filter_visible(filters,'selected') ]]"> <template is="dom-if" if="[[ selected_node ]]"> <div on-click="set_selected_label" class="item"><padagraph-vertex-card-xs model="[[selected_node]]"></padagraph-vertex-card-xs></div><div class="divider"></div></template></template><template is="dom-if" if="{{ filter_visible(filters,'label') }}"> <template is="dom-if" if="{{ filter_visible(filters,'headers') }}"> <h4 class="ui header">Label</h4></template><div class="ui form"><div style="margin: 0 1em 0.3em 0em;" class="field"><div class="ui small icon input"><i class="search icon"></i><input type="text" placeholder="Label filter" value="{{filter_label::input}}"></div></div><template is="dom-if" if="{{is_mode_node}}"> <div class="field"><div class="ui labelfilter checkbox"><input type="checkbox" on-click="click_filter_label_chk"><label>include neighbors</label></div></div></template></div><div class="divider"></div></template><template is="dom-if" if="{{ filter_visible(filters,'types') }}"> <template is="dom-if" if="{{ filter_visible('headers') }}"><h4 class="ui header">Types</h4></template><div class="ui form groups"><template is="dom-repeat" items="{{filter_groups}}" as="group"><div class="field"><div class="ui groupfilter checkbox"><input id="chkgroup{{group.label}}" on-click="set_group_filter" type="checkbox" checked="checked"><label for$="chkgroup{{group.label}}">{{group.label}} ({{group.count}}) </label></div></div><template is="dom-repeat" items="{{group.items}}" as="item"><div class="field"><div class="ui typefilter checkbox"><input id="type{{item.label}}" on-click="set_type_filter" type="checkbox" checked="checked"><label for$="type{{item.label}}"><padagraph-edge-type model="{{item.model}}"></padagraph-edge-type><div class="ui tiny basic label">{{item.count}}</div></label></div></div></template></template></div><div class="divider"></div></template><template is="dom-if" if="{{ filter_visible(filters,'headers') }}"> <h4 class="ui header">Layout</h4></template><template is="dom-if" if="{{ filter_visible(filters,'layout') }}"> <div class="form"><div class="field"><div on-click="update_layout" class="ui primary compact button">update</div></div></div></template></div></div></template><script>'use strict';

require(['backbone', 'jquery', 'semantic'], function (Backbone, $, S) {

    Polymer({
        is: "padagraph-collection-filter",

        properties: {
            app: Object,
            graph: Object,
            mode: {
                type: String, value: 'node' }, // [edge, node]

            asitem: { type: Boolean, value: false },
            aslabel: { type: Boolean, value: false },

            //- autocompute layout
            autocompute: { type: Boolean, value: false },

            /* privates */
            elements: {
                type: Array, value: function value() {
                    return [];
                } },

            filters: String,

            filter_groups: {
                type: Array, value: null },
            filter_types: {
                type: Array, value: null },
            filter_label: {
                type: String, value: "" },
            filter_label_chk: {
                type: Boolean, value: false },
            filter_reset: {
                type: Boolean, value: false },
            filtered_count: {
                type: String
            },

            groups_sort: Object
        },

        observers: ['setGraphModel(app, graph)', 'apply_filters(elements, filter_groups, filter_label, filter_label_chk, filter_reset)'],

        button_class: function button_class(css, asitem, aslabel) {
            return css + " " + (this.asitem ? "item" : this.aslabel ? "label" : "");
        },

        created: function created() {
            this._listener = {};
            _.extend(this._listener, Backbone.Events);
        },

        setGraphModel: function setGraphModel(app, graph) {

            if (!app || !graph) return;

            $('.dropdown', this).dropdown();
            this.collection = null;
            this.types = null;
            this.is_mode_edge = this.mode == "edge";
            this.is_mode_node = this.mode == "node";

            this.remove_all();

            if (this.is_mode_node) {
                this.collection = this.graph.vs;
                this.types = this.graph.nodetypes;
            } else if (this.is_mode_edge) {
                this.collection = this.graph.es;
                this.types = this.graph.edgetypes;
            }

            this._listener.stopListening();

            this._listener.listenTo(this.collection, 'add', this.push_node.bind(this));
            this._listener.listenTo(this.collection, 'remove', this.pop_node.bind(this));
            this._listener.listenTo(this.collection, 'reset', this.remove_all.bind(this));

            this._listener.listenTo(this.collection, 'addflag:selected', this.add_selected.bind(this));
            this._listener.listenTo(this.collection, 'rmflag:selected', this.rm_selected.bind(this));

            this._listener.listenTo(this.collection, 'filter:changed', this.filter_count.bind(this));
            if (this.is_mode_edge) {
                this._listener.listenTo(this.graph.vs, 'filter:changed', this.filter_count.bind(this));
            }

            //this._listener.listenTo(this.types, 'add', this.reset_filters.bind(this));
            //setTimeout( () => {this.reset_filters()}, 1000 );
        },

        reset_filters: function reset_filters() {

            this.set_type_filters();

            $('.typefilter.checkbox input', this).each(function (e, x) {
                x.checked = true;
            });
            $('.groupfilter.checkbox input', this).each(function (e, x) {
                x.checked = true;
            });
            $('.labelfilter.checkbox input', this).each(function (e, x) {
                x.checked = false;
            });

            _.each(this.filter_groups, function (e, i) {
                e.selected = true;
            });

            _.each(this.filter_types, function (e, i) {
                e.selected = true;
            });

            this.filter_reset = true;
            this.filter_label_chk = false;
            this.filter_label = "";
        },

        filter_visible: function filter_visible(filters, filter) {

            var f = this.filters ? this.filters.split(" ") : [];
            var visible = f.length == 0 || f.indexOf(filter) > -1;
            return visible;
        },

        set_type_filters: function set_type_filters() {
            var types = this.mode == "node" ? this.graph.nodetypes : this.graph.edgetypes;
            var collection = this.mode == "node" ? this.graph.vs : this.graph.es;

            var ls = _.map(types.models, function (e) {
                var filter = function filter(m) {
                    return e.get('uuid') == m.type.get('uuid');
                };
                var count = collection.filter(filter).length;

                var group = e.label.indexOf('/') > 0 ? e.label.substr(0, e.label.indexOf('/')) : "*";
                var name = e.label.substr(e.label.indexOf('/') + 1);

                return { group: group, name: name, label: e.label, selected: true, count: count, model: e };
            });

            var fs = _.filter(ls, function (e) {
                return e.count > 0;
            });

            var groups = _.groupBy(fs, function (e) {
                return e.group;
            });
            groups = _.map(groups, function (v, k) {
                var count = _.reduce(v, function (memo, e) {
                    return memo + e.count;
                }, 0);
                return { label: k, selected: true, items: v, count: count };
            });

            var _v = function _v(e) {
                return e.model.type_attributes ? e.model.type_attributes.order | 0 : 0;
            };
            var groups_sort = function groups_sort(a, b) {
                return _v(a) - _v(b);
            };
            groups.forEach(function (e) {
                e.items.sort(groups_sort);
            });

            this.filter_groups = groups;
        },

        set_group_filter: function set_group_filter(filter) {
            if (filter.model) {
                var group = this;
                filter.model.group.selected = !filter.model.group.selected;
                _.each(filter.model.group.items, function (e) {
                    e.selected = filter.model.group.selected;
                    document.getElementById("type" + e.label).checked = e.selected;
                });

                var array = this.filter_groups;
                this.filter_groups = [];
                this.filter_groups = array;
                this.filter_reset = _.any(filter.model.group.items, function (e) {
                    return !e.selected;
                }) ? false : true;
            } else {
                // match all collection models
                this.reset_filters();
            }
        },

        set_type_filter: function set_type_filter(filter) {
            if (filter && filter.model) {
                var item = filter.model.item;
                item.selected = !item.selected;

                _.each(this.filter_groups, function (e, i) {
                    if (e.label == item.group) {
                        e.selected = true;
                        document.getElementById("chkgroup" + e.label).checked = true;
                    }
                });

                var array = this.filter_groups;
                this.filter_groups = [];
                this.filter_groups = array;
            } else {
                // match all collection models
                this.reset_filters();
            }
        },

        set_selected_label: function set_selected_label() {
            if (this.selected_node) {
                $('.labelfilter.checkbox input', this).each(function (e, x) {
                    x.checked = true;
                });
                $('.groupfilter.checkbox input', this).each(function (e, x) {
                    x.checked = true;
                });
                $('.typefilter.checkbox input', this).each(function (e, x) {
                    x.checked = true;
                });
                this.filter_label_chk = true;
                this.filter_label = this.selected_node.label;
            }
        },

        add_selected: function add_selected(model) {
            this.selected_node = model;
        },

        rm_selected: function rm_selected(model) {
            this.selected_node = null;
        },

        click_filter_label_chk: function click_filter_label_chk() {
            var chk = $('.labelfilter.checkbox input', this)[0];
            this.filter_label_chk = chk.checked;
        },

        update_filtering: function update_filtering() {
            this.apply_filters(this.elements, this.filter_types, this.filter_label, this.filter_label_chk);
        },

        apply_filters: function apply_filters(elements, groups, label, _chk, filter_reset) {
            var _this = this;

            if (!groups || !groups.length) return;

            $(".filter.icon", this).toggleClass('red');
            $(".filter.icon", this).toggleClass('loading');

            _.each(groups, function (g, i) {
                _.each(g.items, function (e, j) {
                    var filter = _this.filtered([{ label: e.label, selected: true }], label);
                    e.count = elements.filter(filter).length;
                    _this.notifyPath('filter_groups.' + i + '.items.' + j + '.count');
                });
                g.count = _.reduce(g.items, function (memo, e) {
                    return memo + e.count;
                }, 0);
                _this.notifyPath('filter_groups.' + i + '.count');
            });

            var graph = this.collection.graph;
            var types = _.flatten(_.map(groups, function (e) {
                return e.items;
            }));
            var filter = this.filtered(types, label);
            var filter_inv = function filter_inv(e) {
                return !filter(e);
            };
            var disabled = this.collection.models.filter(filter_inv);

            if (this.is_mode_node) {

                var vs = this.collection;
                vs.add_flag("disabled", disabled, true);
                vs.trigger('filter:changed');

                var es = this.collection.graph.es;
                var filter_edge = function filter_edge(e) {
                    return e.source.has_flag('disabled') || e.target.has_flag('disabled');
                };

                es.add_flag("disabled-by-nodes", es.models.filter(filter_edge), true, { silent: true });

                disabled = _.union(es.by_flag("disabled-by-edges"), es.by_flag("disabled-by-nodes"));

                es.add_flag("disabled", disabled, true);
                es.trigger("filter:changed");
            } else if (this.is_mode_edge) {

                var es = this.collection;
                es.add_flag("disabled-by-edges", disabled, true, { silent: true });
                var by_nodes = es.by_flag("disabled-by-nodes");

                disabled = _.union(disabled, by_nodes);
                graph.es.add_flag("disabled", disabled, true);
                graph.es.trigger("filter:changed");

                var vs = graph.vs.map(function (v) {
                    var f = function f(e) {
                        return !e.has_flag('disabled');
                    };
                    var edges = graph.incident(v, graph.ALL).filter(f);
                    if (!filter_reset) if (edges.length == 0) return v;
                    return null;
                }).filter(function (v) {
                    return v != null;
                });

                var disabled_by_edges = graph.vs.by_flag("disabled_by_edges");
                disabled = graph.vs.by_flag("disabled");
                disabled = _.chain(disabled).difference(disabled_by_edges).union(vs).value();
                graph.vs.add_flag("disabled_by_edges", vs, true);
                graph.vs.add_flag("disabled", disabled, true);
            }
            $(".filter.icon", this).toggleClass('red');
            $(".filter.icon", this).toggleClass('loading');

            if (this.autocompute) this.update_layout();
        },

        filter_count: function filter_count() {
            var disabled = this.collection.by_flag("disabled");
            this.filtered_count = this.collection.length - disabled.length;
        },

        filtered: function filtered(types, pattern) {
            var mode = this.mode;
            var selected = _.filter(types, function (e) {
                return e.selected;
            });
            var chk_neighbors = this.filter_label_chk;

            return function (item) {

                var matchpattern = true;
                var matchtype = true;

                if (pattern && pattern != "") {
                    var label = item.label.toLowerCase();
                    pattern = pattern.toLowerCase();

                    matchpattern = label.match(pattern);
                    if (mode == "node" && chk_neighbors && !matchpattern && item.neighbors) {
                        var _iteratorNormalCompletion = true;
                        var _didIteratorError = false;
                        var _iteratorError = undefined;

                        try {
                            for (var _iterator = item.neighbors()[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                                var e = _step.value;

                                label = e.label.toLowerCase();
                                matchpattern = label.match(pattern);
                                if (matchpattern) break;
                            }
                        } catch (err) {
                            _didIteratorError = true;
                            _iteratorError = err;
                        } finally {
                            try {
                                if (!_iteratorNormalCompletion && _iterator['return']) {
                                    _iterator['return']();
                                }
                            } finally {
                                if (_didIteratorError) {
                                    throw _iteratorError;
                                }
                            }
                        }
                    }
                }

                matchtype = matchtype & _.filter(selected, function (e) {

                    var label = null;
                    if (mode == "node") label = item.nodetype.label;
                    if (mode == "edge") label = item.edgetype.label;
                    return label == e.label;
                }).length;

                return matchtype && matchpattern;
            };
        },

        update_layout: function update_layout() {
            this.app.trigger('engine:auto_compute');
        },

        push_node: function push_node(el) {

            if (!el) return;
            if (this.mode == "edge" && el.is_loop()) return;

            this.push("elements", el);
        },

        pop_node: function pop_node(el) {
            this.arrayDelete("elements", el);
        },

        remove_all: function remove_all() {
            this.splice("elements", 0, this.elements.length);
        }

    });
});</script></dom-module><dom-module id="padagraph-collection-filter2" assetpath="./"><style>.menu .form {padding:6px}

.ui.typefilter.checkbox {
    margin-left: 12px;
}
.ui.groupfilter.checkbox {
    margin-top: 12px;
}
</style><template><template is="dom-if" if="{{asmenu}}"><div class="ui vertical menu"><template is="dom-if" if="{{ filter_visible('all') }}"> <div on-click="reset_filters" class="link item">All</div></template><template is="dom-if" if="[[ filter_visible('selected') ]]"> <div on-click="set_selected_label" class="item"><padagraph-vertex-card-xs model="[[selected_node]]"></padagraph-vertex-card-xs></div><div class="divider"></div></template><template is="dom-if" if="{{ filter_visible('label') }}"> <template is="dom-if" if="{{ filter_visible('headers') }}"> <h4 class="ui header">Label</h4></template><div class="ui form"><div style="margin: 0 1em 0.3em 0em;" class="field"><div class="ui small icon input"><i class="search icon"></i><input type="text" placeholder="Label filter" value="{{filter_label::input}}"></div></div><template is="dom-if" if="{{is_mode_node}}"> <div class="field"><div class="ui labelfilter checkbox"><input type="checkbox" on-click="click_filter_label_chk"><label>include neighbors</label></div></div></template></div><div class="divider"></div></template><template is="dom-if" if="{{ filter_visible('types') }}"> <template is="dom-if" if="{{ filter_visible('headers') }}"><h4 class="ui header">Types</h4></template><div class="ui form groups"><template is="dom-repeat" items="{{filter_groups}}" as="group"><div class="field"><div class="ui groupfilter checkbox"><input id="chkgroup{{group.label}}" on-click="set_group_filter" type="checkbox" checked="checked"><label for$="chkgroup{{group.label}}">{{group.label}} ({{group.count}}) </label></div></div><template is="dom-repeat" items="{{group.items}}" as="item"><div class="field"><div class="ui typefilter checkbox"><input id="type{{item.label}}" on-click="set_type_filter" type="checkbox" checked="checked"><label for$="type{{item.label}}">{{item.name}} ({{item.count}})</label></div></div></template></template></div><div class="divider"></div></template><template is="dom-if" if="{{ filter_visible('headers') }}"> <h4 class="ui header">Layout</h4></template><template is="dom-if" if="{{ filter_visible('layout') }}"> <div class="form"><div class="field"><div on-click="update_layout" class="ui primary compact button">update</div></div></div></template></div></template><template is="dom-if" if="{{!asmenu}}"> <div on-click="filter_count" class$="{{button_class('ui dropdown', asitem, aslabel)}}" class="ui dropdown"><template is="dom-if" if="{{is_mode_node}}"> <i class="ui circle thin icon"></i></template><template is="dom-if" if="{{is_mode_edge}}"> <i class="ui minus icon"></i></template><span>{{ filtered_count }} </span><div class="menu"><div on-click="reset_filters" class="item">All</div><template is="dom-if" if="{{ selected_node }}"> <div on-click="set_selected_label" class="item"><padagraph-vertex-card-xs model="[[selected_node]]"></padagraph-vertex-card-xs></div></template><div class="divider"></div><h4 class="ui header">Label</h4><div class="ui form"><div style="margin: 0 1em 0.3em 0em;" class="field"><div class="ui small icon input"><i class="search icon"></i><input type="text" placeholder="Label filter" value="{{filter_label::input}}"></div></div><template is="dom-if" if="{{is_mode_node}}"> <div class="field"><div class="ui labelfilter checkbox"><input type="checkbox" on-click="click_filter_label_chk"><label>include neighbors</label></div></div></template></div><div class="divider"></div><h4 class="ui header">Types</h4><div class="ui form groups"><template is="dom-repeat" items="{{filter_groups}}" as="group"><div class="field"><div class="ui groupfilter checkbox"><input id="chkgroup{{group.label}}" on-click="set_group_filter" type="checkbox" checked="checked"><label for$="chkgroup{{group.label}}"><span class="name">{{group.label}}</span><span class="count">({{group.count}})</span></label></div></div><template is="dom-repeat" items="{{group.items}}" as="item"><div class="field"><div class="ui typefilter checkbox"><input id="type{{item.label}}" on-click="set_type_filter" type="checkbox" checked="checked"><label for$="type{{item.label}}"><span class="name">{{item.name}}</span><span class="count">({{item.count}})</span></label></div></div></template></template></div><div class="divider"></div><h4 class="ui header">Layout</h4><div class="form"><div class="field"><div on-click="update_layout" class="ui primary compact button">update</div></div></div></div></div></template></template><script>'use strict';

require(['backbone', 'jquery', 'semantic'], function (Backbone, $, S) {

    Polymer({
        is: "padagraph-collection-filter2",

        properties: {
            app: Object,
            graph: Object,
            mode: {
                type: String, value: 'node' }, // [edge, node]

            asitem: { type: Boolean, value: false },
            aslabel: { type: Boolean, value: false },
            asmenu: { type: Boolean, value: false },

            //- autocompute layout
            autocompute: { type: Boolean, value: false },

            /* privates */
            elements: {
                type: Array, value: function value() {
                    return [];
                } },

            filters: String,

            filter_groups: {
                type: Array, value: null },
            filter_types: {
                type: Array, value: null },
            filter_label: {
                type: String, value: "" },
            filter_label_chk: {
                type: Boolean, value: false },
            filtered_count: {
                type: String
            },

            groups_sort: Object
        },

        observers: ['setGraphModel(app, graph)', 'apply_filters(elements, filter_groups, filter_label, filter_label_chk)'],

        button_class: function button_class(css, asitem, aslabel) {
            return css + " " + (this.asitem ? "item" : this.aslabel ? "label" : "");
        },

        created: function created() {
            this._listener = {};
            _.extend(this._listener, Backbone.Events);
        },

        setGraphModel: function setGraphModel(app, graph) {
            var _this = this;
            if (!app || !graph) return;

            $('.dropdown', this).dropdown();
            this.collection = null;
            this.types = null;
            this.is_mode_edge = this.mode == "edge";
            this.is_mode_node = this.mode == "node";

            this.remove_all();

            if (this.is_mode_node) {
                this.collection = this.graph.vs;
                this.types = this.graph.nodetypes;
            } else if (this.is_mode_edge) {
                this.collection = this.graph.es;
                this.types = this.graph.edgetypes;
            }

            this._listener.stopListening();

            this._listener.listenTo(this.collection, 'add', this.push_node.bind(this));
            this._listener.listenTo(this.collection, 'remove', this.pop_node.bind(this));
            this._listener.listenTo(this.collection, 'reset', this.remove_all.bind(this));

            this._listener.listenTo(this.collection, 'addflag:selected', this.add_selected.bind(this));
            this._listener.listenTo(this.collection, 'rmflag:selected', this.rm_selected.bind(this));

            this._listener.listenTo(this.collection.graph, 'merge', this.update_filtering.bind(this));
            this._listener.listenTo(this.collection.graph, 'reset', function () {
                _this.reset_filters();
                _this.filter_count();
            });

            this._listener.listenTo(this.collection, 'filter:changed', this.filter_count.bind(this));
            if (this.is_mode_edge) {
                this._listener.listenTo(this.graph.vs, 'filter:changed', this.filter_count.bind(this));
            }

            //this._listener.listenTo(this.types, 'add', this.reset_filters.bind(this));
            //setTimeout( () => {this.reset_filters()}, 1000 );
        },

        reset_filters: function reset_filters() {

            this.set_type_filters();

            $('.typefilter.checkbox input', this).each(function (e, x) {
                x.checked = true;
            });
            $('.groupfilter.checkbox input', this).each(function (e, x) {
                x.checked = true;
            });
            $('.labelfilter.checkbox input', this).each(function (e, x) {
                x.checked = false;
            });

            _.each(this.filter_groups, function (e, i) {
                e.selected = true;
            });

            _.each(this.filter_types, function (e, i) {
                e.selected = true;
            });

            this.filter_label_chk = false;
            this.filter_label = "";
        },

        filter_visible: function filter_visible(filter) {

            var f = this.filters.split(" ");
            var visible = f.length == 0 || f.indexOf(filter) > -1;
            return visible;
        },

        set_type_filters: function set_type_filters(old) {
            var selected = {};

            if (old && old.length) {
                selected = _.chain(old.map(function (e, i) {
                    var items = e.items.map(function (ee, j) {
                        return [ee.group + ee.name, ee.selected];
                    });
                    return items;
                })).flatten(true).union(old.map(function (e, i) {
                    return [e.label, e.selected];
                })).object().value();
            }

            var types = this.mode == "node" ? this.graph.nodetypes : this.graph.edgetypes;
            var collection = this.mode == "node" ? this.graph.vs : this.graph.es;

            var ls = _.map(types.models, function (e) {

                var filter = function filter(m) {
                    return e.get('uuid') == m.type.get('uuid');
                };
                var count = collection.filter(filter).length;
                var group = e.label.indexOf('/') > 0 ? e.label.substr(0, e.label.indexOf('/')) : "*";
                var name = e.label.substr(e.label.indexOf('/') + 1);

                return { 'group': group,
                    'name': name,
                    'label': e.label,
                    'selected': old ? group + name in selected ? selected[group + name] : true : true,
                    'count': count, model: e };
            });

            var fs = _.filter(ls, function (e) {
                return e.count > 0;
            });

            var groups = _.groupBy(fs, function (e) {
                return e.group;
            });
            groups = _.map(groups, function (v, k) {
                var count = _.reduce(v, function (memo, e) {
                    return memo + e.count;
                }, 0);
                return { 'label': k,
                    'selected': old ? k in selected ? selected[k] : true : true,
                    'items': v,
                    'count': count };
            });
            if (this.groups_sort) groups.sort(this.groups_sort);

            this.filter_groups = groups;
        },

        set_group_filter: function set_group_filter(filter) {
            if (filter.model) {
                var group = this;
                filter.model.group.selected = !filter.model.group.selected;
                _.each(filter.model.group.items, function (e) {
                    e.selected = filter.model.group.selected;
                    document.getElementById("type" + e.label).checked = e.selected;
                });

                var array = this.filter_groups;
                this.filter_groups = [];
                this.filter_groups = array;
            } else {
                // match all collection models
                this.reset_filters();
            }
        },

        set_type_filter: function set_type_filter(filter) {
            if (filter && filter.model) {
                var item = filter.model.item;
                item.selected = !item.selected;

                _.each(this.filter_groups, function (e, i) {
                    if (e.label == item.group) {
                        e.selected = true;
                        document.getElementById("chkgroup" + e.label).checked = true;
                    }
                });

                var array = this.filter_groups;
                this.filter_groups = [];
                this.filter_groups = array;
            } else {
                // match all collection models
                this.reset_filters();
            }
        },

        set_selected_label: function set_selected_label() {
            if (this.selected_node) {
                $('.labelfilter.checkbox input', this).each(function (e, x) {
                    x.checked = true;
                });
                $('.groupfilter.checkbox input', this).each(function (e, x) {
                    x.checked = true;
                });
                $('.typefilter.checkbox input', this).each(function (e, x) {
                    x.checked = true;
                });
                this.filter_label_chk = true;
                this.filter_label = this.selected_node.label;
            }
        },

        add_selected: function add_selected(model) {
            this.selected_node = model;
        },

        rm_selected: function rm_selected(model) {
            this.selected_node = null;
        },

        click_filter_label_chk: function click_filter_label_chk() {
            var chk = $('.labelfilter.checkbox input', this)[0];
            this.filter_label_chk = chk.checked;
        },

        update_filtering: function update_filtering() {
            this.set_type_filters(this.filter_groups);
            this.apply_filters(this.elements, this.filter_types, this.filter_label, this.filter_label_chk);
            this.filter_count();
        },

        apply_filters: function apply_filters(elements, groups, label, _chk) {
            var _this2 = this;

            if (!groups || !groups.length) return;

            $(".filter.icon", this).toggleClass('red');
            $(".filter.icon", this).toggleClass('loading');

            _.each(groups, function (g, i) {
                _.each(g.items, function (e, j) {
                    var filter = _this2.filtered([{ label: e.label, selected: true }], label);
                    e.count = elements.filter(filter).length;
                    //this.notifyPath('filter_types.'+i+'.count' )
                    _this2.notifyPath('filter_groups.' + i + '.items.' + j + '.count');
                });
                g.count = _.reduce(g.items, function (memo, e) {
                    return memo + e.count;
                }, 0);
                _this2.notifyPath('filter_groups.' + i + '.count');
            });

            var types = _.flatten(_.map(groups, function (e) {
                return e.items;
            }));
            var filter = this.filtered(types, label);
            var filter_inv = function filter_inv(e) {
                return !filter(e);
            };
            var disabled = this.collection.models.filter(filter_inv);

            if (this.is_mode_node) {

                var vs = this.collection;
                vs.add_flag("disabled", disabled, true);
                vs.trigger('filter:changed');

                var es = this.collection.graph.es;
                var filter_edge = function filter_edge(e) {
                    return e.source.has_flag('disabled') || e.target.has_flag('disabled');
                };
                var disabled_edges = es.models.filter(filter_edge);
                es.add_flag("disabled-by-nodes", disabled_edges, true, { silent: true });

                var disabled_edges = _.union(disabled_edges, es.by_flag("disabled-by-edges"));

                es.add_flag("disabled", disabled_edges, true);
                es.trigger("filter:changed");
            }

            if (this.is_mode_edge) {

                var es = this.collection;
                es.add_flag("disabled-by-edges", disabled, true, { silent: true });
                var by_nodes = es.by_flag("disabled-by-nodes");

                var disabled = _.union(disabled, by_nodes);
                es.add_flag("disabled", disabled, true);
                es.trigger("filter:changed");
            }
            $(".filter.icon", this).toggleClass('red');
            $(".filter.icon", this).toggleClass('loading');

            if (this.autocompute) this.update_layout();
        },

        filter_count: function filter_count() {
            var disabled = this.collection.by_flag("disabled");
            this.filtered_count = this.collection.length - disabled.length;
        },

        filtered: function filtered(types, pattern) {
            var mode = this.mode;
            var selected = _.filter(types, function (e) {
                return e.selected;
            });
            var chk_neighbors = this.filter_label_chk;

            return function (item) {

                var matchpattern = true;
                var matchtype = true;

                if (pattern && pattern != "") {
                    var label = item.label.toLowerCase();
                    pattern = pattern.toLowerCase();

                    matchpattern = label.match(pattern);
                    if (mode == "node" && chk_neighbors && !matchpattern && item.neighbors) {
                        var _iteratorNormalCompletion = true;
                        var _didIteratorError = false;
                        var _iteratorError = undefined;

                        try {
                            for (var _iterator = item.neighbors()[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
                                var e = _step.value;

                                label = e.label.toLowerCase();
                                matchpattern = label.match(pattern);
                                if (matchpattern) break;
                            }
                        } catch (err) {
                            _didIteratorError = true;
                            _iteratorError = err;
                        } finally {
                            try {
                                if (!_iteratorNormalCompletion && _iterator['return']) {
                                    _iterator['return']();
                                }
                            } finally {
                                if (_didIteratorError) {
                                    throw _iteratorError;
                                }
                            }
                        }
                    }
                }

                matchtype = matchtype & _.filter(selected, function (e) {

                    var label = null;
                    if (mode == "node") label = item.nodetype.label;
                    if (mode == "edge") label = item.edgetype.label;
                    return label == e.label;
                }).length;

                return matchtype && matchpattern;
            };
        },

        update_layout: function update_layout() {
            this.app.trigger('engine:auto_compute');
        },

        push_node: function push_node(el) {

            if (!el) return;
            if (this.mode == "edge" && el.is_loop()) return;

            this.push("elements", el);
        },

        pop_node: function pop_node(el) {
            this.arrayDelete("elements", el);
        },

        remove_all: function remove_all() {
            this.splice("elements", 0, this.elements.length);
        }

    });
});</script></dom-module><dom-module id="padagraph-collection" assetpath="./"><template><style>.ui.card { width:100% }
.menu .form {
    padding-left: 12px;
    padding-top: 6px;
}

.dropdown.item .menu {
    left:-50px !important;
}</style><div class="ui card"><div style="margin:6px; margin-bottom: -1rem;" class="ui secondary menu"><padagraph-collection-filter app="{{app}}" graph="{{graph}}" mode="{{mode}}" asitem="asitem" filters="label types" class="item"></padagraph-collection-filter><div class="hidden divider"></div><div class="ui right dropdown item"><i class="sort icon"></i>{{orderBy}}<div class="menu"><template is="dom-repeat" items="[[sorters]]"><div on-click="set_sort" class="item">{{item}}</div></template></div></div></div><div class="ui divider"></div><div id="contentpan" style="max-height: calc(100% - 22px); margin-top:0px; overflow-x: hidden;" class="ui scrollable"><template is="dom-if" if="{{is_mode_node}}"> <template is="dom-repeat" items="[[elements]]" sort="{{sorted(orderBy, reverse)}}" filter="{{filtered(needs_update)}}"><padagraph-vertex-card-m model="{{item}}" intersects="intersects" actions="actions"></padagraph-vertex-card-m><div class="ui divider"></div></template></template><template is="dom-if" if="{{is_mode_edge}}"><template is="dom-repeat" items="[[elements]]" sort="{{sorted(orderBy, reverse)}}" filter="{{filtered(elements, needs_update)}}"><padagraph-edge-card-xs model="{{item}}" class="ui item comments"></padagraph-edge-card-xs><div class="ui divider"></div></template></template></div></div></template><script>'use strict';

require(['backbone', 'jquery', 'semantic'], function (Backbone, $, semantic) {

    var sort = function sort(collection, keyf, reverse) {

        var models = collection.models.slice();
        if (keyf) nodes = _.sortBy(models, keyf);
        if (reverse) models.reverse();

        return nodes;
    };

    Polymer({
        is: "padagraph-collection",

        properties: {

            app: { type: Object },
            graph: { type: Object },

            mode: {
                type: String, value: 'node' },

            elements: {
                type: Array, value: function value() {
                    return [];
                } },

            needs_update: { type: Boolean, value: false },

            sorters: {
                type: Array, value: ['labels', 'types', 'clusters', 'degree'] },
            orderBy: {
                type: String, value: 'sort' },
            reverse: {
                type: Boolean, value: false }

        },
        observers: ["setGraphModel(app, graph)"],

        ready: function ready() {
            this._listener = {};
            _.extend(this._listener, Backbone.Events);
        },

        attached: function attached() {},

        setGraphModel: function setGraphModel(app, graph) {
            var _this = this;

            this.is_mode_edge = this.mode == "edge";
            this.is_mode_node = this.mode == "node";

            this.remove_all();

            this.collection = null;
            this.types = null;

            if (!graph || !app) return;

            if (this.is_mode_node) {
                this.sorters = ['labels', 'types', 'clusters', 'degree'];
                this.collection = this.graph.vs;
                this.types = this.graph.nodetypes;
            } else if (this.is_mode_edge) {
                this.sorters = ['labels', 'types', 'source', 'target'];
                this.collection = this.graph.es;
                this.types = this.graph.edgetypes;
            }

            this._listener.stopListening();

            this._listener.listenTo(this.collection, 'add', this.push_node.bind(this));
            this._listener.listenTo(this.collection, 'remove', this.pop_node.bind(this));
            this._listener.listenTo(this.collection, 'reset', this.remove_all.bind(this));

            this._listener.listenTo(this.collection, 'filter:changed', this.need_update.bind(this));

            this.async(function () {
                $('.dropdown.item', _this).dropdown();
            });
        },

        need_update: function need_update() {
            this.needs_update = !this.needs_update;
        },

        filtered: function filtered(arg) {
            return function (item) {
                return !item.has_flag('disabled');
            };
        },

        set_sort: function set_sort(sorter) {

            if (sorter.model) {
                var f = sorter.model.item;
                this.reverse = !this.reverse && this.orderBy == f;
                this.orderBy = f;
            }
        },

        sorted: function sorted(orderBy, reverse) {
            var _this2 = this;

            var getkey = function getkey(e) {
                return 1;
            };

            if (orderBy == "labels") getkey = function (e) {
                return e.label;
            };else if (orderBy == "types") getkey = function (e) {

                return _this2.mode == "node" ? e.nodetype.label + "/" + e.label : e.edgetype.label + "/" + e.label;
            };else if (orderBy == "clusters") getkey = function (e) {
                return e.get('_sort_by_cluster');
            };else if (orderBy == "degree") getkey = function (e) {
                return e.degree();
            };else if (orderBy == "source") getkey = function (e) {
                return e.source.label;
            };else if (orderBy == "target") getkey = function (e) {
                return e.target.label;
            };

            return function (a, b) {
                var r = getkey(a) > getkey(b) ? 1 : -1;
                if (reverse) return -1. * r;
                return r;
            };
        },

        push_node: function push_node(el) {

            if (!el) return;
            if (this.mode == "edge" && el.is_loop()) return;

            this.push("elements", el);
        },

        pop_node: function pop_node(el) {
            this.arrayDelete("elements", el);
        },

        remove_all: function remove_all() {
            this.splice("elements", 0, this.elements.length);
        }
    });
});</script></dom-module><dom-module id="padagraph-gviz-control" assetpath="./"><style>a.link.icon { padding: 4px; }
a i.icon { margin: 0px; }</style><template><div class="ui segment"><h2 class="header">Visualisation</h2><div class="ui small form"><fieldset><div class="field"><a id="vtx_size_inc" class="link icon"><i class="large zoom icon"></i></a><a id="vtx_size_dec" class="link icon"><i class="large zoom out icon"></i></a><a id="font_size_inc" class="link icon"><i class="large fitted font icon"></i><i class="small fitted add icon"></i></a><a id="font_size_dec" class="link icon"><i class="large fitted font icon"></i><i class="small fitted minus icon"></i></a></div></fieldset></div></div></template><script>"use strict";

require(['jquery'], function ($) {
  Polymer({
    is: "padagraph-gviz-control",

    properties: {
      // engine for parameters ?  
      app: Object,
      gviz: Object
    },

    observers: ["setupUI(app, gviz)"],

    setupUI: function setupUI(app, gviz) {
      if (!app || !gviz) return;
      $("#vtx_size_inc").click(function () {
        gviz.increase_vertex_size();
      });
      $("#vtx_size_dec").click(function () {
        gviz.decrease_vertex_size();
      });

      $("#font_size_inc").click(function () {
        gviz.increase_font_size();
      });
      $("#font_size_dec").click(function () {
        gviz.decrease_font_size();
      });
    }
  });
});</script></dom-module><dom-module id="padagraph-labels-control" assetpath="./"><template><style>.ui.tab {
    height : 400px;
    width : 600px;
    overflow: auto;
    } 
fieldset {
    background-color: #eee; }
fieldset .segment{
    margin-left: -16px;
    margin-bottom: 20px;}
  
#labelsAndButtons {
      margin-top: 6px;
}
  </style><template is="dom-if" if="{{props}}"><template is="dom-if" if="{{show}}"><div class="ui segment"><fieldset><div class="ui secondary pointing menu"><div data-tab="tab-desc" class="active item">Description</div><div data-tab="tab-schema" class="item">Schema</div><div data-tab="tab-pedigree" class="item">Pedigree</div><div on-tap="desc" class="right floated item"><i class="close icon"></i></div></div><div data-tab="tab-desc" class="ui active tab"><div class="markdown"><a name="desc">       </a><p>{{props.description}}</p></div></div><div data-tab="tab-schema" class="ui tab"><a name="schema">       </a><div class="markdown"><div class="ui basic label">{{props.name}}</div><div class="ui label"> <i class="circle thin icon"></i>{{meta.node_count}}</div><div class="ui label"> <i class="minus icon"></i>{{meta.edge_count}}</div><h3>nodetypes</h3><div class="ui list"><template is="dom-repeat" items="[[schema.nodetypes]]"><div class="item"><div class="content"><div class="header">{{item.name}} : {{item.count}}</div><div class="description">{{item.properties}}</div></div></div></template></div><h3>edgetypes</h3><div class="ui list"><template is="dom-repeat" items="[[schema.edgetypes]]"><div class="item"><div class="content"><div class="header">{{item.name}} : {{item.count}}</div><div class="description">{{item.properties}}</div></div></div></template></div></div></div><div data-tab="tab-pedigree" class="ui tab"><div class="ui list"><template is="dom-repeat" items="[[meta.pedigree]]"><div class="item"><div class="content"><a class="header">{{item.0}} : {{item.2}} </a><div class="description">{{item.1}} </div></div></div></template></div></div></fieldset></div></template><div id="labelsAndButtons"><div on-tap="desc" class="ui basic label"> 
{{props.name}}</div><div class="ui label"> <i class="circle thin icon"></i>{{meta.node_count}}</div><div class="ui label"> <i class="minus icon"></i>{{meta.edge_count}}</div><template is="dom-if" if="{{meta.star_count}}"><div class="ui label"> <i class="star thin icon"></i>{{meta.star_count}}</div></template><template is="dom-if" if="{{meta.owner}}"><div class="ui label">  <i class="user icon"></i>{{meta.owner}}</div></template><template is="dom-if" if="{{meta.date}}"><div class="ui label">  <i class="calendar icon"></i>{{meta.date}}</div></template><content></content></div></template></template><script>'use strict';

require(['backbone', 'jquery', 'semantic', 'cello', 'pdgconst'], function (Backbone, $, S, Cello, Const) {
    Polymer({
        is: "padagraph-labels-control",

        properties: {
            // engine for parameters ?  
            app: Object,
            graph: Object,

            meta: { type: Object },
            props: { type: Object },
            schema: { type: Object }
        },

        observers: ["setupUI(app, graph)"],

        setupUI: function setupUI(app, graph) {
            var _this = this;

            if (!app || !graph) return;

            var f = function f() {
                _this.set("meta", graph.meta.attributes);
                for (var k in graph.meta.attributes) _this.notifyPath("meta." + k, _this.meta[k]);

                var stats = graph.meta.get('stats');
                var schema = {
                    vcount: graph.meta.get('node_count'),
                    ecount: graph.meta.get('edge_count'),

                    nodetypes: graph.nodetypes.models.map(function (e) {
                        return {
                            model: e, name: e.name,
                            count: stats && 'nodetypes' in stats ? stats.nodetypes[e.id] | 0 : "-",
                            properties: e.properties.models.map(function (e) {
                                return (e.otype.multi ? "+" : "") + e.name + (e.otype['default'] ? "[" + e.otype['default'] + "]" : "");
                            }).join(', ')
                        };
                    }),

                    edgetypes: graph.edgetypes.models.map(function (e) {
                        return {
                            model: e, name: e.name,
                            count: stats && 'edgetypes' in stats ? stats.edgetypes[e.id] | 0 : "-",
                            properties: e.properties.models.map(function (e) {
                                return e.name;
                            }).join(' - ')
                        };
                    })
                };
                _this.set("schema", schema);

                _this.set("props", graph.properties.attributes);
                for (var k in _this.graph.properties.attributes) _this.notifyPath("props." + k, _this.props[k]);
            };

            for (var event in { 'reset': 1, 'merge': 1 }) graph.on(event, f);
        },

        desc: function desc() {
            var _this2 = this;

            this.show = !this.show;
            this.async(function () {
                $('.secondary.pointing.menu .item', _this2).tab();
            });
        }

    });
});</script></dom-module><dom-module id="padagraph-engine-control" assetpath="./"><style></style><template><div data-content="blocks" class$="{{button_class('blocks ui dropdown', asitem, aslabel)}}" class="blocks ui dropdown"><i class$="{{ icon(engine)}}" title="{{block.name}}"></i><div class="menu"><div class="header">{{block.name}}</div><div class="divider"></div><template is="dom-repeat" items="[[block.components.models]]"><div data-value$="{{item.name}}" class="item">{{item.name}}</div></template></div></div></template><script>'use strict';

require(['backbone', 'jquery', 'semantic', 'cello', 'pdgconst'], function (Backbone, $, S, Cello, Const) {
  Polymer({
    is: "padagraph-engine-control",

    properties: {

      engine: String,
      app: Object,
      block: Object,

      asitem: { type: Boolean, value: false },
      aslabel: { type: Boolean, value: false }

    },

    observers: ["setupUI(app, block)"],

    button_class: function button_class(css, asitem, aslabel) {
      return css + " " + (this.asitem ? "item" : this.aslabel ? "label" : "");
    },

    icon: function icon(engine) {
      var icons = {
        'explore': 'share alternate icon',
        'layout': 'cube icon',
        'clustering': 'block layout icon'
      };
      return icons[engine];
    },

    setupUI: function setupUI(app, block) {
      if (!app || !block) return;
      var engine = this.engine;

      $('.blocks', this).dropdown({
        onChange: function onChange(value, text, $selectedItem) {
          app.trigger('engine:' + engine, value);
        }
      });
    }

  });
});</script></dom-module><dom-module id="padagraph-controls" assetpath="./"><template><style>.vizmenus {
    position: absolute;
    left: calc( 100% - 65px );
    top: 7px;
    z-index: 10;
}
.vizmenus .left.menu {
    margin-right:53px!important
}
#vertex-menu.menu {
    border-left: var(--border-color-left, rgba(0,0,0,0) );
}

</style><div class="vizmenus"><div class="ui icon vertical borderless menu"><a on-click="toggle_fullscreen" data-content="fullscreen" class="item"><template is="dom-if" if="{{!app.fullscreen}}"><i class="expand icon"></i></template><template is="dom-if" if="{{app.fullscreen}}"><i class="compress icon"></i></template></a><div id="themes" data-content="Themes" class="ui right pointing dropdown item"><i class="leaf icon"></i><div class="left menu"><div class="header">Themes</div><div class="divider"></div><template is="dom-repeat" items="[[themes]]"><div data-value$="{{item}}" class="item">{{item}}</div></template></div></div><!--template( is="dom-if", if="{{!track}}")//a.item(on-click='toggle_track', data-content="activate live editing")
    //i.heartbeat.grey.icon--><!--template( is="dom-if", if="{{track}}")//a.item(on-click='toggle_track', data-content="Live editing is active")
    //i.heartbeat.red.icon
    --></div><!-- viz menu layouts , clustering, zoom --><div class="ui icon vertical borderless menu"><padagraph-layout-control app="{{app}}" layouts="{{layouts}}"></padagraph-layout-control><padagraph-clustering-control app="{{app}}" clusterings="{{clusterings}}"></padagraph-clustering-control><!--a.item#nodes//i.large.circle.thin.icon--><!--a.item//i.large.ellipsis.horizontal.icon
--></div><template is="dom-if" if="{{menu_new}}"><div class="ui icon vertical borderless menu"><a on-click="create_node" data-content="New node" class="item"><i class="icons"> <i class="circle thin icon"></i><i class="corner inverted add icon"></i></i></a><a on-click="create_edge" data-content="New link" class="item"><i class="icons"> <i class="minus thin icon"></i><i class="corner inverted add icon"></i></i></a></div></template><!-- viz menu layouts , clustering, zoom--><div id="vertex-menu" class="ui icon vertical borderless menu"><template is="dom-if" if="{{vertex}}"><a on-click="edit_node" data-content="Edit node" class="item"><i class="edit icon"></i></a><a on-click="add_link" data-content="Link" class="item"><i class="linkify icon"></i></a><a on-click="expand" data-content="Expand" class="item"><i class="share alternate icon"></i></a><a on-click="explore" data-content="Explore" class="item"><i class="bullseye icon"></i></a><a on-click="remove_node" data-content="Hide" class="item"><i class="hide icon"></i></a></template><template is="dom-if" if="{{edge}}"><a on-click="edit_edge" data-content="Edit" class="item"><i class="edit icon"></i></a><a on-click="remove_edge" data-content="Hide" class="item"><i class="hide icon"></i></a></template></div></div></template><script>'use strict';

require(['backbone', 'cello', 'pdgconst'], function (Backbone, Cello, Const) {
    Polymer({
        is: "padagraph-controls",

        properties: {
            app: Object,
            themes: Object,

            clusterings: Object,
            layouts: Object,

            graph: Object,
            vertex: {
                type: Object,
                observer: 'updateVertex'
            },
            edge: {
                type: Object,
                observer: 'updateEdge'
            },

            track: Boolean,

            debug: Boolean,
            menu_new: {
                type: Boolean,
                computed: "has_menu_new(vertex,edge)"
            }
        },

        attached: function attached() {
            this.app = null;
            this.layouts = [];
            this.clusterings = [];
            this.graph = null;

            this.vertex = null;
            this.edge = null;

            this.track = this.track === undefined ? false : this.track;
        },

        popup: function popup() {
            var _this2 = this;

            this.async(function () {
                $(".item", Polymer.dom(_this2).node).popup({ position: "left center",
                    variation: "small"
                });
            });
        },

        toggle_fullscreen: function toggle_fullscreen(e, detail) {
            this.fire('toggle-fullscreen', {});
        },

        has_menu_new: function has_menu_new() {

            if (!arguments) return true;

            var _arguments = [];
            for (var i = 0, j = arguments.length; i < j; i++) {
                _arguments.push(arguments[i]);
            }
            return _arguments.filter(function (x) {
                return x != null;
            }).length == 0;
        },

        setupUI: function setupUI() {
            var _this3 = this;

            var _this = this;

            this.popup();

            $(this.$.layouts).dropdown({
                onChange: function onChange(value, text, $selectedItem) {
                    Backbone.trigger('engine:layout', value);
                }
            });

            $(this.$.clusterings).dropdown({
                onChange: function onChange(value, text, $selectedItem) {
                    Backbone.trigger('engine:clustering', value);
                }
            });

            $(this.$.themes).dropdown({
                onChange: (function (value, text, $selectedItem) {
                    _this3.app.setTheme(value);
                }).bind(this)
            });

            Backbone.listenTo(Backbone, Const.unselect_nodes, function (vtx) {
                _this.vertex = null;
            });

            Backbone.listenTo(Backbone, Const.unselect_edges, function (vtx) {
                _this.edge = null;
            });

            Backbone.listenTo(this.graph.vs, 'addflag:selected', function (vertex) {
                _this.vertex = vertex;
            });
            Backbone.listenTo(this.graph.vs, 'rmflag:selected', function (vertex) {
                _this.vertex = null;
            });

            Backbone.listenTo(this.graph.es, 'addflag:selected', function (edge) {
                _this.edge = edge;
            });
            Backbone.listenTo(this.graph.es, 'rmflag:selected', function (edge) {
                _this.edge = null;
            });

            Backbone.listenTo(this.graph.vs, 'remove', function (vtx) {
                if (_this.vertex && vtx.id == _this.vertex.id) _this.vertex = null;
            });

            Backbone.listenTo(this.graph.es, 'remove', function (edge) {
                if (_this.edge && edge.id == _this.edge.id) _this.edge = null;
            });
        },

        toggle_track: function toggle_track() {
            this.track = !this.track;
            var notifications = $('padagraph-notifications')[0];
            notifications.track(this.app.models.graph.id, this.track);
        },

        //- Graph
        clear_graph: function clear_graph() {
            Backbone.trigger('request-graph-clear');
        },

        graph_infos: function graph_infos() {
            Backbone.trigger('request-graph-infos');
        },

        create_nodetype: function create_nodetype() {
            console.log("padagraph-controls", "CREATE NODETYPE");
            Backbone.trigger(Const.ui_create_nodetype);
        },

        create_edgetype: function create_edgetype() {
            console.log("padagraph-controls", "CREATE EDGETYPE");
            Backbone.trigger(Const.ui_create_edgetype);
        },

        //- Vertex  

        create_node: function create_node() {
            console.log("padagraph-controls", "CREATE NODE");
            Backbone.trigger(Const.ui_create_node);
        },

        edit_node: function edit_node() {
            console.debug("padagraph-controls", Const.ui_edit_node, this.vertex);
            Backbone.trigger(Const.ui_edit_node, this.vertex);
        },

        explore: function explore() {
            var params = { graph: this.graph, query: this.vertex.id };
            console.log("padagraph-controls", "engine:explore", params);
            Backbone.trigger('engine:explore', params);
        },

        expand: function expand() {
            var params = { graph: this.graph, nodes: [this.vertex.id], weights: [] };
            console.log("padagraph-controls", "engine:expand_prox", params);
            Backbone.trigger('engine:expand_prox', params);
        },

        add_link: function add_link() {
            var params = { source: this.vertex };
            console.log("padagraph-controls", Const.ui_create_edge, params);
            Backbone.trigger(Const.ui_create_edge, params);
        },

        remove_node: function remove_node() {
            if (this.vertex) {
                Backbone.trigger(Const.remove_node, this.vertex);
                this.vertex = null;
            }
        },

        //- == edges == 

        create_edge: function create_edge() {
            console.log("padagraph-controls", "create:edge");
            Backbone.trigger(Const.ui_create_edge);
        },

        edit_edge: function edit_edge() {
            console.log("padagraph-controls", "edit:edge", this.edge);
            Backbone.trigger(Const.ui_edit_edge, this.edge);
        },

        remove_edge: function remove_edge() {
            Backbone.trigger(Const.remove_edge, this.edge);
            this.edge = null;
        },

        //- == Observers ==

        updateVertex: function updateVertex(vertex) {
            var color = vertex != null ? vertex.get('color') : null;
            this.setBorderColor(color);
        },

        updateEdge: function updateEdge(edge) {
            var color = edge != null ? edge.get('color') : null;
            this.setBorderColor(color);
        },

        //- == Computed properties ==

        setBorderColor: function setBorderColor(color) {
            var value = color ? 'rgb(' + color + ')' : "rgba(0,0,0,0)";
            this.customStyle['--border-color-left'] = "3px solid " + value;
            this.updateStyles();
        }

    });
});</script></dom-module><dom-module id="padagraph-graph-app" assetpath="./"><template><div id="boo"><padagraph-gviz-json sync$="{{sync}}" routes$="{{routes}}" data$="{{data}}"><padagraph-gviz options$="{{options}}"><div id="viz"></div><!-- liste and card details --><div id="cardmenu" class="ui compact menu"><a id="listbutton" on-click="togglelist" class="link item"><i class="list alternate outline icon"></i>list</a><a id="cardbutton" on-click="togglecard" class="link item active"><i class="id card outline icon"></i>details</a></div><padagraph-model-popup id="gvizpopup" hidden$="{{display_list}}"></padagraph-model-popup><padagraph-collection mode="node" hidden$="{{display_card}}"></padagraph-collection><div id="menu" class="ui icon borderless vertical menu"><padagraph-collection-filter mode="node" asitem="asitem"></padagraph-collection-filter><padagraph-collection-filter mode="edge" asitem="asitem"></padagraph-collection-filter><div class="ui divider">         </div><padagraph-engine-control engine="layout" asitem="asitem"></padagraph-engine-control><!--padagraph-engine-control( engine="clustering" asitem="asitem")--><!--padagraph-engine-control( engine="explore" asitem="asitem")--><div class="ui divider"></div><a id="keb_settings" class="ui item"><i class="settings icon"></i></a></div><div id="labels" class="ui grid"><div class="six wide column"><padagraph-labels-control></padagraph-labels-control></div><div class="six wide column"><padagraph-node-search actions="add,explore"></padagraph-node-search><a href$="{{graphurl}}" class="ui tiny active refresh button">refresh</a></div><div class="four wide column"><div id="loading"><p>Loading...</p></div></div></div></padagraph-gviz></padagraph-gviz-json></div></template><script>require(['backbone', 'jquery', 'cello', 'gviz', 'materials', 'pdgconst'], function (Backbone, $, Cello, Gviz, Materials, Const ) {
 Polymer({
  is: "padagraph-graph-app",

  properties : {
    display_card : Boolean,
    display_list : Boolean,
    sync : String,
    routes : String,
    options: Object,
    graphurl: String,
    data: Object,
  },

  
  togglecard(){
      
    var element = document.getElementById("cardbutton");
    element.classList.toggle("active");
    
    var card = document.getElementById("listbutton")
    if ( element.classList.contains("active") && card.classList.contains("active") )
        card.classList.remove("active")

    this.toggle();
  },
  
  togglelist(){
    var e ="listbutton"
    var element = document.getElementById(e);
    element.classList.toggle("active");

    var card = document.getElementById("cardbutton")
    if ( element.classList.contains("active") && card.classList.contains("active") )
        card.classList.remove("active") 

    this.toggle();
  },
  
  toggle(){
    this.display_card = document.getElementById("cardbutton") ? document.getElementById("cardbutton").classList.contains("active") : true; 
    this.display_list = document.getElementById("listbutton") ? document.getElementById("listbutton").classList.contains("active") : false;
  },

  is_hidden(e) { return !e },

  
  attached() {
    console.log("ready!")
    this.toggle();
    //var start = this.startapp.bind(this);  
    //this._observer =
    //    Polymer.dom(this.$.boo).observeNodes(function(info) {
    //     console.log(info);
    //     info.addedNodes.forEach(function(node) {
    //        console.log(node)
    //        if (node.tagName === "PADAGRAPH-GVIZ-JSON"){
    //          console.log("OK");
    //          console.log(document.querySelector('padagraph-gviz').app);
    //          document.querySelector('padagraph-gviz').addEventListener('engines-complete', function(e) {console.log("coucou"); start(e)} );
    //          }
    //     });
    console.log("START!")
    document.querySelector('padagraph-model-popup').hidden = true;
    this.toggle();
    
    var _window_resized = function(){
        var e = document.getElementById('gviz');
        //e.style.height = ( window.innerHeight - 32 )+ "px";
        e.style.height = ( window.innerHeight )+ "px";
        var app = document.querySelector('padagraph-gviz').app
        if ( app.gviz ) app.gviz.resize_rendering();
    }
    
    window.onresize = _window_resized;

    var loading = function(e, name, engine, show){
        console.log("loading",e,  name, engine, show)
        var element = document.getElementById("loading");
        if ( show && !element.classList.contains("show") )
            element.classList.toggle("show");
        if ( !show && element.classList.contains("show") )
            element.classList.toggle("show");
    };      
   document.querySelector('padagraph-gviz-json').addEventListener('engines-complete', function (e) {  
    console.log(e.detail.app); // true
    var app = e.detail.app;
    
    var engines = [];
    var app_engines = {
        'explore':app.engines.explore,
        //'expand':app.engines.expand_px,
        'layout':app.engines.layout,
        'clustering':app.engines.clustering,
    };
    
    for (var k in app_engines){
        var engine = app_engines[k]
        engine.name = k;
        engines.push(engine);
    }

     $('padagraph-collection')[0].app = app;
     $('padagraph-collection')[0].graph = app.models.graph;
    document.app = app
    
    var keb = document.createElement("padagraph-keb")
    keb.engines = engines;
    $("#keb")
        .sidebar('setting', 'dimPage', false)
        .sidebar('setting', 'transition', 'overlay')
    $("#kebcontent").append(keb)
    $("#keb .close i.close.icon").click( ()=>{ $("#keb").sidebar('hide') } )
    $("#keb_settings").click( ()=>{ $("#keb").sidebar('show') } )

    _window_resized();
    });
  }
 })
});</script></dom-module></div></body></html>