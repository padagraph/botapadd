/*!  20-03-2018 */
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(c,d){return b(a,c,d)}):a.Cello=b(a,_,Backbone)}(this,function(a,b,c){function d(a,b){return Math.floor(Math.random()*(b-a+1))+a}var e={desc:"",version:.2,license:"!! TODO !!",DEBUG:!1};e.log=function(){console.log("INFO",arguments)},e.debug=function(){e.DEBUG&&console.log("DEBUG",arguments)},e.assert=function(a,c){if(!a){var d="Assertion failed";throw b.isArray(c)&&(d=c.join("\n")),c&&(d=c),new Error(d)}},e.get=function(a,c,d){default_getter=function(){return e.assert(b(a).has("attributes")),e.assert(b(a.attributes).has(c)),a.attributes[c]},a.__defineGetter__(c,d||default_getter)},e.set=function(a,c,d){var f=function(d){e.assert(b(a).has("attributes"));var f=d;b(a).has("attributes")&&(b(a.attributes).has(c)&&(f=a.attributes[c]),a.attributes[c]=d,f!=d&&(a.trigger("change",a),a.trigger("change:"+c,a,d)))};a.__defineSetter__(c,d||f)},e.getset=function(a,b,c,d){e.get(a,b,c),e.set(a,b,d)},e.FlagableCollection=function(a){a.model.active_flags||[];b.each(a.model.active_flags,function(b){e.FlagMethod(a,b)}),a.by_flag=function(b){return a.filter(function(a){return a.has_flag(b)})},a._check_models_param=function(a){return a=b.isUndefined(a)?this.models:a,a=b.isNull(a)?[]:a,a=b.isArray(a)?a:[a]},a.set_flag=function(c,d){d=a._check_models_param(d);var e=a.by_flag(c),f=b.sortBy(d,f);b.isEqual(e,d)===!1&&a.add_flag(c,d,!0)},a.add_flag=function(c,d,e,f){var e=void 0!==e&&e,g=a.by_flag(c);if(d=a._check_models_param(d),(0!=g.length||0!=d.length)&&b.isObject(d)){var h=b.union(d,e?[]:g),i=b.difference(g,h);b.difference(h,g);a.remove_flag(c,i,f),b.each(d,function(a){a.add_flag(c,f)})}},a.remove_flag=function(c,d,e){d=a._check_models_param(d),b.each(d,function(a){a.remove_flag(c,e)})}},e.Flagable=function(a){a.get("flags")||a.set("flags",[]),e.get(a,"flags"),a.add_flag=function(a,c){this.has_flag(a)||(this.set("flags",b.union(this.flags,[a]),{silent:!0}),c&&c.silent||(this.trigger("addflag",a,this),this.trigger("addflag:"+a,this),this.collection.trigger("addflag:"+a,this,c)))},a.remove_flag=function(a,c){this.has_flag(a)&&(this.set("flags",b.without(this.flags,a),{silent:!0}),c&&c.silent||(this.trigger("rmflag",a,this),this.trigger("rmflag:"+a,this),this.collection.trigger("rmflag:"+a,this)))},a.has_flag=function(a){return this.flags||console.log(this),this.flags.indexOf(a)>=0}},e.FlagMethod=function(a,b){var c="add_"+b,d="set_"+b;e.assert(void 0===a[c]),e.assert(void 0===a[d]),a[d]=function(c){a.set_flag(b,c,!0)},a[c]=function(c,d){a.add_flag(b,c,d)}},e.SortableCollection=function(a,d,f,g){e.assert(b.isString(f)),e.assert(b.isObject(d)),a.sortables=new c.Collection([],{model:e.Sortable}),e.FlagableCollection(a.sortables),b(d).each(function(b){a.sortables.add(new e.Sortable(b))}),a.listenTo(a.sortables,"change:selected change:reversed",function(b){a.comparator=b.get_comparator(),a.sort()}),console.log(a.sortables);var h=a.sortables.findWhere({field:f});return e.assert(h,"invalid default_key ("+f+")"),h.select(),a.sort_reverse&&h.reverse(),a.comparator=h.get_comparator(),a},e.Sortable=c.Model.extend({defaults:{field:"",type:"",label:null},comparators:{alpha:function(a){var b=function(b,c){return b.get(a).localeCompare(c.get(a))};return b},numeric:function(a){var b=function(b,c){return b.get(a)-c.get(a)==0?0:b.get(a)-c.get(a)>0?1:-1};return b}},initialize:function(a,c){e.Flagable(this),e.get(this,"field"),e.get(this,"type"),e.get(this,"selected",function(){return this.has_flag("selected")}),e.get(this,"reversed",function(){return this.has_flag("reversed")}),this.listenTo(this,"addflag:selected rmflag:selected",function(){this.collection.trigger("change:selected",this),this.collection.trigger("change")}),this.listenTo(this,"addflag:reversed rmflag:reversed",function(){this.collection.trigger("change:reversed",this),this.collection.trigger("change")}),b.has(a,"label")&&a.label||this.set("label",a.field);this.get_comparator();return this},get_comparator:function(){var a=this.type,c=null;if(b.isFunction(a))c=a(this.field);else{if(!b.has(this.comparators,a))throw Error("comparator not found ! (type: '"+a+"')");c=this.comparators[a](this.field)}if(this.reversed){var d=c;c=function(a,b){return d(b,a)}}return c},select:function(){this.selected||(b(this.collection.by_flag("selected")).each(function(a){a.remove_flag("selected"),a.reversed&&a.remove_flag("reversed")}),this.add_flag("selected"))},reverse:function(){this.reversed||this.add_flag("reversed")},toggle_reverse:function(){this.reversed?this.remove_flag("reversed"):this.add_flag("reversed")}},{active_flags:["selected","reversed"]}),e.DocList=c.Collection.extend({model:e.Doc,initialize:function(a,c){b(this).bindAll("_set_sort_key","_set_sort_reverse","_set_sortables","_get_sort_key","_get_sort_reverse","_get_sortables"),c=c||{},e.get(this,"selected",function(){return this.has_flag("selected")});var d=c.sort_key||"title",f=c.sort_reverse||!1,g=c.sortables||[];this.model&&(e.FlagableCollection(this),e.SortableCollection(this,g,d,f))},_set_sort_key:function(a){var b=this.sort_key;this._sort_key=a,b!=this.sort_key&&(this.trigger("change"),this.trigger("change:sort_key"))},_get_sort_key:function(){return this._sort_key},_set_sort_reverse:function(a){var b=this.sort_reverse;this._sort_reverse=a,b!=this.sort_reverse&&(this.trigger("change"),this.trigger("change:sort_reverse"))},_get_sort_reverse:function(){return this._sort_reverse},_set_sortables:function(a){var b=this.sortables;this._sortables=a,b!=this.sortables&&(this.trigger("change"),this.trigger("change:sort_reverse"))},_get_sortables:function(){return this._sortables},select:function(a){a.select(),this.trigger("change:selected")},clear_selection:function(){this.set_selected(null),options&&options.silent||this.trigger("change:selected"),this.trigger("change:selected")},unselect:function(a){a.remove_flag("selected"),this.trigger("change:selected")}}),e.Doc=c.Model.extend({defaults:{docnum:null,selected:!1,clusters:null},idAttribute:"docnum",initialize:function(a,b){e.get(this,"docnum"),e.get(this,"selected",function(){return this.has_flag("selected")}),e.getset(this,"clusters"),this.clusters={},e.Flagable(this),e.assert(null!==this.docnum,"Document should have a docnum")},select:function(){this.add_flag("selected")},toggle_select:function(){this.selected?this.remove_flag("selected"):this.add_flag("selected")}},{active_flags:["selected"]}),e.QueryModel=c.Model.extend({defaults:{cellist:null,query:"",loaded:!1},loaded_query:null,initialize:function(a,c){b.bindAll(this,"set_query","play_completed","query_updated"),e.get(this,"cellist"),e.get(this,"loaded"),e.get(this,"query"),e.set(this,"query",this.set_query),this.listenTo(this.cellist,"play:complete",this.play_completed),this.on("change:query",this.query_updated)},set_query:function(a){a=a.trim(),console.log("set_query",a),this.set("query",a)},query_updated:function(){this.query!==this.loaded_query?this.set("loaded",!1):this.set("loaded",!0)},play_completed:function(a){a.results.query!=this.query&&(this.query=a.results.query),this.loaded_query=this.query,this.set("loaded",!0)},validate:function(){return!0},play:function(){this.cellist.play()},export_for_engine:function(){return this.query}}),e.Option=c.Model.extend({defaults:{value:void 0,name:null,otype:{}},idAttribute:"name",initialize:function(a,c){var d=this;b.bindAll(this,"validate"),e.get(this,"name"),e.get(this,"otype"),e.get(this,"value"),e.set(this,"value",function(a){var b=d.validate(a);d.value!=b&&d.set("value",b)}),e.assert(null!==this.name,"Option should have a name"),e.assert(null!==a.otype,"(Option: "+this.name+") otype should not be 'null'")},is_default:function(){return b.isEqual(this.value,this.otype.default)},parse:function(a){return this.otype&&("Boolean"===this.otype.type&&(a=[1,!0,"true","True","TRUE","1","yes"].indexOf(a)>=0),"float"===this.otype.vtype&&(a=parseFloat(a)),"int"===this.otype.vtype&&(a=parseInt(a),b.isNaN(a)&&(a=""))),a},_validate_one:function(a){a=this.parse(a);var c=this.otype.choices;if(c&&b.indexOf(c,a)<0)throw new Error("invalid option value");return a},is_multi:function(){return this.otype.multi},validate:function(a){var c=this;if(this.is_multi()){var d=[];b.each(a,function(a){d.push(c._validate_one(a))}),a=d}else a=this._validate_one(a);return a}}),e.Options=c.Collection.extend({model:e.Option}),e.Component=c.Model.extend({idAttribute:"name",defaults:{name:null,selected:!1,doc:"",options:new e.Options},initialize:function(){e.get(this,"name"),e.get(this,"options"),e.get(this,"selected"),this.listenTo(this.options,"reset",this.optionsChanged),this.listenTo(this.options,"change",this.optionsChanged),e.assert(null!==this.name,"Component should have a name")},get_option:function(a){return this.options.where({name:a})[0]},set_option:function(a,b){var c=this.get_option(a);c.value=b},parse:function(a,b){return a.options=new e.Options(a.options,{parse:!0}),a.default&&(a.selected=!0),a},optionsChanged:function(a){this.trigger("change",this,a),this.trigger("change:options",this,a)},changed_options:function(){var a=[];return b.each(this.options.models,function(b){b.is_default()||a.push(b)}),a},as_dict:function(a){void 0!==a&&null!=a||(a=!1);var c={name:this.name},d=a?this.changed_options():this.options.models;return d.length>0&&(c.options={},b.each(d,function(a){c.options[a.name]=a.value})),c},set_state:function(a){var c=this;b.each(a,function(a,b){c.set_option(b,a)})}}),e.Components=c.Collection.extend({model:e.Component}),e.Block=c.Model.extend({defaults:{name:"",components:new e.Components,required:!0,multiple:!1,args:null,returns:null},initialize:function(a){e.get(this,"components"),e.get(this,"selected",this._get_selected),e.get(this,"name"),e.get(this,"required"),e.get(this,"multiple"),e.get(this,"args"),e.get(this,"returns"),e.assert(null!==this.name,"Block should have a name"),e.assert(b.isNull(this.args)||b.isArray(this.args),"'args' should be null or an Array"),null===this.returns&&this.set("returns",this.name),this.listenTo(this.components,"reset",this.componentsChanged),this.listenTo(this.components,"change",this.componentsChanged),this.selection_default=b.map(this.selected,function(a){return a.name})},componentsChanged:function(a){this.trigger("change",this,a),this.trigger("change:components",this,a)},parse:function(a,b){return a.components=new e.Components(a.components,{parse:!0}),a},reset:function(){this.components.reset()},get_component:function(a){return b.find(this.components.models,function(b){return b.name==a})},_get_selected:function(){return this.components.where({selected:!0})},select:function(a){a.selected?this.required||(a.set("selected",!1),this.trigger("change"),this.trigger("change:selected")):(this.multiple||b.each(this.selected,function(a){a.set("selected",!1)}),a.set("selected",!0),this.trigger("change"),this.trigger("change:selected"))},unselect:function(a){a.selected&&(!this.required||this.multiple&&this.selected.length>1)&&(a.set("selected",!1),this.trigger("change"),this.trigger("change:selected"))},clear_selection:function(){var a=this;b.each(this.selected,function(b){a.unselect(b)})},validate:function(){},get_state:function(a){void 0!==a&&null!=a||(a=!1);var c=[],d=this.selected,e=b.isEqual(b.map(d,function(a){return a.name}),this.selection_default);for(var f in d){var g=d[f],h=g.as_dict(a);a&&e&&!b.has(h,"options")||c.push(g.as_dict(a))}return c},set_state:function(a){var c=this;b.each(a,function(a){var b=a.name,d=a.options,e=c.get_component(b);e.set_state(d),c.select(e)})}}),e.Blocks=c.Collection.extend({model:e.Block}),e.Engine=c.Model.extend({defaults:{blocks:new e.Blocks,args:null,returns:null,needed_inputs:[]},initialize:function(a,b){var c=a.url;this.input_models={},this.url=c,this.play_url=c,e.get(this,"blocks"),e.get(this,"args"),e.get(this,"returns"),e.get(this,"needed_inputs"),this.listenTo(this.blocks,"change reset",this.blockChanged)},get_block:function(a){return b.find(this.blocks.models,function(b){return b.get("name")==a})},blockChanged:function(a){this._update_needed_inputs(),this.trigger("change",this,a),this.trigger("change:blocks",this,a)},_update_needed_inputs:function(){var a=[],b=[],c=this.blocks.models;for(var d in c){var e=c[d];if(e.selected.length>0){for(var f in e.args){var g=e.args[f];b.indexOf(g)<0&&a.indexOf(g)&&a.push(g)}b.push(e.returns)}}this.set({needed_inputs:a},{silent:!0})},parse:function(a,b){return console.log("Engine parse",a,b),this.data=a,a.blocks=new e.Blocks(a.blocks,{parse:!0}),a},reset:function(a){a=this.parse(a),this.set(a)},get_state:function(a){void 0!==a&&null!=a||(a=!1);var b={},c=this.blocks.models;for(var d in c){var e=c[d],f=e.get_state(a);f.length>0&&(b[e.name]=f)}return b},set_state:function(a){var c=this;b.each(a,function(a,b){var d=c.get_block(b);d.set_state(a)})},get_state_str:function(a){var b=this.get_state(a),c=$.param(b);return c},set_state_str:function(a){var b=e.utils.deparam(a);this.set_state(b)},register_input:function(a,b){this.input_models[a]=b},play:function(a){var d=this,f=this.get_state(),g={};b.each(this.input_models,function(a,b,c){g[b]=a.export_for_engine()});var g=b.extend(g,a),h=b.extend({},g,{options:f});e.log("play",h),d.trigger("play:loading",g,f);var h=JSON.stringify(h);c.ajax({url:d.play_url,method:"post",contentType:"application/json",data:h,success:function(b,c,e){b.meta&&b.meta.errors&&b.meta.errors.length>0?d.trigger("play:error",b,e):(console.log("play:success",b,a,f),d.trigger("play:success",b,a,f),d.trigger("play:complete",b,a,f))},error:function(a,b,c){d.trigger("play:error",{},a),d.trigger("play:complete",{},a)}})}});var f=c.Model.extend({IN:1,OUT:2,ALL:4,defaults:{gid:null,directed:!1,bipartite:!1},idAttribute:"gid",initialize:function(a,b){var d=this;if(this.edge_list={},this.nodetype_model=a.nodetype_model||h,this.nodetypes=new p([],{model:this.nodetype_model}),this.edgetype_model=a.edgetype_model||j,this.edgetypes=new p([],{model:this.edgetype_model}),this.properties||(this.properties=new c.Model),this.meta||(this.meta=new c.Model),e.get(this,"label",function(){return this.properties.get("name")}),this.urlRoot=a.urlRoot,this.urlRoot){var f=function(a){d.nodetypes.url=d.url()+"/nodetypes",d.nodetypes.reset(),d.nodetypes.fetch({remove:!1}),d.edgetypes.url=d.url()+"/edgetypes",d.edgetypes.reset(),d.edgetypes.fetch({remove:!1})};this.on("change:gid",f),this.nodetypes.on("add",function(a){a.urlRoot=d.url()+"/nodetype"}),this.edgetypes.on("add",function(a){a.urlRoot=d.url()+"/edgetype"})}this.vertex_model=a.vertex_model||l,this.vs=new e.Vertices([],{graph:this,model:this.vertex_model}),this.vs.reset([],{collection:this.vs});var g=function(a){a&&(a.collection=d.vs,void 0===a.id&&(a.id=d.vs.size()),a.id in d.edge_list||(d.edge_list[a.id]=[]))},i=function(a){var b=d.es.filter(function(b){return b.get("source")==a.id||b.get("target")==a.id});d.es.remove(b),delete d.edge_list[a.id]};this.vs.on("add",g),this.vs.on("remove",i),this.edge_model=a.edge_model||m,this.es=new e.Edges([],{graph:this,model:this.edge_model}),this.es.reset([],{collection:this.es});var k=function(a){a.collection=d.es,d.edge_list[a.get("source")].push(a),d.edge_list[a.get("target")].push(a)},n=function(a){d.edge_list[a.get("source")].splice(d.edge_list[a.get("source")].indexOf(a),1),d.edge_list[a.get("target")].splice(d.edge_list[a.get("target")].indexOf(a),1)};this.es.on("add",k),this.es.on("remove",n),e.FlagableCollection(this.vs),e.FlagableCollection(this.es),a.data&&this.reset(a.data)},url:function(){return this.urlRoot+this.id},parse:function(a,b){this.reset(a[this.id],b)},reset:function(a,c){e.debug("parse graph",a),a.nodetypes&&this.nodetypes.set({nodetypes:a.nodetypes},{parse:!0}),a.edgetypes&&this.edgetypes.set({edgetypes:a.edgetypes},{parse:!0}),a.properties&&this.properties.set(a.properties,{parse:!0}),a.meta&&this.meta.set(a.meta,{parse:!0}),c=c?b.clone(c):{},a.vs&&a.es&&(this.edge_list={},this.es.reset([],c),this.vs.reset([],c),c={parse:!0},this.vs.set(a.vs,c),this.es.set(a.es,c)),this.trigger("reset")},merge:function(a,b){e.debug("merge graph",a),a.nodetypes&&this.nodetypes.set({nodetypes:a.nodetypes},{remove:!1,parse:!0}),a.edgetypes&&this.edgetypes.set({edgetypes:a.edgetypes},{remove:!1,parse:!0}),a.meta&&this.meta.set(a.meta,{parse:!0}),a.properties&&this.properties.set(a.properties,{parse:!0}),this.vs.add(a.vs,{parse:!0}),this.es.add(a.es,{parse:!0}),this.trigger("merge")},get_edge_type:function(a){var b=this.edgetypes.get(a);if(b)return b},get_node_type:function(a){var b=this.nodetypes.get(a);if(b)return b;if(a){var b=new this.nodetype_model({name:a,uuid:a});return this.nodetypes.add(b),b}},summary:function(){return{attrs:this.attributes,vcount:this.vcount(),ecount:this.ecount(),density:this.density(),v_attrs:this.attributes.v_attrs,e_attrs:this.attributes.e_attrs}},str:function(){var a=b.template("v:<%=vcount%>, e:<%=ecount%>,density:<%=density%>,\nv attrs:<%=v_attrs%>, \ne attrs:<%=e_attrs%>, ");return a(this.summary())},add_vertex:function(a){this.vs.add(a)},vcount:function(){return this.vs.length},add_edge:function(a){this.es.add(a)},is_loop:function(a){var c=function(a){return a.source===a.target};return b.map(a,c)},ecount:function(){return this.es.length},incident:function(a,c,d){var e=this,f=[],g=a.id,h=void 0===c?this.ALL:c,i=void 0===d||d;return h==e.ALL?f=b.filter(e.edge_list[g],function(a){return!!i||!a.is_loop()}):h==e.IN?f=b.filter(e.edge_list[g],function(a){return!(a.source.id!=g||!i&&a.is_loop())}):h==e.OUT&&(f=b.filter(e.edge_list[g],function(a){return!(a.target.id!=g||!i&&a.is_loop())})),f},degree:function(a,b,c){return this.incident(a,b,c).length},neighbors:function(a,c,d){var e=this.incident(a,c,d),f=b(e).map(function(b){return b.source!=a?b.source:b.target});return f},strength:function(a,c,d){var e=this.incident(a,c,d),f=function(a,b){return a+b.weight};return b.reduce(e,f,0)},select:function(a){var c={degree:1,strength:1},d=function(d){for(var e in a){var f,g=a[e],h=e.split(":"),i=h[0],j=2==h.length?h[1]:"eq";if("_"==i.substring(0,1)?(method=i.slice(1),method in c&&(f=d[method]())):f=d.get(i),"eq"==j){if(b.isEqual(f,g)===!1)return!1}else if("ne"==j){if(f==g)return!1}else if("lt"==j){if(f<g==!1)return!1}else if("gt"==j){if(f>g==!1)return!1}else if("le"==j){if(f<=g==!1)return!1}else if("ge"==j){if(f>=g==!1)return!1}else if("in"==j){if(b.indexOf(g,f)===-1)return!1}else if("notin"==j&&b.indexOf(g,f)!==-1)return!1}return!0};return b.filter(this.vs.models,d)},random_vertex:function(){var a=this.es.at(d(0,this.es.size()-1));return Math.random()>.5?a.source:a.target},density:function(){return 2*this.es.length/(this.vs.length*(this.vs.length-1))},adjacency:function(){var a=[],c=0,d=function(){return 0};for(c=this.vcount(),i=0;i<c;i++)a.push(b.range(c).map(d));for(c=this.ecount(),i=0;i<c;i++){var e=this.es[i];a[e.source][e.target]=e.weight}this.adjacency=a}}),g=c.Model.extend({idAttribute:"uuid",defaults:{name:"",description:"",properties:new e.Options,material:{}},get_property:function(a){return this.properties.where({name:a})[0]},add_property:function(a,b){},delete_property:function(a,b){},parse:function(a,b){var c=[];for(k in a.properties)c.push({name:k,otype:a.properties[k]});return{properties:new e.Options(c,{parse:!0}),name:a.name,description:a.description||"",uuid:a.uuid}},toString:function(){return this.get("name")},toJSON:function(a){var c=b.pick(this.attributes,"name","description","uuid"),d=this.get("properties").models,e={};for(var f in d){var g=d[f];""!=g.get("name")&&(e[g.get("name")]=g.get("otype"))}return c.properties=e,c}}),h=g.extend({initialize:function(a,b){e.get(this,"name"),e.get(this,"properties"),e.get(this,"label",function(){var a=this.get("name");return void 0===a?"":a});var d=this;this.on("sync",function(a,b,d){c.trigger("nodetype:save",this,b,d)}),this.listenTo(this.attributes.properties,"change",function(){d.trigger("change:properties",d.attributes.properties)})}}),j=g.extend({initialize:function(a,b){e.get(this,"name"),e.get(this,"properties"),e.get(this,"label",function(){var a=this.get("name");return void 0===a?"":a}),this.on("sync",function(a,b,d){c.trigger("edgetype:save",this,b,d)})}}),l=c.Model.extend({idAttribute:"uuid",defaults:{uuid:"",nodetype:"",label:"",color:[0,0,0],coords:[0,0,0],clusters:null},initialize:function(a,d){var f=this;e.getset(this,"color"),e.getset(this,"clusters"),this.clusters={},e.get(this,"graph",function(){return null!=f.collection?f.collection.graph:null}),e.get(this,"nodetype",function(){return f.graph?f.graph.get_node_type(f.get("nodetype")):null}),e.get(this,"label",function(){var a=this.get("label");return void 0===a?"":a}),e.Flagable(this),b.bindAll(this,"degree","format_label","neighbors","strength"),e.get(this,"formatted_label",this.format_label),this.on("sync",function(a,b,d){c.trigger("node:save",f,b,d)})},getHexColor:function(){return 0},format_label:function(a){var b=this.label;return a&&(b=b.substring(0,a)),[{form:b,css:".normal-font"}]},degree:function(a,b){return this.graph.degree(this,a,b)},strength:function(a,b){return this.graph.strength(this,a,b)},incident:function(a,b){return this.graph.incident(this,a,b)},neighbors:function(a,b){return this.graph.neighbors(this,a,b)}},{active_flags:[]}),m=c.Model.extend({idAttribute:"uuid",defaults:{label:"",edgetype:null,source:null,target:null},initialize:function(a,b){var d=this;a||(a={}),e.get(this,"graph",function(){return null!=d.collection?d.collection.graph:null}),e.get(this,"edgetype",function(){return d.graph?d.graph.get_edge_type(d.get("edgetype")):null}),e.get(this,"source",function(){return d.graph?d.graph.vs.get(d.get("source")):null}),e.get(this,"target",function(){return d.graph?d.graph.vs.get(d.get("target")):null}),e.get(this,"label",function(){return d.get("label")}),e.get(this,"sym",this.sym),a.w&&(this.weight=a.w),e.Flagable(this),this.on("sync",function(a,b,d){c.trigger("edge:save",a,b,d)})},str:function(){var a=function(a,b){return b+": "+a};return"("+this.get("s")+","+this.get("t")+")  "+this.source.label+"-->"+this.target.label+","+b.map(this.attributes,a).join(", ")},tuple:function(){},sym:function(){return b(this.collection.models).findWhere({source:this.target,target:this.source})},is_loop:function(){return this.source.id==this.target.id}},{active_flags:[]}),n=c.Collection.extend({model:l,initialize:function(a,b){_this=this,b&&(this.graph=b.graph)},copy_attr:function(a,c,d){b.map(this.graph.vs.select({}),function(b){b.set(c,b.get(a),d)})},select:function(a){return this.graph.select(a)}}),o=c.Collection.extend({model:m,initialize:function(a,b){this.graph=b.graph},between:function(a,b,c){if(a&&b)return this.models.filter(function(d){return c?d.source==a&d.target==b:(d.source==a|d.source==b)&(d.target==a|d.target==b)})}}),p=c.Collection.extend({model:g,parse:function(a){return"nodetypes"in a?a.nodetypes:"edgetypes"in a?a.edgetypes:void 0}});e.Graph=f,e.Type=g,e.Vertices=n,e.Vertex=l,e.Edges=o,e.Edge=m,e.EdgeType=j,e.NodeType=h,e.ClusterLabel=c.Model.extend({idAttribute:"id",defaults:{label:"",score:1,role:"*",size:12,clusters:null},initialize:function(){e.get(this,"label"),e.get(this,"role"),e.get(this,"score"),e.getset(this,"clusters"),this.clusters={},b.bindAll(this,"_format_label"),e.get(this,"formatted_label",this._format_label),e.Flagable(this)},_format_label:function(){return[{form:this.get("label"),css:"normal"}]}},{active_flags:[]}),e.Cluster=c.Model.extend({defaults:{members:{},labels:[],misc:!1,selected:!1,color:[200,200,200]},initialize:function(a,c){var d=this;b.bindAll(d,"_compute_membership","_compute_colors"),e.get(this,"members"),e.getset(this,"labels"),e.get(this,"misc"),e.getset(this,"color"),e.get(this,"selected",function(){return d.has_flag("selected")}),this.listenTo(this,"addflag:selected rmflag:selected",function(){d.collection.trigger("change:selected")}),e.Flagable(this)},is_misc:function(){return this.misc},select:function(a){a?this.collection.set_selected([this]):this.add_flag("selected")},toggle_select:function(a){var b=this.collection.selected.length;this.selected?a&&b>=2?this.collection.set_selected([this]):this.remove_flag("selected"):this.select(a)},some_selected:function(){return this.selected||this.collection.by_flag("selected")},_compute_membership:function(){var a=this,c=this.collection.clustering.cid;b(a.members).each(function(b){b.each(function(b){var d={cluster:a};b.clusters[c]?b.clusters[c].push(d):b.clusters[c]=[d],b.trigger("change:clusters"),b.trigger("change:clusters:"+c)})})},_compute_colors_old:function(){var a=this.collection.length,b=this.collection.clustering.get("color_value"),c=this.collection.clustering.get("color_saturation"),d=this.collection.indexOf(this),f=[99,99,99];this.misc===!1&&(f=e.utils.hsvToRgb(d/a*360|0,c,b)),this.color=f},_compute_colors:function(a){if(this.misc===!0)return void(this.color=[99,99,99]);var c=(this.collection.length,this.collection.clustering.get("color_value")),d=this.collection.clustering.get("color_saturation"),f=(this.collection.indexOf(this),[0,0,0]),g=f,h=0,i={};this.members.vs.each(function(a){var b=a.get("cl_color");s_last_node_cl_color=b.toString(),i[s_last_node_cl_color]?i[s_last_node_cl_color]++:i[s_last_node_cl_color]=1,i[s_last_node_cl_color]>h&&(h=i[s_last_node_cl_color],g=b)}),cluster_color=g;for(var j=0;b.isEqual(cluster_color,f)|a.indexOf(cluster_color.toString())!=-1;)cluster_color=e.utils.hsvToRgb(1*j*222.23%360|0,d,c),j++;a.push(cluster_color.toString()),this.color=cluster_color}},{active_flags:["selected"]}),e.ClustersList=c.Collection.extend({model:e.Cluster,initialize:function(a,b){_this=this,e.get(this,"selected",function(){return this.by_flag("selected")}),e.assert(b.clustering,"options.clustering is needed"),this.clustering=b.clustering,this.on("add remove reset",function(){var a=[];this.each(function(b){b._compute_membership(),b._compute_colors(a)})}),this.listenTo(this.clustering,"change:color_saturation change:color_value",function(){var a=[];this.each(function(b){b._compute_colors(a)})})},some_selected:function(){return this.by_flag("selected").length>0},select:function(a,b){a.select(b),this.trigger("change:selected",a)},clear_selection:function(a){this.set_selected(null),a&&a.silent||this.trigger("change:selected")},unselect:function(a){a.remove_flag("selected"),this.trigger("change:selected")},has_misc:function(){var a=function(a){return a.is_misc()};return b.some(this.models,a)},cluster:function(a){return this.at(a)}}),e.Clustering=c.Model.extend({defaults:{clusters:null,members:{},color_value:80,color_saturation:40},ClusterLabelModel:e.ClusterLabel,ClusterModel:e.Cluster,ClustersCollection:e.ClustersList,initialize:function(a,b){a=a||{},e.getset(this,"members"),e.getset(this,"clusters"),e.getset(this,"color_value"),e.getset(this,"color_saturation"),this.ClusterLabelModel=a.ClusterLabelModel||this.ClusterLabelModel,this.ClusterModel=a.ClusterModel||this.ClusterModel,this.ClustersCollection=a.ClustersCollection||this.ClustersCollection;var c={clustering:this,model:this.ClusterModel},d=new this.ClustersCollection([],c);this.set("clusters",d),e.FlagableCollection(this.clusters)},reset:function(a,c){var d=this,e=b(a).clone();c&&c.members&&b.extend(this.members,c.members);var f=this.members;b.map(e.clusters,function(a){a.misc=!1}),e.misc>-1&&(e.clusters[e.misc].misc=!0),cluster_models=[],b.each(e.clusters,function(a){cluster_members={},b.each(f,function(c,d){source_clone=c.source.clone(),source_filtered=source_clone.filter(function(d){return b(a[c.id_field]).contains(d.id)}),source_clone.reset(source_filtered,{silent:!0}),cluster_members[d]=source_clone}),cluster_models.push(new d.ClusterModel({members:cluster_members,misc:a.misc}))}),this.clusters.reset(cluster_models),this.trigger("reset")},set_labels:function(a,b){this.clusters.each(function(b,c){b.labels=a.labels[c]})}}),e.utils={},e.utils.asEvents=function(a){var b;return{on:function(c,d){if(b)throw new Error("this is one off wrapper");a.addEventListener(c,d,!1),b=[c,d]},off:function(){a.removeEventListener.apply(a,b)}}};var q=function(a){return a="0"+a.toString(16),a.substring(a.length-2)};return e.utils.css_color=function(a){var c="#000000";return a&&(c="#"+b.map(a,q).join("")),c},e.utils.css_gradient=function(a,b){return"-webkit-linear-gradient("+e.utils.css_color(a)+","+e.utils.css_color(b)+")"},e.utils.color_darker=function(a){var b=e.utils.rgbToHsv(a[0],a[1],a[2]);return e.utils.hsvToRgb(b[0],b[1],60)},e.utils.hsvToRgb=function(a,b,c){b/=100,c/=100;var d=Math.floor(a/60%6),e=a/60-d,f=c*(1-b),g=c*(1-e*b),h=c*(1-(1-e)*b),i=[];switch(d){case 0:i=[c,h,f];break;case 1:i=[g,c,f];break;case 2:i=[f,c,h];break;case 3:i=[f,g,c];break;case 4:i=[h,f,c];break;case 5:i=[c,f,g]}var j=Math.min(255,256*i[0]|0),k=Math.min(255,256*i[1]|0),l=Math.min(255,256*i[2]|0);return[j,k,l]},e.utils.rgbToHsv=function(a,b,c){var d,e,f=a/255,g=b/255,h=c/255,i=Math.min(Math.min(f,g),h),j=Math.max(Math.max(f,g),h),k=j;return j==i?e=0:j==f?e=60*((g-h)/(j-i))%360:j==g?e=60*((h-f)/(j-i))+120:j==h&&(e=60*((f-g)/(j-i))+240),e<0&&(e+=360),d=0===j?0:1-i/j,[0|e,100*d|0,100*k|0]},e.utils.addCSSRule=function(a,b,c){for(var d,e,f=0;f<document.styleSheets.length;f++){d=document.styleSheets[f],e=d.cssRules||d.rules;for(var g=a.toLowerCase(),h=0,i=e.length;h<i;h++)if(e[h].selectorText&&e[h].selectorText.toLowerCase()==g){if(null!==c)return void(e[h].style[b]=c);d.deleteRule?d.deleteRule(h):d.removeRule?d.removeRule(h):e[h].style.cssText=""}}d=document.styleSheets[0]||{},d.insertRule?(e=d.cssRules||d.rules,d.insertRule(a+"{ "+b+":"+c+"; }",e.length)):d.addRule&&d.addRule(a,b+":"+c+";",0)},e.utils.deparam=function(a,b){var c={},d={true:!0,false:!1,null:null};return $.each(a.replace(/\+/g," ").split("&"),function(a,e){var f,g=e.split("="),h=decodeURIComponent(g[0]),i=c,j=0,k=h.split("]["),l=k.length-1;if(/\[/.test(k[0])&&/\]$/.test(k[l])?(k[l]=k[l].replace(/\]$/,""),k=k.shift().split("[").concat(k),l=k.length-1):l=0,2===g.length)if(f=decodeURIComponent(g[1]),b&&(f=f&&!isNaN(f)?+f:"undefined"===f?void 0:void 0!==d[f]?d[f]:f),l)for(;j<=l;j++)h=""===k[j]?i.length:k[j],i=i[h]=j<l?i[h]||(k[j+1]&&isNaN(k[j+1])?{}:[]):f;else $.isArray(c[h])?c[h].push(f):void 0!==c[h]?c[h]=[c[h],f]:c[h]=f;else h&&(c[h]=b?void 0:"")}),c},e.utils.piwikTrackCurrentUrl=function(){b.isUndefined(window._paq)||"function"!=typeof window._paq.push||(window._paq.push(["setCustomUrl",window.location.href]),window._paq.push(["trackPageView"]))},e});