/*!  11-12-2021 */

!function(e,s){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(e,t){return s(0,e,t)}):e.Cello=s(0,_,Backbone)}(this,function(e,c,l){var a={desc:"",version:.2,license:"!! TODO !!",DEBUG:!1,log:function(){console.log("INFO",arguments)},debug:function(){a.DEBUG&&console.log("DEBUG",arguments)},assert:function(e,t){if(!e){var s="Assertion failed";throw c.isArray(t)&&(s=t.join("\n")),t&&(s=t),new Error(s)}},get:function(e,t,s){default_getter=function(){return a.assert(c(e).has("attributes")),a.assert(c(e.attributes).has(t)),e.attributes[t]},e.__defineGetter__(t,s||default_getter)},set:function(s,i,e){s.__defineSetter__(i,e||function(e){a.assert(c(s).has("attributes"));var t=e;c(s).has("attributes")&&(c(s.attributes).has(i)&&(t=s.attributes[i]),t!=(s.attributes[i]=e)&&(s.trigger("change",s),s.trigger("change:"+i,s,e)))})},getset:function(e,t,s,i){a.get(e,t,s),a.set(e,t,i)},FlagableCollection:function(l){l.model.active_flags;c.each(l.model.active_flags,function(e){a.FlagMethod(l,e)}),l.by_flag=function(t){return l.filter(function(e){return e.has_flag(t)})},l._check_models_param=function(e){return e=c.isUndefined(e)?this.models:e,e=c.isNull(e)?[]:e,e=c.isArray(e)?e:[e]},l.set_flag=function(e,t){t=l._check_models_param(t);var s=l.by_flag(e),i=c.sortBy(t,i);!1===c.isEqual(s,t)&&l.add_flag(e,t,!0)},l.add_flag=function(t,e,s,i){s=void 0!==s&&s;var n=l.by_flag(t);if(e=l._check_models_param(e),(0!=n.length||0!=e.length)&&c.isObject(e)){var r=c.union(e,s?[]:n),o=c.difference(n,r);c.difference(r,n);l.remove_flag(t,o,i),c.each(e,function(e){e.add_flag(t,i)})}},l.remove_flag=function(t,e,s){e=l._check_models_param(e),c.each(e,function(e){e.remove_flag(t,s)})}},Flagable:function(e){e.get("flags")||e.set("flags",[]),a.get(e,"flags"),e.add_flag=function(e,t){this.has_flag(e)||(this.set("flags",c.union(this.flags,[e]),{silent:!0}),t&&t.silent||(this.trigger("addflag",e,this),this.trigger("addflag:"+e,this)))},e.remove_flag=function(e,t){this.has_flag(e)&&(this.set("flags",c.without(this.flags,e),{silent:!0}),t&&t.silent||(this.trigger("rmflag",e,this),this.trigger("rmflag:"+e,this)))},e.has_flag=function(e){return this.flags||console.log(this),0<=this.flags.indexOf(e)}},FlagMethod:function(s,i){var e="add_"+i,t="set_"+i;a.assert(void 0===s[e]),a.assert(void 0===s[t]),s[t]=function(e){s.set_flag(i,e,!0)},s[e]=function(e,t){s.add_flag(i,e,t)}},SortableCollection:function(t,e,s,i){a.assert(c.isString(s)),a.assert(c.isObject(e)),t.sortables=new l.Collection([],{model:a.Sortable}),a.FlagableCollection(t.sortables),c(e).each(function(e){t.sortables.add(new a.Sortable(e))}),t.listenTo(t.sortables,"change:selected change:reversed",function(e){t.comparator=e.get_comparator(),t.sort()}),console.log(t.sortables);var n=t.sortables.findWhere({field:s});return a.assert(n,"invalid default_key ("+s+")"),n.select(),t.sort_reverse&&n.reverse(),t.comparator=n.get_comparator(),t}};a.Sortable=l.Model.extend({defaults:{field:"",type:"",label:null},comparators:{alpha:function(s){return function(e,t){return e.get(s).localeCompare(t.get(s))}},numeric:function(s){return function(e,t){return e.get(s)-t.get(s)==0?0:0<e.get(s)-t.get(s)?1:-1}}},initialize:function(e,t){a.Flagable(this),a.get(this,"field"),a.get(this,"type"),a.get(this,"selected",function(){return this.has_flag("selected")}),a.get(this,"reversed",function(){return this.has_flag("reversed")}),this.listenTo(this,"addflag:selected rmflag:selected",function(){this.collection.trigger("change:selected",this),this.collection.trigger("change")}),this.listenTo(this,"addflag:reversed rmflag:reversed",function(){this.collection.trigger("change:reversed",this),this.collection.trigger("change")}),c.has(e,"label")&&e.label||this.set("label",e.field);this.get_comparator();return this},get_comparator:function(){var e=this.type,t=null;if(c.isFunction(e))t=e(this.field);else{if(!c.has(this.comparators,e))throw Error("comparator not found ! (type: '"+e+"')");t=this.comparators[e](this.field)}if(this.reversed){var s=t;t=function(e,t){return s(t,e)}}return t},select:function(){this.selected||(c(this.collection.by_flag("selected")).each(function(e){e.remove_flag("selected"),e.reversed&&e.remove_flag("reversed")}),this.add_flag("selected"))},reverse:function(){this.reversed||this.add_flag("reversed")},toggle_reverse:function(){this.reversed?this.remove_flag("reversed"):this.add_flag("reversed")}},{active_flags:["selected","reversed"]}),a.DocList=l.Collection.extend({model:a.Doc,initialize:function(e,t){c(this).bindAll("_set_sort_key","_set_sort_reverse","_set_sortables","_get_sort_key","_get_sort_reverse","_get_sortables"),t=t||{},a.get(this,"selected",function(){return this.has_flag("selected")});var s=t.sort_key||"title",i=t.sort_reverse||!1,n=t.sortables||[];this.model&&(a.FlagableCollection(this),a.SortableCollection(this,n,s,i))},_set_sort_key:function(e){var t=this.sort_key;this._sort_key=e,t!=this.sort_key&&(this.trigger("change"),this.trigger("change:sort_key"))},_get_sort_key:function(){return this._sort_key},_set_sort_reverse:function(e){var t=this.sort_reverse;this._sort_reverse=e,t!=this.sort_reverse&&(this.trigger("change"),this.trigger("change:sort_reverse"))},_get_sort_reverse:function(){return this._sort_reverse},_set_sortables:function(e){var t=this.sortables;this._sortables=e,t!=this.sortables&&(this.trigger("change"),this.trigger("change:sort_reverse"))},_get_sortables:function(){return this._sortables},select:function(e){e.select(),this.trigger("change:selected")},clear_selection:function(){this.set_selected(null),options&&options.silent||this.trigger("change:selected"),this.trigger("change:selected")},unselect:function(e){e.remove_flag("selected"),this.trigger("change:selected")}}),a.Doc=l.Model.extend({defaults:{docnum:null,selected:!1,clusters:null},idAttribute:"docnum",initialize:function(e,t){a.get(this,"docnum"),a.get(this,"selected",function(){return this.has_flag("selected")}),a.getset(this,"clusters"),this.clusters={},a.Flagable(this),a.assert(null!==this.docnum,"Document should have a docnum")},select:function(){this.add_flag("selected")},toggle_select:function(){this.selected?this.remove_flag("selected"):this.add_flag("selected")}},{active_flags:["selected"]}),a.QueryModel=l.Model.extend({defaults:{cellist:null,query:"",loaded:!1},loaded_query:null,initialize:function(e,t){c.bindAll(this,"set_query","play_completed","query_updated"),a.get(this,"cellist"),a.get(this,"loaded"),a.get(this,"query"),a.set(this,"query",this.set_query),this.listenTo(this.cellist,"play:complete",this.play_completed),this.on("change:query",this.query_updated)},set_query:function(e){e=e.trim(),console.log("set_query",e),this.set("query",e)},query_updated:function(){this.query!==this.loaded_query?this.set("loaded",!1):this.set("loaded",!0)},play_completed:function(e){e.results.query!=this.query&&(this.query=e.results.query),this.loaded_query=this.query,this.set("loaded",!0)},validate:function(){return!0},play:function(){this.cellist.play()},export_for_engine:function(){return this.query}}),a.Option=l.Model.extend({defaults:{value:void 0,name:null,otype:{}},idAttribute:"name",initialize:function(e,t){var s=this;c.bindAll(this,"validate"),a.get(this,"name"),a.get(this,"otype"),a.get(this,"value"),a.set(this,"value",function(e){var t=s.validate(e);s.value!=t&&s.set("value",t)}),a.assert(null!==this.name,"Option should have a name"),a.assert(null!==e.otype,"(Option: "+this.name+") otype should not be 'null'")},is_default:function(){return c.isEqual(this.value,this.otype.default)},cast:function(e){var t=function(e){return e};return e&&""!=e&&("float"===this.otype.vtype&&(t=parseFloat),"int"===this.otype.vtype&&(t=parseInt),"Boolean"===this.otype.type&&(t=function(e){return 0<=[1,!0,"true","True","TRUE","1","yes"].indexOf(e)})),t(e)},parse:function(e){var t=this;return this.otype&&("float"!==this.otype.vtype&&"int"!==this.otype.vtype||(e=this.otype.multi?e.replace(/\s/g,"").split(",").filter(function(e){return e.length}).map(function(e){return t.cast(e)}):t.cast(e),c.isNaN(e)&&(e=""))),e},_validate_one:function(e){e=this.cast(e);var t=this.otype.choices;if(t&&c.indexOf(t,e)<0)throw new Error("invalid option value");return e},is_multi:function(){return this.otype.multi},validate:function(e){var t=this;if(this.is_multi()){var s=[];c.each(e,function(e){s.push(t._validate_one(e))}),e=s}else e=this._validate_one(e);return e}}),a.Options=l.Collection.extend({model:a.Option}),a.Component=l.Model.extend({idAttribute:"name",defaults:{name:null,selected:!1,doc:"",options:new a.Options},initialize:function(){a.get(this,"name"),a.get(this,"options"),a.get(this,"selected"),this.listenTo(this.options,"reset",this.optionsChanged),this.listenTo(this.options,"change",this.optionsChanged),a.assert(null!==this.name,"Component should have a name")},get_option:function(e){return this.options.where({name:e})[0]},set_option:function(e,t){this.get_option(e).value=t},parse:function(e,t){return e.options=new a.Options(e.options,{parse:!0}),e.default&&(e.selected=!0),e},optionsChanged:function(e){this.trigger("change",this,e),this.trigger("change:options",this,e)},changed_options:function(){var t=[];return c.each(this.options.models,function(e){e.is_default()||t.push(e)}),t},as_dict:function(e){void 0!==e&&null!=e||(e=!1);var t={name:this.name,selected:this.selected},s=e?this.changed_options():this.options.models;return 0<s.length&&(t.options={},c.each(s,function(e){t.options[e.name]=e.value})),t},set_state:function(e){for(var t in e)this.set_option(t,e[t])}}),a.Components=l.Collection.extend({model:a.Component}),a.Block=l.Model.extend({defaults:{name:"",components:new a.Components,required:!0,multiple:!1,args:null,returns:null},initialize:function(e){a.get(this,"components"),a.get(this,"selected",this._get_selected),a.get(this,"name"),a.get(this,"required"),a.get(this,"multiple"),a.get(this,"args"),a.get(this,"returns"),a.assert(null!==this.name,"Block should have a name"),a.assert(c.isNull(this.args)||c.isArray(this.args),"'args' should be null or an Array"),null===this.returns&&this.set("returns",this.name),this.listenTo(this.components,"reset",this.componentsChanged),this.listenTo(this.components,"change",this.componentsChanged),this.selection_default=c.map(this.selected,function(e){return e.name})},componentsChanged:function(e){this.trigger("change",this,e),this.trigger("change:components",this,e)},parse:function(e,t){return e.components=new a.Components(e.components,{parse:!0}),e},reset:function(){this.components.reset()},get_component:function(t){return c.find(this.components.models,function(e){return e.name==t})},_get_selected:function(){return this.components.where({selected:!0})},select:function(e){e.selected?this.required||(e.set("selected",!1),this.trigger("change"),this.trigger("change:selected")):(this.multiple||c.each(this.selected,function(e){e.set("selected",!1)}),e.set("selected",!0),this.trigger("change"),this.trigger("change:selected"))},unselect:function(e){e.selected&&(!this.required||this.multiple&&1<this.selected.length)&&(e.set("selected",!1),this.trigger("change"),this.trigger("change:selected"))},clear_selection:function(){var t=this;c.each(this.selected,function(e){t.unselect(e)})},validate:function(){},get_state:function(e){void 0!==e&&null!=e||(e=!1);var t=[];selections=e?this.selected:this.components.models;var s=c.isEqual(c.map(selections,function(e){return e.name}),this.selection_default);for(var i in selections){var n=selections[i],r=n.as_dict(e);e&&s&&!c.has(r,"options")||t.push(n.as_dict(e))}return t},set_state:function(e){var n=this;c.each(e,function(e){var t=e.name,s=e.options,i=n.get_component(t);i.set_state(s),e.selected&&n.select(i)})}}),a.Blocks=l.Collection.extend({model:a.Block}),a.Engine=l.Model.extend({defaults:{blocks:new a.Blocks,args:null,returns:null,needed_inputs:[]},initialize:function(e,t){var s=e.url;this.input_models={},this.url=s,this.play_url=s,a.get(this,"blocks"),a.get(this,"args"),a.get(this,"returns"),a.get(this,"needed_inputs"),this.listenTo(this.blocks,"change reset",this.blockChanged)},get_block:function(t){return c.find(this.blocks.models,function(e){return e.get("name")==t})},blockChanged:function(e){this._update_needed_inputs(),this.trigger("change",this,e),this.trigger("change:blocks",this,e)},_update_needed_inputs:function(){var e=[],t=[],s=this.blocks.models;for(var i in s){var n=s[i];if(0<n.selected.length){for(var r in n.args){var o=n.args[r];t.indexOf(o)<0&&e.indexOf(o)&&e.push(o)}t.push(n.returns)}}this.set({needed_inputs:e},{silent:!0})},parse:function(e,t){return console.log("Engine parse",e,t),(this.data=e).blocks=new a.Blocks(e.blocks,{parse:!0}),e},reset:function(e){e=this.parse(e),this.set(e)},get_state:function(e){void 0!==e&&null!=e||(e=!1);var t={},s=this.blocks.models;for(var i in s){var n=s[i],r=n.get_state(e);0<r.length&&(t[n.name]=r)}return t},set_state:function(e){var s=this;c.each(e,function(e,t){s.get_block(t).set_state(e)})},get_state_str:function(e){var t=this.get_state(e);return $.param(t)},set_state_str:function(e){var t=a.utils.deparam(e);this.set_state(t)},register_input:function(e,t){this.input_models[e]=t},play:function(i){var n=this,r=this.get_state(!0),o={};c.each(this.input_models,function(e,t,s){o[t]=e.export_for_engine()});o=c.extend(o,i);var e=c.extend({},o,{options:r});a.log("play",e),n.trigger("play:loading",o,r);e=JSON.stringify(e);l.ajax({url:n.play_url,method:"post",contentType:"application/json",data:e,success:function(e,t,s){e.meta&&e.meta.errors&&0<e.meta.errors.length?n.trigger("play:error",e,s):(console.log("play:success",e,i,r),n.trigger("play:success",e,i,r),n.trigger("play:complete",e,i,r))},error:function(e,t,s){n.trigger("play:error",{},e),n.trigger("play:complete",{},e)}})}});var t=l.Model.extend({IN:1,OUT:2,ALL:4,defaults:{gid:null,directed:!1,bipartite:!1},idAttribute:"gid",initialize:function(e,t){var s=this;if(this.edge_list={},this.nodetype_model=e.nodetype_model||n,this.nodetypes=new g([],{model:this.nodetype_model}),this.edgetype_model=e.edgetype_model||r,this.edgetypes=new g([],{model:this.edgetype_model}),this.properties||(this.properties=new l.Model),this.meta||(this.meta=new l.Model),a.get(this,"label",function(){return this.properties.get("name")}),this.urlRoot=e.urlRoot,this.urlRoot){this.on("change:gid",function(e){s.nodetypes.url=s.url()+"/nodetypes",s.nodetypes.reset(),s.nodetypes.fetch({remove:!1}),s.edgetypes.url=s.url()+"/edgetypes",s.edgetypes.reset(),s.edgetypes.fetch({remove:!1})}),this.nodetypes.on("add",function(e){e.urlRoot=s.url()+"/nodetype"}),this.edgetypes.on("add",function(e){e.urlRoot=s.url()+"/edgetype"})}this.vertex_model=e.vertex_model||o,this.vs=new a.Vertices([],{graph:this,model:this.vertex_model}),this.vs.reset([],{collection:this.vs});this.vs.on("add",function(e){e&&(e.collection=s.vs,void 0===e.id&&(e.id=s.vs.size()),e.id in s.edge_list||(s.edge_list[e.id]=[]))}),this.vs.on("remove",function(t){var e=s.es.filter(function(e){return e.get("source")==t.id||e.get("target")==t.id});s.es.remove(e),delete s.edge_list[t.id]}),this.edge_model=e.edge_model||u,this.es=new a.Edges([],{graph:this,model:this.edge_model}),this.es.reset([],{collection:this.es});this.es.on("add",function(e){e.collection=s.es,s.edge_list[e.get("source")].push(e),s.edge_list[e.get("target")].push(e)}),this.es.on("remove",function(e){s.edge_list[e.get("source")].splice(s.edge_list[e.get("source")].indexOf(e),1),s.edge_list[e.get("target")].splice(s.edge_list[e.get("target")].indexOf(e),1)}),a.FlagableCollection(this.vs),a.FlagableCollection(this.es),e.data&&this.reset(e.data)},url:function(){return this.urlRoot+this.id},parse:function(e,t){this.reset(e[this.id],t)},reset:function(e,t){a.debug("parse graph",e),e.nodetypes&&this.nodetypes.set({nodetypes:e.nodetypes},{merge:!0,remove:!1,parse:!0}),e.edgetypes&&this.edgetypes.set({edgetypes:e.edgetypes},{merge:!0,remove:!1,parse:!0}),e.properties&&this.properties.set(e.properties,{parse:!0}),e.meta&&this.meta.set(e.meta,{parse:!0}),t=t?c.clone(t):{},e.vs&&e.es&&(this.edge_list={},this.es.reset([],t),this.vs.reset([],t),t={parse:!0},this.vs.set(e.vs,t),this.es.set(e.es,t)),this.trigger("reset")},merge:function(e,t){a.debug("merge graph",e),e.nodetypes&&this.nodetypes.set({nodetypes:e.nodetypes},{remove:!1,parse:!0}),e.edgetypes&&this.edgetypes.set({edgetypes:e.edgetypes},{remove:!1,parse:!0}),e.meta&&this.meta.set(e.meta,{parse:!0}),e.properties&&this.properties.set(e.properties,{parse:!0}),this.vs.add(e.vs,{parse:!0}),this.es.add(e.es,{parse:!0}),this.trigger("merge")},get_edge_type:function(e){var t=this.edgetypes.get(e);if(t)return t},get_node_type:function(e){var t=this.nodetypes.get(e);if(t)return t},summary:function(){return{attrs:this.attributes,vcount:this.vcount(),ecount:this.ecount(),density:this.density(),v_attrs:this.attributes.v_attrs,e_attrs:this.attributes.e_attrs}},str:function(){return c.template("v:<%=vcount%>, e:<%=ecount%>,density:<%=density%>,\nv attrs:<%=v_attrs%>, \ne attrs:<%=e_attrs%>, ")(this.summary())},add_vertex:function(e){this.vs.add(e)},vcount:function(){return this.vs.length},add_edge:function(e){this.es.add(e)},is_loop:function(e){return c.map(e,function(e){return e.source===e.target})},ecount:function(){return this.es.length},incident:function(e,t,s){var i=this,n=[],r=e.id,o=void 0===t?this.ALL:t,l=void 0===s||s;return o==i.ALL?n=c.filter(i.edge_list[r],function(e){return!!l||!e.is_loop()}):o==i.IN?n=c.filter(i.edge_list[r],function(e){return!(e.source.id!=r||!l&&e.is_loop())}):o==i.OUT&&(n=c.filter(i.edge_list[r],function(e){return!(e.target.id!=r||!l&&e.is_loop())})),n},degree:function(e,t,s){return this.incident(e,t,s).length},neighbors:function(t,e,s){var i=this.incident(t,e,s);return c(i).map(function(e){return e.source!=t?e.source:e.target})},strength:function(e,t,s){var i=this.incident(e,t,s);return c.reduce(i,function(e,t){return e+t.weight},0)},select:function(l){var a={degree:1,strength:1};return c.filter(this.vs.models,function(e){for(var t in l){var s,i=l[t],n=t.split(":"),r=n[0],o=2==n.length?n[1]:"eq";if("_"==r.substring(0,1)?(method=r.slice(1),method in a&&(s=e[method]())):s=e.get(r),"eq"==o){if(!1===c.isEqual(s,i))return!1}else if("ne"==o){if(s==i)return!1}else if("lt"==o){if(s<i==!1)return!1}else if("gt"==o){if(i<s==!1)return!1}else if("le"==o){if(s<=i==!1)return!1}else if("ge"==o){if(i<=s==!1)return!1}else if("in"==o){if(-1===c.indexOf(i,s))return!1}else if("notin"==o&&-1!==c.indexOf(i,s))return!1}return!0})},random_vertex:function(){var e,t,s=this.es.at((e=0,t=this.es.size()-1,Math.floor(Math.random()*(t-e+1))+e));return.5<Math.random()?s.source:s.target},density:function(){return 2*this.es.length/(this.vs.length*(this.vs.length-1))},adjacency:function(){function e(){return 0}var t=[],s=0;for(s=this.vcount(),i=0;i<s;i++)t.push(c.range(s).map(e));for(s=this.ecount(),i=0;i<s;i++){var n=this.es[i];t[n.source][n.target]=n.weight}this.adjacency=t}}),s=l.Model.extend({idAttribute:"uuid",defaults:{name:"",count:0,description:"",type_attributes:{},properties:new a.Options,material:{}},get_property:function(e){return this.properties.where({name:e})[0]},add_property:function(e,t){},delete_property:function(e,t){},parse:function(e,t){var s=[];for(k in e.properties)s.push({name:k,otype:e.properties[k]});return{type_attributes:e.type_attributes,properties:new a.Options(s,{parse:!0}),name:e.name,description:e.description||"",uuid:e.uuid}},toString:function(){return this.get("name")},toJSON:function(e){var t=c.pick(this.attributes,"name","description","uuid","type_attributes"),s=this.get("properties").models,i={};for(var n in s){var r=s[n];""!=r.get("name")&&(i[r.get("name")]=r.get("otype"))}return t.properties=i,t}}),n=s.extend({initialize:function(e,t){a.get(this,"count"),a.get(this,"name"),a.get(this,"properties"),a.get(this,"type_attributes",function(){return this.get("type_attributes")}),a.get(this,"label",function(){var e=this.get("name");return void 0===e?"":e});var s=this;this.on("sync",function(e,t,s){l.trigger("nodetype:save",this,t,s)}),this.listenTo(this.attributes.properties,"change",function(){s.trigger("change:properties",s.attributes.properties)})},parse_label:function(){var e=this.label,t={};return t.label=e,t.family=0<=e.indexOf("/")?e.substring(0,e.indexOf("/")):"",t.name=0<e.indexOf("/")?e.substring(e.indexOf("/")):e,t}}),r=s.extend({initialize:function(e,t){a.get(this,"name"),a.get(this,"count"),a.get(this,"type_attributes",function(){return this.get("type_attributes")}),a.get(this,"properties"),a.get(this,"label",function(){var e=this.get("name");return void 0===e?"":e}),this.on("sync",function(e,t,s){l.trigger("edgetype:save",this,t,s)})}}),o=l.Model.extend({idAttribute:"uuid",defaults:{uuid:"",nodetype:"",label:"",color:[0,0,0],coords:[0,0,0]},initialize:function(e,t){var i=this;a.get(this,"graph",function(){return null!=i.collection?i.collection.graph:null}),a.get(this,"type",function(){return this.nodetype}),a.get(this,"nodetype",function(){return i.graph?i.graph.get_node_type(i.get("nodetype")):null}),a.get(this,"properties",function(){return i.get("properties")}),this.properties||this.set("properties",new l.Model),a.get(this,"label",function(){var e=i.properties.get("label");return void 0===e?"":e}),a.get(this,"formatted_label",this.format_label),this.clusters={},a.getset(i,"color"),this.on("sync",function(e,t,s){l.trigger("node:save",i,t,s)}),this.on("change:cl_color",function(e){e.set("color",e.get("cl_color"))}),this.on("change",function(e){e._neighbors=null}),a.Flagable(this),c.bindAll(this,"degree","format_label","neighbors","strength")},getHexColor:function(){return 0},format_label:function(e){var t=this.label;return e&&(t=t.substring(0,e)),[{form:t,css:".normal-font"}]},degree:function(e,t){return this.graph.degree(this,e,t)},strength:function(e,t){return this.graph.strength(this,e,t)},incident:function(e,t){return this.graph.incident(this,e,t)},neighbors:function(e,t){return this.graph.neighbors(this,e,t)}},{active_flags:[]}),u=l.Model.extend({idAttribute:"uuid",defaults:{},constructor:function(){l.Model.apply(this,arguments);var t=this;a.get(this,"graph",function(){return null!=t.collection?t.collection.graph:null}),a.get(this,"type",function(){return t.edgetype}),a.get(this,"edgetype",function(){return t.graph?t.graph.get_edge_type(t.get("edgetype")):null}),a.get(this,"source",function(){return t.graph?t.graph.vs.get(t.get("source")):null}),a.get(this,"target",function(){return t.graph?t.graph.vs.get(t.get("target")):null}),a.get(this,"weight",function(){return t.graph?t.properties.get("weight"):1}),a.get(this,"sym",this.sym),a.get(this,"properties",function(){return t.get("properties")}),a.get(this,"label",function(){var e=t.properties.get("label");return null!=e&&0!=e.length||!t.edgetype?e:t.edgetype.name}),this.properties||this.set("properties",new l.Model),a.Flagable(this),this.on("sync",function(e,t,s){l.trigger("edge:save",e,t,s)})},str:function(){return"("+this.get("s")+","+this.get("t")+")  "+this.source.label+"--\x3e"+this.target.label+","+c.map(this.attributes,function(e,t){return t+": "+e}).join(", ")},tuple:function(){},sym:function(){return c(this.collection.models).findWhere({source:this.target,target:this.source})},is_loop:function(){return this.source.id==this.target.id}},{active_flags:[]}),h=l.Collection.extend({model:o,initialize:function(e,t){_this=this,t&&(this.graph=t.graph)},copy_attr:function(t,s,i){c.map(this.graph.vs.select({}),function(e){e.set(s,e.get(t),i)})},select:function(e){return this.graph.select(e)}}),d=l.Collection.extend({model:u,initialize:function(e,t){this.graph=t.graph},between:function(t,s,i){if(t&&s)return this.models.filter(function(e){return i?e.source==t&e.target==s:(e.source==t|e.source==s)&(e.target==t|e.target==s)})}}),g=l.Collection.extend({model:s,parse:function(e){return"nodetypes"in e?e.nodetypes:"edgetypes"in e?e.edgetypes:void 0}});a.Graph=t,a.Type=s,a.Vertices=h,a.Vertex=o,a.Edges=d,a.Edge=u,a.EdgeType=r,a.NodeType=n,a.ClusterLabel=l.Model.extend({idAttribute:"id",defaults:{label:"",score:1,role:"*",size:12,clusters:null},initialize:function(){a.get(this,"label"),a.get(this,"role"),a.get(this,"score"),a.getset(this,"clusters"),this.clusters={},c.bindAll(this,"_format_label"),a.get(this,"formatted_label",this._format_label),a.Flagable(this)},_format_label:function(){return[{form:this.get("label"),css:"normal"}]}},{active_flags:[]}),a.Cluster=l.Model.extend({defaults:{members:{},labels:[],misc:!1,selected:!1,color:[200,200,200]},initialize:function(e,t){var s=this;c.bindAll(s,"_compute_membership","_compute_colors"),a.get(this,"members"),a.getset(this,"labels"),a.get(this,"misc"),a.getset(this,"color"),a.get(this,"selected",function(){return s.has_flag("selected")}),this.listenTo(this,"addflag:selected rmflag:selected",function(){s.collection.trigger("change:selected")}),a.Flagable(this)},is_misc:function(){return this.misc},select:function(e){e?this.collection.set_selected([this]):this.add_flag("selected")},toggle_select:function(e){var t=this.collection.selected.length;this.selected?e&&2<=t?this.collection.set_selected([this]):this.remove_flag("selected"):this.select(e)},some_selected:function(){return this.selected||this.collection.by_flag("selected")},_compute_membership:function(){var s=this,i=this.collection.clustering.cid;c(s.members).each(function(e){e.each(function(e){var t={cluster:s};e.clusters[i]?e.clusters[i].push(t):e.clusters[i]=[t],e.trigger("change:clusters"),e.trigger("change:clusters:"+i)})})},_compute_colors_old:function(){var e=this.collection.length,t=this.collection.clustering.get("color_value"),s=this.collection.clustering.get("color_saturation"),i=this.collection.indexOf(this),n=[99,99,99];!1===this.misc&&(n=a.utils.hsvToRgb(i/e*360|0,s,t)),this.color=n},_compute_colors:function(e){if(!0!==this.misc){this.collection.length;var t=this.collection.clustering.get("color_value"),s=this.collection.clustering.get("color_saturation"),i=(this.collection.indexOf(this),[0,0,0]),n=i,r=0,o={};this.members.vs.each(function(e){var t=e.get("cl_color");s_last_node_cl_color=t.toString(),o[s_last_node_cl_color]?o[s_last_node_cl_color]++:o[s_last_node_cl_color]=1,o[s_last_node_cl_color]>r&&(r=o[s_last_node_cl_color],n=t)}),cluster_color=n;for(var l=0;c.isEqual(cluster_color,i)|-1!=e.indexOf(cluster_color.toString());)cluster_color=a.utils.hsvToRgb(222.23*l%360|0,s,t),l++;e.push(cluster_color.toString()),this.color=cluster_color}else this.color=[99,99,99]}},{active_flags:["selected"]}),a.ClustersList=l.Collection.extend({model:a.Cluster,initialize:function(e,t){_this=this,a.get(this,"selected",function(){return this.by_flag("selected")}),a.assert(t.clustering,"options.clustering is needed"),this.clustering=t.clustering,this.on("add remove reset",function(){var t=[];this.each(function(e){e._compute_membership(),e._compute_colors(t)})}),this.listenTo(this.clustering,"change:color_saturation change:color_value",function(){var t=[];this.each(function(e){e._compute_colors(t)})})},some_selected:function(){return 0<this.by_flag("selected").length},select:function(e,t){e.select(t),this.trigger("change:selected",e)},clear_selection:function(e){this.set_selected(null),e&&e.silent||this.trigger("change:selected")},unselect:function(e){e.remove_flag("selected"),this.trigger("change:selected")},has_misc:function(){return c.some(this.models,function(e){return e.is_misc()})},cluster:function(e){return this.at(e)}}),a.Clustering=l.Model.extend({defaults:{clusters:null,members:{},color_value:80,color_saturation:40},ClusterLabelModel:a.ClusterLabel,ClusterModel:a.Cluster,ClustersCollection:a.ClustersList,initialize:function(e,t){e=e||{},a.getset(this,"members"),a.getset(this,"clusters"),a.getset(this,"color_value"),a.getset(this,"color_saturation"),this.ClusterLabelModel=e.ClusterLabelModel||this.ClusterLabelModel,this.ClusterModel=e.ClusterModel||this.ClusterModel,this.ClustersCollection=e.ClustersCollection||this.ClustersCollection;var s={clustering:this,model:this.ClusterModel},i=new this.ClustersCollection([],s);this.set("clusters",i),a.FlagableCollection(this.clusters)},reset:function(e,t){var i=this,s=c(e).clone();t&&t.members&&c.extend(this.members,t.members);var n=this.members;c.map(s.clusters,function(e){e.misc=!1}),-1<s.misc&&(s.clusters[s.misc].misc=!0),cluster_models=[],c.each(s.clusters,function(s){cluster_members={},c.each(n,function(t,e){source_clone=t.source.clone(),source_filtered=source_clone.filter(function(e){return c(s[t.id_field]).contains(e.id)}),source_clone.reset(source_filtered,{silent:!0}),cluster_members[e]=source_clone}),cluster_models.push(new i.ClusterModel({members:cluster_members,misc:s.misc}))}),this.clusters.reset(cluster_models),this.trigger("reset")},set_labels:function(s,e){this.clusters.each(function(e,t){e.labels=s.labels[t]})}}),a.utils={},a.utils.asEvents=function(s){var i;return{on:function(e,t){if(i)throw new Error("this is one off wrapper");s.addEventListener(e,t,!1),i=[e,t]},off:function(){s.removeEventListener.apply(s,i)}}};function f(e){return(e="0"+e.toString(16)).substring(e.length-2)}return a.utils.css_color=function(e){var t="#000000";return e&&(t="#"+c.map(e,f).join("")),t},a.utils.css_gradient=function(e,t){return"-webkit-linear-gradient("+a.utils.css_color(e)+","+a.utils.css_color(t)+")"},a.utils.color_darker=function(e){var t=a.utils.rgbToHsv(e[0],e[1],e[2]);return a.utils.hsvToRgb(t[0],t[1],60)},a.utils.hsvToRgb=function(e,t,s){t/=100,s/=100;var i=Math.floor(e/60%6),n=e/60-i,r=s*(1-t),o=s*(1-n*t),l=s*(1-(1-n)*t),a=[];switch(i){case 0:a=[s,l,r];break;case 1:a=[o,s,r];break;case 2:a=[r,s,l];break;case 3:a=[r,o,s];break;case 4:a=[l,r,s];break;case 5:a=[s,r,o]}return[Math.min(255,256*a[0]|0),Math.min(255,256*a[1]|0),Math.min(255,256*a[2]|0)]},a.utils.rgbToHsv=function(e,t,s){var i,n=e/255,r=t/255,o=s/255,l=Math.min(Math.min(n,r),o),a=Math.max(Math.max(n,r),o);return a==l?i=0:a==n?i=(r-o)/(a-l)*60%360:a==r?i=(o-n)/(a-l)*60+120:a==o&&(i=(n-r)/(a-l)*60+240),i<0&&(i+=360),[0|i,100*(0===a?0:1-l/a)|0,100*a|0]},a.utils.addCSSRule=function(e,t,s){for(var i,n,r=0;r<document.styleSheets.length;r++){n=(i=document.styleSheets[r]).cssRules||i.rules;for(var o=e.toLowerCase(),l=0,a=n.length;l<a;l++)if(n[l].selectorText&&n[l].selectorText.toLowerCase()==o){if(null!==s)return void(n[l].style[t]=s);i.deleteRule?i.deleteRule(l):i.removeRule?i.removeRule(l):n[l].style.cssText=""}}(i=document.styleSheets[0]||{}).insertRule?(n=i.cssRules||i.rules,i.insertRule(e+"{ "+t+":"+s+"; }",n.length)):i.addRule&&i.addRule(e,t+":"+s+";",0)},a.utils.deparam=function(e,c){var u={},h={true:!0,false:!1,null:null};return $.each(e.replace(/\+/g," ").split("&"),function(e,t){var s,i=t.split("="),n=decodeURIComponent(i[0]),r=u,o=0,l=n.split("]["),a=l.length-1;if(a=/\[/.test(l[0])&&/\]$/.test(l[a])?(l[a]=l[a].replace(/\]$/,""),(l=l.shift().split("[").concat(l)).length-1):0,2===i.length)if(s=decodeURIComponent(i[1]),c&&(s=s&&!isNaN(s)?+s:"undefined"===s?void 0:void 0!==h[s]?h[s]:s),a)for(;o<=a;o++)r=r[n=""===l[o]?r.length:l[o]]=o<a?r[n]||(l[o+1]&&isNaN(l[o+1])?{}:[]):s;else $.isArray(u[n])?u[n].push(s):void 0!==u[n]?u[n]=[u[n],s]:u[n]=s;else n&&(u[n]=c?void 0:"")}),u},a.utils.piwikTrackCurrentUrl=function(){c.isUndefined(window._paq)||"function"!=typeof window._paq.push||(window._paq.push(["setCustomUrl",window.location.href]),window._paq.push(["trackPageView"]))},a});