/*!  08-06-2018 */
!function(a,b){"function"==typeof define&&define.amd?define(["underscore","backbone","cello","tween","threejs","pdgconst"],function(c,d,e,f,g,h){return b(a,c,d,e,f,g,h)}):a.Gviz=b(a,_,Backbone,Cello,TWEEN,THREE,Const)}(this,function(a,c,d,e,f,h,j){h.TrackballControls=function(a,b){function c(a){n.enabled!==!1&&(window.removeEventListener("keydown",c),s=r,r===o.NONE&&(a.keyCode!==n.keys[o.ROTATE]||n.noRotate?a.keyCode!==n.keys[o.ZOOM]||n.noZoom?a.keyCode!==n.keys[o.PAN]||n.noPan||(r=o.PAN):r=o.ZOOM:r=o.ROTATE))}function d(a){n.enabled!==!1&&(r=s,window.addEventListener("keydown",c,!1))}function e(a){n.enabled!==!1&&(_MOUSEDOWN=!0,a.preventDefault(),a.stopPropagation(),r===o.NONE&&(r=a.button),r!==o.ROTATE||n.noRotate?r!==o.ZOOM||n.noZoom?r!==o.PAN||n.noPan||(C.copy(H(a.pageX,a.pageY)),D.copy(C)):(y.copy(H(a.pageX,a.pageY)),z.copy(y)):(v.copy(I(a.pageX,a.pageY)),u.copy(v)),document.addEventListener("mousemove",f,!1),document.addEventListener("mouseup",g,!1),n.dispatchEvent(F))}function f(a){n.enabled!==!1&&(a.preventDefault(),a.stopPropagation(),r!==o.ROTATE||n.noRotate?r!==o.ZOOM||n.noZoom?r!==o.PAN||n.noPan||D.copy(H(a.pageX,a.pageY)):z.copy(H(a.pageX,a.pageY)):(u.copy(v),v.copy(I(a.pageX,a.pageY))))}function g(a){n.enabled!==!1&&(_MOUSEDOWN=!1,a.preventDefault(),a.stopPropagation(),r=o.NONE,document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",g),n.dispatchEvent(G))}function i(a){if(n.enabled!==!1){a.preventDefault(),a.stopPropagation();var b=0;a.wheelDelta?b=a.wheelDelta/40:a.detail&&(b=-a.detail/3),y.y+=.01*b,n.dispatchEvent(F),n.dispatchEvent(G)}}function j(a){if(n.enabled!==!1){switch(a.touches.length){case 1:r=o.TOUCH_ROTATE,v.copy(I(a.touches[0].pageX,a.touches[0].pageY)),u.copy(v);break;case 2:r=o.TOUCH_ZOOM_PAN;var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY;B=A=Math.sqrt(b*b+c*c);var d=(a.touches[0].pageX+a.touches[1].pageX)/2,e=(a.touches[0].pageY+a.touches[1].pageY)/2;C.copy(H(d,e)),D.copy(C);break;default:r=o.NONE}n.dispatchEvent(F)}}function k(a){if(n.enabled!==!1)switch(a.preventDefault(),a.stopPropagation(),a.touches.length){case 1:u.copy(v),v.copy(I(a.touches[0].pageX,a.touches[0].pageY));break;case 2:var b=a.touches[0].pageX-a.touches[1].pageX,c=a.touches[0].pageY-a.touches[1].pageY;B=Math.sqrt(b*b+c*c);var d=(a.touches[0].pageX+a.touches[1].pageX)/2,e=(a.touches[0].pageY+a.touches[1].pageY)/2;D.copy(H(d,e));break;default:r=o.NONE}}function l(a){if(n.enabled!==!1){switch(a.touches.length){case 1:u.copy(v),v.copy(I(a.touches[0].pageX,a.touches[0].pageY));break;case 2:A=B=0;var b=(a.touches[0].pageX+a.touches[1].pageX)/2,c=(a.touches[0].pageY+a.touches[1].pageY)/2;D.copy(H(b,c)),C.copy(D)}r=o.NONE,n.dispatchEvent(G)}}function m(a){a.preventDefault()}var n=this,o={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=a,this.domElement=void 0!==b?b:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=5e3,this.keys=[65,83,68],this.AUTO_ROTATE=!1,this.autoRotateSpeed=.005,this.target=new h.Vector3;var p=1e-6,q=new h.Vector3,r=o.NONE,s=o.NONE,t=new h.Vector3,u=new h.Vector2,v=new h.Vector2,w=new h.Vector3,x=0,y=new h.Vector2,z=new h.Vector2,A=0,B=0,C=new h.Vector2,D=new h.Vector2;_MOUSEDOWN=!1,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var E={type:"change"},F={type:"start"},G={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var a=this.domElement.getBoundingClientRect(),b=this.domElement.ownerDocument.documentElement;this.screen.left=a.left+window.pageXOffset-b.clientLeft,this.screen.top=a.top+window.pageYOffset-b.clientTop,this.screen.width=a.width,this.screen.height=a.height}},this.handleEvent=function(a){"function"==typeof this[a.type]&&this[a.type](a)};var H=function(){var a=new h.Vector2;return function(b,c){return a.set((b-n.screen.left)/n.screen.width,(c-n.screen.top)/n.screen.height),a}}(),I=function(){var a=new h.Vector2;return function(b,c){return a.set((b-.5*n.screen.width-n.screen.left)/(.5*n.screen.width),(n.screen.height+2*(n.screen.top-c))/n.screen.width),a}}();this.rotateCamera=function(){var a,b=new h.Vector3,c=new h.Quaternion,d=new h.Vector3,e=new h.Vector3,f=new h.Vector3,g=new h.Vector3;return function(){this.AUTO_ROTATE&&!_MOUSEDOWN&&(v.x=u.x+this.autoRotateSpeed),g.set(v.x-u.x,v.y-u.y,0),a=g.length(),a?(t.copy(n.object.position).sub(n.target),d.copy(t).normalize(),e.copy(n.object.up).normalize(),f.crossVectors(e,d).normalize(),e.setLength(v.y-u.y),f.setLength(v.x-u.x),g.copy(e.add(f)),b.crossVectors(g,t).normalize(),a*=n.rotateSpeed,c.setFromAxisAngle(b,a),t.applyQuaternion(c),n.object.up.applyQuaternion(c),w.copy(b),x=a):!n.staticMoving&&x&&(x*=Math.sqrt(1-n.dynamicDampingFactor),t.copy(n.object.position).sub(n.target),c.setFromAxisAngle(w,x),t.applyQuaternion(c),n.object.up.applyQuaternion(c)),u.copy(v)}}(),this.zoomCamera=function(){var a;r===o.TOUCH_ZOOM_PAN?(a=A/B,A=B,t.multiplyScalar(a)):(a=1+(z.y-y.y)*n.zoomSpeed,1!==a&&a>0&&(t.multiplyScalar(a),n.staticMoving?y.copy(z):y.y+=(z.y-y.y)*this.dynamicDampingFactor))},this.panCamera=function(){var a=new h.Vector2,b=new h.Vector3,c=new h.Vector3;return function(){a.copy(D).sub(C),a.lengthSq()&&(a.multiplyScalar(t.length()*n.panSpeed),c.copy(t).cross(n.object.up).setLength(a.x),c.add(b.copy(n.object.up).setLength(a.y)),n.object.position.add(c),n.target.add(c),n.staticMoving?C.copy(D):C.add(a.subVectors(D,C).multiplyScalar(n.dynamicDampingFactor)))}}(),this.checkDistances=function(){n.noZoom&&n.noPan||(t.lengthSq()>n.maxDistance*n.maxDistance&&(n.object.position.addVectors(n.target,t.setLength(n.maxDistance)),y.copy(z)),t.lengthSq()<n.minDistance*n.minDistance&&(n.object.position.addVectors(n.target,t.setLength(n.minDistance)),y.copy(z)))},this.update=function(){t.subVectors(n.object.position,n.target),n.noRotate||n.rotateCamera(),n.noZoom||n.zoomCamera(),n.noPan||n.panCamera(),n.object.position.addVectors(n.target,t),n.checkDistances(),n.object.lookAt(n.target),q.distanceToSquared(n.object.position)>p&&(n.dispatchEvent(E),q.copy(n.object.position))},this.reset=function(){r=o.NONE,s=o.NONE,n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.up.copy(n.up0),t.subVectors(n.object.position,n.target),n.object.lookAt(n.target),n.dispatchEvent(E),q.copy(n.object.position)},this.dispose=function(){this.domElement.removeEventListener("contextmenu",m,!1),this.domElement.removeEventListener("mousedown",e,!1),this.domElement.removeEventListener("mousewheel",i,!1),this.domElement.removeEventListener("DOMMouseScroll",i,!1),this.domElement.removeEventListener("touchstart",j,!1),this.domElement.removeEventListener("touchend",l,!1),this.domElement.removeEventListener("touchmove",k,!1),document.removeEventListener("mousemove",f,!1),document.removeEventListener("mouseup",g,!1),document.removeEventListener("mouseout",g,!1),window.removeEventListener("keydown",c,!1),window.removeEventListener("keyup",d,!1)},this.domElement.addEventListener("contextmenu",m,!1),this.domElement.addEventListener("mousedown",e,!1),this.domElement.addEventListener("mousewheel",i,!1),this.domElement.addEventListener("DOMMouseScroll",i,!1),this.domElement.addEventListener("touchstart",j,!1),this.domElement.addEventListener("touchend",l,!1),this.domElement.addEventListener("touchmove",k,!1),window.addEventListener("keydown",c,!1),window.addEventListener("keyup",d,!1),this.handleResize(),this.update()},h.TrackballControls.prototype=Object.create(h.EventDispatcher.prototype),h.TrackballControls.prototype.constructor=h.TrackballControls;var h=window.THREE,f=window.TWEEN,l=e.utils.hsvToRgb,m=e.utils.rgbToHsv,n=function(a,b,c){c|=1;var d=-1,e=0,f=a.split(" ");f.length;for(var g in f){if(g=parseInt(g),e+=f[g].length,d=g,e+g>b&&d>=c)break;d+=1}return[f.slice(0,d).join(" "),f.slice(d).join(" ")]},o=function(a,b){var c=parseInt(/([0-9]*)px/.exec(a)[1]);return c+=parseInt(b),a.replace(/[0-9]+(.*)/,c+"$1")},p=function(a,b,d){if(c.isArray(d)&&3==d.length)style="rgb("+d.join(",")+")";else if(c.isArray(d)&&2==d.length){style=a.createLinearGradient(-.5,-.5,.5,.5);for(var e in d)style.addColorStop(e,d[e])}else if("gradient:"==d.substring(0,9)){var f=new h.Color(d.substring(9)),g=m(f.r,f.g,f.b),i=l(g[0],g[1],60),j="rgb("+i.join(",")+")";style=a.createLinearGradient(-.5,-.5,.5,.5),style.addColorStop(0,j),style.addColorStop(1,f.getStyle())}else style=d;a[b]=style},q=function(a,b){var c=[],d=[],e={},f="",g=[{form:a.label,css:".normal-font"}];if(a.format_label&&(g=a.format_label(b.textLength)),void 0===g)return[];g.length&&(e=g[0],f+=e.form);for(var h=b.line_max_length;g.length||f.length;){var i=n(f,h,1),j=i[0],k=i[1];k||(k=""),!j.length&&k.length&&(j=k,k=""),h-=j.length,h<=0&&(0==c.length?d.length>0&&c.push(d):d.length>0&&c.push(d),d=[],h=b.line_max_length),j&&j.length&&d.push({form:j,css:e.css}),k.length&&j.length?(c.push(d),f=k,h=b.line_max_length,d=[]):k.length<=h?(k.length&&(d.push({form:k,css:e.css}),k="",h-=k.length),0===h&&(c.push(d),d=[],h=line_max_length),g.length&&g.shift(),g.length?(e=g[0],f=e.form):f=""):f=k}return d.length&&c.push(d),c},r={Layout:{}};r.hexcolor=function(a){var b=c.map(a,function(a){return a/255});return new h.Color(b[0],b[1],b[2]).getHex()},r.csscolor=function(a){var b=c.map(a,function(a){return a/255});return new h.Color(b[0],b[1],b[2]).getStyle()},r.DEFAULTS={show_nodes:!0,show_edges:!0,show_text:!0,show_images:!0,background_color:11184810,user_font_size:3,user_vtx_size:1,initial_size:10,initial_z:1400,raycaster_precision:2,adaptive_zoom:!1,use_material_transitions:!0,force_position_no_delay:!1,node_material_transition_delay:100,edge_material_transition_delay:200,auto_rotate:!1,debug:!1},r.ThreeViz=d.View.extend({initialize:function(a){var b=this;attrs=c.extend({},r.DEFAULTS,a),attrs.el||(attrs.el="#vz_threejs_main"+Math.round(1e4*Math.random())),this.show_nodes=attrs.show_nodes,this.show_edges=attrs.show_edges,this.show_images=attrs.show_images,this.show_text=attrs.show_text,this.DISPLAY_EDGE_LABEL=attrs.DISPLAY_EDGE_LABEL||!0,this.DISPLAY_ARROW_INIT=attrs.DISPLAY_ARROW_INIT||!1,this.DISPLAY_ARROW_END=attrs.DISPLAY_ARROW_END||!1,this.AUTO_FOCUS=attrs.AUTO_FOCUS,this.ENABLE_FOG=attrs.ENABLE_FOG,this.auto_rotate=attrs.auto_rotate||!1,this.initial_size=attrs.initial_size,this.initial_z=attrs.initial_z,this.user_vtx_size=attrs.user_vtx_size,this.user_font_size=attrs.user_font_size,this.background_color=attrs.background_color,this.render_node=attrs.render_node||r.ThreeVizHelpers.render_node,this.wnode_scale=attrs.wnode_scale||r.ThreeVizHelpers.wnode_scale,this.raycaster_precision=attrs.raycaster_precision,this.force_position_no_delay=attrs.force_position_no_delay,this.edge_materials={},this.node_materials={},this.use_material_transitions=attrs.use_material_transitions,this.node_material_transition_delay=attrs.node_material_transition_delay,this.edge_material_transition_delay=attrs.edge_material_transition_delay;var d=function(a,d){c.each(a,function(a){var e=c.keys(a)[0];b.add_material(d,e,a[e])})};return d(r.ThreeVizHelpers.edge_materials,"edge"),d(r.ThreeVizHelpers.node_materials,"node"),attrs.materials&&(attrs.materials.node&&d(attrs.materials.node,"node"),attrs.materials.edge&&d(attrs.materials.edge,"edge")),this.adaptive_zoom=attrs.adaptive_zoom,this.debug=attrs.debug,this._width=attrs.width||-1,this._height=attrs.height||-1,e.get(this,"width",function(){var a=b.$el.width();return a<=0&&(a=$(window).width()),b._width>0?b._width:a}),e.get(this,"height",function(){var a=b.$el.height();return a<=0&&(a=$(window).height()),b._height>0?b._height:a}),this.clear_color=new h.Color(attrs.background_color),this._inited=!1,this.wnodes=[],this.wedges=[],this.wnidx={},this.weidx={},this.WINDOWVISIBLE=!0,this.MOUSEDOWN=!1,this.MOUSEHASMOVED=!1,this.ANIMATE=!1,this.intersected=null,this.program_factory=function(a){var c=b.render_node;return function(d){c(b,a,d)}},this},enable:function(){var a,b,d,f,g=this;new h.Vector2;a=new h.PerspectiveCamera(40,this.width/this.height,10,1e4),a.position.x=0,a.position.y=0,a.position.z=this.initial_z,d=new h.Scene,d.autoUpdate=!0,b=new h.TrackballControls(a,this.el),b.rotateSpeed=5,b.zoomSpeed=4,b.panSpeed=3,b.noZoom=!1,b.noPan=!1,b.staticMoving=!0,b.dynamicDampingFactor=.3,b.minDistance=50,b.autoRotateSpeed=.002,b.AUTO_ROTATE=this.auto_rotate,f=new r.GraphRenderer({antialias:!0}),f.sortObjects=!0,f.setSize(this.width,this.height),f.DISPLAY_EDGE=this.show_edges,f.DISPLAY_EDGE_LABEL=!0,f.DISPLAY_ARROW_INIT=!0,f.DISPLAY_ARROW_END=!0,f.ENABLE_FOG=!0,this.camera=a,this.controls=b,this.scene=d,this.renderer=f,this.changeFocusSpeed=1e3,this.changeCoordSpeed=800,this.fogDistance=800,c.bindAll(this,"animate","render","resize_rendering"),c.bindAll(this,"onMouseMove","onMouseUp","onMouseDown","onMouseOut","onDblClick"),this.listenTo(e.utils.asEvents(window),"focus",function(a){g.WINDOWVISIBLE=!0}),this.listenTo(e.utils.asEvents(window),"blur",function(a){g.WINDOWVISIBLE=!1}),this.listenTo(this.model,"change",function(){g.request_animation()}),this.listenTo(this.model.vs,"remove",function(a){g.stopListening(a,"change:coords")}),f.domElement.addEventListener("mousemove",this.onMouseMove,!1),f.domElement.addEventListener("mousedown",this.onMouseDown,!1),f.domElement.addEventListener("mouseout",this.onMouseOut,!1),f.domElement.addEventListener("mouseup",this.onMouseUp,!1),f.domElement.addEventListener("dblclick",this.onDblClick,!1);var i=function(a){g.request_animation(1e3)};f.domElement.addEventListener("mousewheel",i,!1),f.domElement.addEventListener("DOMMouseScroll",i,!1),f.domElement.addEventListener("touchstart",function(a){g.MOUSEDOWN=!0,g.request_animation()},!1),f.domElement.addEventListener("touchend",function(a){g.MOUSEDOWN=!1},!1);var j=f.domElement.className.split(" ").indexOf("pdg-renderer");return j<0&&(this.renderer.domElement.className+=" pdg-renderer"),this.el.appendChild(f.domElement),(this._width<0||this._height<0)&&this.listenTo(e.utils.asEvents(window),"resize",this.resize_rendering),this.set_clear_color(this.clear_color.getStyle()),this.renderer=f,this._inited=!0,this},set_clear_color:function(a){var b=new h.Color(a);this.background_style=b.getStyle(),this.renderer.setClearColor(b.getHex()),$(this.renderer.domElement).css("background-color",b.getStyle()),this.clear_color=b},resize_rendering:function(){if(this._inited){var a=this.width,b=this.height;this.controls.handleResize(),this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.request_animation()}},clean:function(){var a,b,d=this.scene.children,e=this.scene;for(b=d.length-1;b>=0;b--)a=d[b],c.has(a,"_type")&&e.remove(a);this.wnodes=[],this.wedges=[],this.wnidx={},this.weidx={},this.request_animation()},append_node:function(a){var b=this,c=new h.Sprite;b.wnidx[a.id]=c,c.position=new h.Vector3(0,0,0),c.scale.x=c.scale.y=b.wnode_scale(a),c._type="vertex",c._node=a,c._edges=[],c.program_material=b.get_material(b.node_materials,a),c.material=new h.SpriteCanvasMaterial({program:b.program_factory(c)}),b.listenTo(a,"change:coords",function(){b.setPosition(c.position,a.get("coords"),this.changeCoordSpeed,f.Easing.Elastic.OutIn)}),b.listenTo(a,"change:color",function(){c.material_needs_update=!0,b.request_animation()}),b.listenTo(a,"rmflag",function(){c.material_needs_update=!0,b.request_animation()}),b.listenTo(a,"addflag",function(){c.material_needs_update=!0,b.request_animation()}),b.wnodes.push(c),b.scene.add(c)},remove_node:function(a){var b=this.wnidx[a.id];this.scene.remove(b),delete this.wnidx[a.id],this.request_animation()},remove_edge:function(a){var b=this.weidx[a.id];this.scene.remove(b),delete this.weidx[a.id],console.log("gviz remove edge",a),this.request_animation()},append_edge:function(a){if(!(a.id in this.weidx)){var b=this,c=b.wnidx[a.source.id],d=b.wnidx[a.target.id];if(void 0===c||void 0===d)return void console.log("edge without source or target");var e=new h.Geometry;e.vertices.push(c.position.clone()),e.vertices.push(d.position.clone());var g=f.Easing.Circular.In,i=new h.LineBasicMaterial({}),j=new h.Line(e,i);j._type="edge",j._edge=a,b.set_line_material(j),this.weidx[a.id]=j,b.scene.add(j);var k=function(){e.computeBoundingSphere(),b.set_line_material(j)};b.listenTo(a.source,"change:coords",function(){a.collection&&b.setPosition(e.vertices[0],a.source.get("coords"),this.changeCoordSpeed,g,k)}),b.listenTo(a.target,"change:coords",function(){a.collection&&b.setPosition(e.vertices[1],a.target.get("coords"),this.changeCoordSpeed,g,k)}),b.listenTo(a,"rmflag",function(a,c){b.set_line_material(j),b.request_animation()}),b.listenTo(a,"addflag",function(a,c,d){b.set_line_material(j),b.request_animation()})}},add_material:function(a,b,c){return this.set_material(a,b,c)},set_material:function(a,b,d){var f=["node","edge"];e.assert(c.indexOf(f,a)>-1,["Wrong material type",f]),e.log("GViz: Adding material",a,b),b in this[a+"_materials"]?c.extend(this[a+"_materials"][b],d):this[a+"_materials"][b]=d},set_materials:function(a,b){_this=this;var d=["node","edge"];e.assert(c.indexOf(d,a)>-1,["Wrong material type",d]),c.each(b,function(b){var d=c.keys(b)[0];_this.set_material(a,d,b[d])})},get_material:function(a,b){var d=b.flags||{},e=c.filter(c.keys(a),function(a){return"."==a.substring(0,1)}),f=c.extend({},a.default),g=!0;e=c.sortBy(e,function(a){return a.split(".").length}),c.each(e,function(b){for(css_classes=c(b.split(".")).rest(1),g=!0,i=0;i<css_classes.length;i++)if(!c(d).contains(css_classes[i])){g=!1;break}g&&(f=c.extend(f,a[b]))});for(k in f){var h=f[k];if(c.isString(h)&&"get:"==h.substring(0,4)){var j=h.substring(4);h=b.get(j)}else if(c.isString(h)&&"prop:"==h.substring(0,5)){var j=h.substring(5);h=b.properties.get(j)}else if(c.isFunction(h))try{h=h(b)}catch(a){h=0}f[k]=h}return b.nodetype&&(f.text_lines=q(b,f)),null==f.shape&&(f.shape="circle"),f.id=b.id,f},set_node_material:function(a){var b=this.wnidx[a.id],c=this.get_material(this.node_materials,a),d={opacity:c.opacity,scale:c.scale,fontScale:c.fontScale};if(this.use_material_transitions&&this.node_material_transition_delay>0)c.opacity=b.program_material.opacity,c.scale=b.program_material.scale,c.fontScale=b.program_material.fontScale,tween=new f.Tween(c).to(d,this.node_material_transition_delay).start();else for(k in d)c[k]=d[k];b.program_material=c,b.material_needs_update=!1},set_line_material:function(a){var b=a._edge;if(null!=b){var d,e=this.get_material(this.edge_materials,b),g=null;c.isArray(e.color)&&2==e.color.length?(d=[new h.Color(e.color[0]),new h.Color(e.color[1])],g=h.VertexColors):d=new h.Color(e.color),a.material.linecap=e.linecap,a.material.linejoin=e.linejoin,a.material.lineType=e.lineType,a.material.dashSize=e.dashSize,a.material.gapSize=e.gapSize,a.material.vertexColors=g,a.geometry.colors=d,a.material.color=d,a.material.label_visible=e.label_visible,a.material.font=e.font,a.material.fontFillStyle=e.fontFillStyle,a.material.textAlign=e.textAlign,a.material.orientation_visible=e.orientation_visible;var i={opacity:e.opacity,linewidth:e.lineWidth};if(this.use_material_transitions&&this.edge_material_transition_delay>0)tween=new f.Tween(a.material).to(i,this.edge_material_transition_delay).start();else for(k in i)a.material[k]=i[k]}},setPosition:function(a,b,d,e,g){this.force_position_no_delay&&(d=0);var g=g||null,e=e||f.Easing.Circular.In,h={};if(c.isArray(b)?(3==b.length|b.push(0),h.x=1e3*b[0],h.y=1e3*b[1],h.z=1e3*b[2]):h=b,d)tween=new f.Tween(a).to(h,d).easing(e).onComplete(g).start();else for(k in h)a[k]=h[k]},increase_vertex_size:function(){this.user_vtx_size=Math.min(25,1.5*this.user_vtx_size),this.request_animation(100)},decrease_vertex_size:function(){this.user_vtx_size=Math.max(.1,this.user_vtx_size/1.5),this.request_animation(100)},increase_font_size:function(){this.user_font_size=Math.min(25,this.user_font_size+1),this.request_animation(100)},decrease_font_size:function(){this.user_font_size=Math.max(-5,this.user_font_size-1),this.request_animation(100)},collapse:function(a,b,c){if(this.scene.children.length>0){a|=0,c|=0;for(var b=b||f.Easing.Circular.In,d={x:0,y:0,z:0},e=0;e<this.wnodes.length;e++){var g=this.wnodes[e];this.setPosition(g.position,d,a,b,c)}for(var e=0;e<this.wedges.length;e++){var h=this.wedges[e];this.setPosition(h.geometry.vertices[0],d,a,b,c),this.setPosition(h.geometry.vertices[1],d,a,b,c)}this.request_animation()}},setFocus:function(a){null==a&&(a=new h.Vector3(0,0,0)),tween=new f.Tween(this.controls.target).to(a,this.changeFocusSpeed).start()},request_animation:function(a){if(a){this.ANIMATE=!0,this._animate_timeout_id&&(clearTimeout(this._animate_timeout_id),this._animate_timeout_id=null);var b=this;this._animate_timeout_id=setTimeout(function(){b.ANIMATE=!1},a)}this._timeout_id&&(clearTimeout(this._timeout_id),this._timeout_id=null,requestAnimationFrame(this.animate))},animate:function(){this.render();var a=f.getAll().length>0;if((this.ANIMATE||a||this.MOUSEDOWN||this.controls.AUTO_ROTATE)&&this.WINDOWVISIBLE)requestAnimationFrame(this.animate);else{var b=this;this._timeout_id=setTimeout(function(){requestAnimationFrame(b.animate)},5e3)}return this},render:function(){this.controls.update(),f.update();var a=this.renderer.domElement,b=a.getContext("2d");return b.globalAlpha=1,b.fillStyle=this.background_style,b.fillRect(0,0,a.width,a.height),this.renderer.DISPLAY_EDGE=this.show_edges,this.renderer.DISPLAY_EDGE_LABEL=this.show_edges&&this.DISPLAY_EDGE_LABEL,this.renderer.DISPLAY_ARROW_INIT=this.show_edges&&this.DISPLAY_ARROW_INIT,this.renderer.DISPLAY_ARROW_END=this.show_edges&&this.DISPLAY_ARROW_END,this.renderer.ENABLE_FOG=this.ENABLE_FOG,this.renderer.render(this.scene,this.camera),this.renderClustersLabels(b),this.debug&&this.print_debug(),this},renderClustersLabels:function(a){if(this.clustering){var b=this;for(var c in this.clustering.clusters.models){var d=this.clustering.clusters.models[c],e=d.members.vs.models,f=0,g={x:0,y:0,minX:1e5,maxX:0,minY:1e5,maxY:0};e.forEach(function(a,c){var d=b.wnidx[a.id];if(d&&!(d.screenX<0)){var e=d.screenX,h=d.screenY;f++,g.y+=h,g.x+=e,g.minX=Math.min(e,g.minX),g.maxX=Math.max(e,g.maxX)}});var h="Cluster "+c;if(d.labels||d.labels.length){var i=d.labels.map(function(a){return a.label});h=i.join(", ")}if(h.length){a.font=Math.min(25,14+f)+"px Arial",a.lineWidth=3;var j=a.measureText(h).width,k=a.measureText("M").width;g.y=g.y/f,1==f?g.x=g.x-j/2:g.x=g.minX+(g.maxX-g.minX-j)/2,a.beginPath(),a.rect(g.x-8,g.y-5-k,j+16,k+16),a.fillStyle="rgba(200,200,200, 0.5)",a.fill();var l="rgb("+d.color.join(",")+")";a.fillStyle=l,a.strokeStyle="#333",a.strokeText(h,g.x,g.y),a.fillText(h,g.x,g.y)}}}},print_debug:function(){var a=$(".gviz-debug",this.$el),b=$("<div></div>").append(["camera.x:"+this.camera.position.x+"<br/>","camera.y:"+this.camera.position.y+"<br/>","camera.z:"+this.camera.position.z+"<br/>","user_vtx_size:"+this.user_vtx_size+"<br/>","<br/>"]),c=this.intersected;if(c){var d=this.wnidx[c.id],e=c;b.append("<h3>"+c._type+"</h3>"),d?b.append("obj.id:"+e.get("id")+"<br/>").append("obj.x:"+d.position.x+"<br/>").append("obj.y:"+d.position.y+"<br/>").append("obj.z:"+d.position.z+"<br/>").append("<br/>").append("neighbors:"+e.get("neighbors")+"<br/>").append("<br/>").append("flags:"+e.get("flags")+"<br/>").append("<br/>").append("distance:"+e._distance+"<br/>").append("ratio:"+e._ratio+"<br/>").append("scale:"+this.wnode_scale(e)+"<br/>").append("wscale:"+d.scale.x+"<br/>").append("material scale:"+d.program_material.scale+"<br/>").append("font scale:"+d.program_material.fontScale+"<br/>").append("<br/>"):b.append("flags:"+c.get("flags")+"<br/>")}a.html(b)},getMouseOnCanvas:function(a,b){return{x:a.clientX-b.left,y:a.clientY-b.top}},onMouseMove:function(a){a.preventDefault(),this.MOUSEHASMOVED=!0;if(this.MOUSEDOWN===!1){var b=this.el.getBoundingClientRect(),c=this.getMouseOnCanvas(a,b),d={x:c.x/$("canvas",this.$el).width()*2-1,y:2*-(c.y/$("canvas",this.$el).height())+1},e=new h.Raycaster;e.linePrecision=this.raycaster_precision,e.setFromCamera(d,this.camera);var f=null,g=e.intersectObjects(this.scene.children);if(g.length>0){for(var i in g){var j=g[i].object;if(j.material&&0!=j.material.opacity&&j.visible){var k=j._type;if("vertex"==k){f=j._node,this.trigger("vertex:mouseover",f,a);break}if("edge"==k){f=j._edge,this.trigger("edge:mouseover",f,a);break}}}null==f&&this.trigger("intersectOff",this.intersected,a)}else this.trigger("intersectOff",this.intersected,a);this.intersected=f}},onMouseDown:function(a){a.preventDefault(),this.MOUSEDOWN=!0,this.MOUSEHASMOVED=!1,this.request_animation()},onMouseUp:function(a){a.preventDefault();var b=null;this.MOUSEHASMOVED===!1&&(this.intersected instanceof e.Edge?b="edge":this.intersected instanceof e.Vertex&&(b="vertex"),b&&this.trigger(b+":click",this.intersected,a),this.trigger("click",this.intersected,a)),this.MOUSEDOWN=!1},onMouseOut:function(a){a.preventDefault(),this.MOUSEDOWN=!1},onDblClick:function(a){d.trigger("dblclick",this.intersected,a);var b=null;this.intersected instanceof e.Edge?b="edge":this.intersected instanceof e.Vertex&&(b="vertex"),b?this.trigger(b+":dblclick",this.intersected,a):this.controls.AUTO_ROTATE=!this.controls.AUTO_ROTATE}}),r.ThreeVizHelpers={PI2:2*Math.PI,SPLIT_LABEL_RE:/^(.{4,15}) (.*)/m,to_color:function(a){if(c.isArray(a))return new h.Color(a[0],a[1],a[2])},meanColor:function(){var a=g=b=0;for(var c in arguments){var d=arguments[c];a+=d.r,g+=d.g,b+=d.b}return mean=new h.Color,mean.r=a/arguments.length,mean.g=g/arguments.length,mean.b=b/arguments.length,mean},wnode_scale:function(a){var b=a.get("SIZE");return this.user_vtx_size*b},render_node:function(a,b,d){var e=a,f=b._node;b.material_needs_update&&a.set_node_material(f);var g=b.program_material;if(g.opacity&&g.visible){if(d.globalAlpha=g.opacity,a.ENABLE_FOG&&null==f.flags[1]){var h=b.position.clone();h.add(a.camera.position),a.camera.worldToLocal(h);var i=1;i*=h.z>=-1?1:Math.exp(h.z/e.fogDistance),d.globalAlpha=g.opacity*i}var j=a.wnode_scale(f);if(a.adaptive_zoom){var k=a.camera.position.distanceTo(b.position),l=0==k?1:k/1e3,m=j/10,n=1*j;j=m+(n-m)*l,f._scale=j}if(b.scale.x!=j&&(b.scale.x=j,b.scale.y=j),d.scale(1,-1),d.save(),a.show_nodes){var q=/^(rect:)([0-9\/.]+),([0-9\/.]+)/,s=null,t=g.scale,u=t,v=t;if(d.scale(t,t),f._scale*=t,"circle"==g.shape)d.beginPath(),d.arc(0,0,1,0,r.ThreeVizHelpers.PI2,!0),d.closePath();else if("square"==g.shape)d.beginPath(),d.moveTo(-1,-1),d.lineTo(-1,1),d.lineTo(1,1),d.lineTo(1,-1),d.lineTo(-1,-1),d.closePath();else if("losange"==g.shape||"diamond"==g.shape)d.beginPath(),d.moveTo(0,-1),d.lineTo(-1,0),d.lineTo(0,1),d.lineTo(1,0),d.closePath();else if("triangle"==g.shape||"triangle-top"==g.shape)d.beginPath(),d.moveTo(0,-1),d.lineTo(-1,1),d.lineTo(1,1),d.closePath();else if("triangle-bottom"==g.shape)d.beginPath(),d.moveTo(0,1),d.lineTo(-1,-1),d.lineTo(1,-1),d.closePath();else if(null!=(s=q.exec(g.shape))){var w=u=s[2],x=v=s[3];d.beginPath(),d.moveTo(-w,-x),d.lineTo(-w,x),d.lineTo(w,x),d.lineTo(w,-x),d.lineTo(-w,-x),d.closePath()}if(g.fillStyle&&(p(d,"fillStyle",g.fillStyle),d.fill()),a.show_images&&g.image){var y=document.getElementById("img"+g.id);y&&y.width&&(d.clip(),d.drawImage(y,-u,-v,2*u,2*v))}g.lineWidth>0&&g.strokeStyle&&(d.lineWidth=g.lineWidth,p(d,"strokeStyle",g.strokeStyle),d.stroke())}if(d.restore(),a.show_text&&g.textVisible){d.save();var z=g.text_lines;for(var A in z){d.save();var B=0,C=0,D=0,E=0|g.textPaddingX,F=0|g.textPaddingY,G=0,H=1;c.each(z[A],function(b){var f=e.node_materials[b.css].font;f=o(f,a.user_font_size),d.font=f,H=c.max([H,parseInt(/([0-9]*)px/.exec(f)[1])]),D+=d.measureText(b.form).width}),C="center"==g.textVerticalAlign?1:"bottom"==g.textVerticalAlign?0:.5,"left"==g.textAlign?(d.translate(1*g.scale,0),B=0+G):"right"==g.textAlign?(d.translate(-1*g.scale,0),B=-D+G):(d.translate(0,1),B=D/-2+G),d.scale(g.fontScale,g.fontScale);var I=d.measureText("M").width;C=C-(z.length-1)*I/2+A*I,c.each(z[A],function(b,c){var f=e.node_materials[b.css],g=0|f.paddingRelX,h=(0|f.paddingRelY,o(f.font,a.user_font_size));parseInt(/([0-9]*)px/.exec(h)[1]);d.font=h;var i=B+E+g,j=C-F;f.fontFillStyle&&(p(d,"fillStyle",f.fontFillStyle),d.fillText(b.form,i,j)),f.fontStrokeStyle&&f.fontStrokeWidth&&(p(d,"strokeStyle",f.fontStrokeStyle),d.lineWidth=f.fontStrokeWidth,d.strokeText(b.form,i,j));var k=d.measureText(b.form).width;B+=k}),d.restore()}d.restore()}}},edge_materials:[{default:{lineWidth:2,linecap:"butt",linejoin:"bevel",lineType:"plain",dashSize:2,gapSize:5,opacity:.61,color:function(a){return[r.hexcolor(a.source.get("color")),r.hexcolor(a.target.get("color"))]},label_visible:!1,font:"normal 12px Arial",fontFillStyle:"#4C4D00",textAlign:"center",orientation_visible:!1}}],node_materials:[{default:{visible:!0,scale:1,z:1,opacity:1,line_max_length:15,shape:"circle",image:"prop:image",fillStyle:function(a){return"gradient:"+r.csscolor(a.get("color"))},strokeStyle:function(a){return"gradient:"+r.csscolor(a.get("color"))},lineWidth:.1,textLength:20,textVisible:!0,textAlign:"center",textVerticalAlign:"center",fontScale:.1,font:"normal 10px Arial",fontFillStyle:"#333",fontStrokeStyle:"#333",fontStrokeWidth:.1,paddingRelY:0,paddingRelX:2}},{".normal-font":{font:"normal 10px Arial",fontFillStyle:"#333",fontStrokeStyle:"#333",fontStrokeWidth:.1,paddingRelY:0,paddingRelX:2}}]};var s=r;return s.SimpleViz=function(a,b){b.model=a;var e=new s.ThreeViz(b);return e.on("click",function(a,b){null==a&&(d.trigger(j.unselect_nodes),d.trigger(j.unselect_edges),e.AUTO_FOCUS&&e.setFocus())}),e.on("vertex:click",function(b,c){if(b&&b.id&&b.has_flag&&0==b.has_flag("disabled")){var e=a.vs.by_flag("selected");1==e.length&&c.ctrlKey&&d.trigger(j.ui_create_edge,{source:e[0],target:b}),d.trigger(j.select_node,b)}}),e.on("vertex:mouseover",function(a,b){a&&a.id&&a.has_flag&&0==a.has_flag("disabled")&&d.trigger("vertex:mouseover",a,b)}),e.on("vertex:dblclick",function(a,b){a&&a.id&&a.has_flag&&0==a.has_flag("disabled")&&d.trigger("engine:expand_prox",{expand:[a.id],weights:[1]})}),e.on("edge:mouseover",function(a,b){a&&a.id&&a.has_flag&&0==a.has_flag("disabled")&&d.trigger("edge:mouseover",a,b)}),e.on("edge:click",function(a,b){console.log("edge:click",a,b),a&&a.id&&a.has_flag&&0==a.has_flag("disabled")&&d.trigger(j.select_edge,a,b)}),e.on("dblclick",function(a,b){console.log("dblclick",a,b)}),e.on("intersectOff",function(b,c){b&&b.id&&b.has_flag&&0==b.has_flag("disabled")&&(a.es.remove_flag("intersected"),a.vs.remove_flag("intersected"),b.edgetype&&d.trigger("edge:mouseout",b,c),b.nodetype&&d.trigger("vertex:mouseout",b,c),e.request_animation())}),d.listenTo(d,"vertex:mouseout",function(a,b){a&&a.id&&a.remove_flag("intersected")}),d.listenTo(d,"vertex:mouseover",function(b,c){b&&b.id&&(a.vs.set_intersected(null!==b?b:[]),a.es.set_intersected(b.incident(4,!1)),b.has_flag("selected")&&(this.vertex_menu=b),e.request_animation())}),d.listenTo(d,"engine:request_animation",function(){e.request_animation()}),d.listenTo(d,"edge:mouseover",function(b,c){b&&b.id&&(a.vs.set_intersected([]),a.es.set_intersected(null!==b?b:[]))}),d.listenTo(d,"edge:mouseout",function(a,b){a&&a.id&&a.remove_flag("intersected")}),e.listenTo(a.vs,"reset",function(){console.log("padagraph-gviz","vs reset"),e.collapse(500),e.clean(),e.camera.position.x=0,e.camera.position.y=0,e.camera.position.z=e.initial_z,e.camera.lookAt(new h.Vector3(0,0,0))}),e.listenTo(a.es,"add",function(a){e.append_edge(a),e.listenTo(a,"addflag:selected",function(){a.add_flag("es-bolder",{silent:!0}),a.add_flag("es-mo-adjacent")}),e.listenTo(a,"rmflag:selected",function(){a.remove_flag("es-bolder",{silent:!0}),a.remove_flag("es-mo-adjacent")}),e.listenTo(a,"addflag:intersected",function(){a.add_flag("es-bolder");
}),e.listenTo(a,"rmflag:intersected",function(){a.remove_flag("es-bolder")})}),e.listenTo(a.es,"remove",function(a,b){a.remove_flag("intersected",{silent:!0}),a.remove_flag("selected",{silent:!0}),a.remove_flag("disabled"),e.remove_edge(a)}.bind(this)),e.listenTo(a.vs,"remove",function(a){a.remove_flag("intersected",{silent:!0}),a.remove_flag("selected",{silent:!0}),a.remove_flag("disabled"),e.remove_node(a)}.bind(this)),e.listenTo(a.vs,"add",function(b){_size=function(a){return a.get("properties").has("size")?parseFloat(a.get("properties").get("size")):1};var d=c.map(a.vs.models,_size).sort();d=d[d.length/2|1],c.each(a.vs.models,function(a){a.set("SIZE",9*(_size(a)/d))}),e.append_node(b),e.listenTo(b,"addflag:intersected",function(){var d=b.neighbors();d.push(b),a.vs.add_flag("mo-faded",c(a.vs.models).difference(d)),a.vs.add_flag("mo-adjacent",c(d).without(b));var f=a.incident(b);a.es.add_flag("es-mo-adjacent",f,!1),a.es.add_flag("es-mo-faded",c.difference(a.es.models,f),!1),e.request_animation()}),e.listenTo(b,"rmflag:intersected",function(){a.vs.remove_flag("mo-faded",a.vs.models),a.vs.remove_flag("mo-adjacent"),a.es.remove_flag("es-mo-adjacent",a.es.models),a.es.remove_flag("es-mo-faded"),a.es.remove_flag("es-bolder"),e.request_animation()}),e.listenTo(b,"addflag:selected",function(d){d.collection.remove_flag("selected",c(a.vs.models).without(d));var f=b.neighbors();d.collection.add_flag("sel-faded",c(a.vs.models).difference(f)),d.collection.add_flag("sel-adjacent",c(f).without(d));var g=a.incident(d);a.es.add_flag("es-bolder",g,{silent:!0}),a.es.add_flag("es-sel-adjacent",g,{silent:!0}),a.es.add_flag("es-sel-faded",c(a.es.models).difference(g)),e.request_animation()}),a.listenTo(b,"rmflag:selected",function(b){a.vs.remove_flag("mo-faded"),a.vs.remove_flag("sel-faded"),a.vs.remove_flag("sel-adjacent"),a.es.remove_flag("es-bolder"),a.es.remove_flag("es-sel-adjacent"),a.es.remove_flag("es-sel-faded"),a.es.remove_flag("es-mo-faded")})}.bind(this)),e},h.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},h.RenderableFace=function(){this.id=0,this.v1=new h.RenderableVertex,this.v2=new h.RenderableVertex,this.v3=new h.RenderableVertex,this.normalModel=new h.Vector3,this.vertexNormalsModel=[new h.Vector3,new h.Vector3,new h.Vector3],this.vertexNormalsLength=0,this.color=new h.Color,this.material=null,this.uvs=[new h.Vector2,new h.Vector2,new h.Vector2],this.z=0,this.renderOrder=0},h.RenderableVertex=function(){this.position=new h.Vector3,this.positionWorld=new h.Vector3,this.positionScreen=new h.Vector4,this.visible=!0},h.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld),this.positionScreen.copy(a.positionScreen)},h.RenderableLine=function(){this.id=0,this.v1=new h.RenderableVertex,this.v2=new h.RenderableVertex,this.vertexColors=[new h.Color,new h.Color],this.material=null,this.z=0,this.renderOrder=0},h.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new h.Vector2,this.material=null,this.renderOrder=0},h.Projector=function(){function a(){if(j===u){var a=new h.RenderableObject;return t.push(a),u++,j++,a}return t[j++]}function b(){if(l===w){var a=new h.RenderableVertex;return v.push(a),w++,l++,a}return v[l++]}function c(){if(n===y){var a=new h.RenderableFace;return x.push(a),y++,n++,a}return x[n++]}function d(){if(p===A){var a=new h.RenderableLine;return z.push(a),A++,p++,a}return z[p++]}function e(){if(r===C){var a=new h.RenderableSprite;return B.push(a),C++,r++,a}return B[r++]}function f(a,b){return a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.z!==b.z?b.z-a.z:a.id!==b.id?a.id-b.id:0}function g(a,b){var c=0,d=1,e=a.z+a.w,f=b.z+b.w,g=-a.z+a.w,h=-b.z+b.w;return e>=0&&f>=0&&g>=0&&h>=0||!(e<0&&f<0||g<0&&h<0)&&(e<0?c=Math.max(c,e/(e-f)):f<0&&(d=Math.min(d,e/(e-f))),g<0?c=Math.max(c,g/(g-h)):h<0&&(d=Math.min(d,g/(g-h))),!(d<c)&&(a.lerp(b,c),b.lerp(a,1-d),!0))}var i,j,k,l,m,n,o,p,q,r,s,t=[],u=0,v=[],w=0,x=[],y=0,z=[],A=0,B=[],C=0,D={objects:[],lights:[],elements:[]},E=new h.Vector3,F=new h.Vector4,G=new h.Box3(new h.Vector3(-1,-1,-1),new h.Vector3(1,1,1)),H=new h.Box3,I=new Array(3),J=(new Array(4),new h.Matrix4),K=new h.Matrix4,L=new h.Matrix4,M=new h.Matrix3,N=new h.Frustum,O=new h.Vector4,P=new h.Vector4;this.projectVector=function(a,b){console.warn("THREE.Projector: .projectVector() is now vector.project()."),a.project(b)},this.unprojectVector=function(a,b){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),a.unproject(b)},this.pickingRay=function(a,b){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var Q=function(){var a=[],e=[],f=null,g=null,i=new h.Matrix3,j=function(b){f=b,g=f.material,i.getNormalMatrix(f.matrixWorld),a.length=0,e.length=0},l=function(a){var b=a.position,c=a.positionWorld,d=a.positionScreen;c.copy(b).applyMatrix4(s),d.copy(c).applyMatrix4(K);var e=1/d.w;d.x*=e,d.y*=e,d.z*=e,a.visible=d.x>=-1&&d.x<=1&&d.y>=-1&&d.y<=1&&d.z>=-1&&d.z<=1},n=function(a,c,d){k=b(),k.position.set(a,c,d),l(k)},p=function(b,c,d){a.push(b,c,d)},q=function(a,b){e.push(a,b)},r=function(a,b,c){return a.visible===!0||b.visible===!0||c.visible===!0||(I[0]=a.positionScreen,I[1]=b.positionScreen,I[2]=c.positionScreen,G.isIntersectionBox(H.setFromPoints(I)))},t=function(a,b,c){return(c.positionScreen.x-a.positionScreen.x)*(b.positionScreen.y-a.positionScreen.y)-(c.positionScreen.y-a.positionScreen.y)*(b.positionScreen.x-a.positionScreen.x)<0},u=function(a,b){var c=v[a],e=v[b];o=d(),o.id=f.id,o.v1.copy(c),o.v2.copy(e),o.z=(c.positionScreen.z+e.positionScreen.z)/2,o.renderOrder=f.renderOrder,o.material=f.material,D.elements.push(o)},w=function(b,d,j){var k=v[b],l=v[d],n=v[j];if(r(k,l,n)!==!1&&(g.side===h.DoubleSide||t(k,l,n)===!0)){m=c(),m.id=f.id,m.v1.copy(k),m.v2.copy(l),m.v3.copy(n),m.z=(k.positionScreen.z+l.positionScreen.z+n.positionScreen.z)/3,m.renderOrder=f.renderOrder,m.normalModel.fromArray(a,3*b),m.normalModel.applyMatrix3(i).normalize();for(var o=0;o<3;o++){var p=m.vertexNormalsModel[o];p.fromArray(a,3*arguments[o]),p.applyMatrix3(i).normalize();var q=m.uvs[o];q.fromArray(e,2*arguments[o])}m.vertexNormalsLength=3,m.material=f.material,D.elements.push(m)}};return{setObject:j,projectVertex:l,checkTriangleVisibility:r,checkBackfaceCulling:t,pushVertex:n,pushNormal:p,pushUv:q,pushLine:u,pushTriangle:w}},R=new Q;this.projectScene=function(k,t,u,w){n=0,p=0,r=0,D.elements.length=0,k.autoUpdate===!0&&k.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),J.copy(t.matrixWorldInverse.getInverse(t.matrixWorld)),K.multiplyMatrices(t.projectionMatrix,J),N.setFromMatrix(K),j=0,D.objects.length=0,D.lights.length=0,k.traverseVisible(function(b){if(b instanceof h.Light)D.lights.push(b);else if(b instanceof h.Mesh||b instanceof h.Line||b instanceof h.Sprite){var c=b.material;if(c.visible===!1)return;b.frustumCulled!==!1&&N.intersectsObject(b)!==!0||(i=a(),i.id=b.id,i.object=b,E.setFromMatrixPosition(b.matrixWorld),E.applyProjection(K),i.z=E.z,i.renderOrder=b.renderOrder,D.objects.push(i))}}),u===!0&&D.objects.sort(f);for(var x=0,y=D.objects.length;x<y;x++){var z=D.objects[x].object,A=z.geometry;if(R.setObject(z),s=z.matrixWorld,l=0,z instanceof h.Mesh){if(A instanceof h.BufferGeometry){var B=A.attributes,C=A.groups;if(void 0===B.position)continue;for(var G=B.position.array,H=0,I=G.length;H<I;H+=3)R.pushVertex(G[H],G[H+1],G[H+2]);if(void 0!==B.normal)for(var Q=B.normal.array,H=0,I=Q.length;H<I;H+=3)R.pushNormal(Q[H],Q[H+1],Q[H+2]);if(void 0!==B.uv)for(var S=B.uv.array,H=0,I=S.length;H<I;H+=2)R.pushUv(S[H],S[H+1]);if(null!==A.index){var T=A.index.array;if(C.length>0)for(var x=0;x<C.length;x++)for(var U=C[x],H=U.start,I=U.start+U.count;H<I;H+=3)R.pushTriangle(T[H],T[H+1],T[H+2]);else for(var H=0,I=T.length;H<I;H+=3)R.pushTriangle(T[H],T[H+1],T[H+2])}else for(var H=0,I=G.length/3;H<I;H+=3)R.pushTriangle(H,H+1,H+2)}else if(A instanceof h.Geometry){var V=A.vertices,W=A.faces,X=A.faceVertexUvs[0];M.getNormalMatrix(s);for(var Y=z.material,Z=Y instanceof h.MeshFaceMaterial,$=Z===!0?z.material:null,_=0,aa=V.length;_<aa;_++){var ba=V[_];if(E.copy(ba),Y.morphTargets===!0)for(var ca=A.morphTargets,da=z.morphTargetInfluences,ea=0,fa=ca.length;ea<fa;ea++){var ga=da[ea];if(0!==ga){var ha=ca[ea],ia=ha.vertices[_];E.x+=(ia.x-ba.x)*ga,E.y+=(ia.y-ba.y)*ga,E.z+=(ia.z-ba.z)*ga}}R.pushVertex(E.x,E.y,E.z)}for(var ja=0,ka=W.length;ja<ka;ja++){var la=W[ja];if(Y=Z===!0?$.materials[la.materialIndex]:z.material,void 0!==Y){var ma=Y.side,na=v[la.a],oa=v[la.b],pa=v[la.c];if(R.checkTriangleVisibility(na,oa,pa)!==!1){var qa=R.checkBackfaceCulling(na,oa,pa);if(ma!==h.DoubleSide){if(ma===h.FrontSide&&qa===!1)continue;if(ma===h.BackSide&&qa===!0)continue}m=c(),m.id=z.id,m.v1.copy(na),m.v2.copy(oa),m.v3.copy(pa),m.normalModel.copy(la.normal),qa!==!1||ma!==h.BackSide&&ma!==h.DoubleSide||m.normalModel.negate(),m.normalModel.applyMatrix3(M).normalize();for(var ra=la.vertexNormals,sa=0,ta=Math.min(ra.length,3);sa<ta;sa++){var ua=m.vertexNormalsModel[sa];ua.copy(ra[sa]),qa!==!1||ma!==h.BackSide&&ma!==h.DoubleSide||ua.negate(),ua.applyMatrix3(M).normalize()}m.vertexNormalsLength=ra.length;var va=X[ja];if(void 0!==va)for(var wa=0;wa<3;wa++)m.uvs[wa].copy(va[wa]);m.color=la.color,m.material=Y,m.z=(na.positionScreen.z+oa.positionScreen.z+pa.positionScreen.z)/3,m.renderOrder=z.renderOrder,D.elements.push(m)}}}}}else if(z instanceof h.Line){if(A instanceof h.BufferGeometry){var B=A.attributes;if(void 0!==B.position){for(var G=B.position.array,H=0,I=G.length;H<I;H+=3)R.pushVertex(G[H],G[H+1],G[H+2]);if(null!==A.index)for(var T=A.index.array,H=0,I=T.length;H<I;H+=2)R.pushLine(T[H],T[H+1]);else for(var xa=z instanceof h.LineSegments?2:1,H=0,I=G.length/3-1;H<I;H+=xa)R.pushLine(H,H+1)}}else if(A instanceof h.Geometry){L.multiplyMatrices(K,s);var V=z.geometry.vertices;if(0===V.length)continue;na=b(),na.positionScreen.copy(V[0]).applyMatrix4(L);for(var xa=z instanceof h.LineSegments?2:1,_=1,aa=V.length;_<aa;_++)na=b(),na.positionScreen.copy(V[_]).applyMatrix4(L),(_+1)%xa>0||(oa=v[l-2],O.copy(na.positionScreen),P.copy(oa.positionScreen),g(O,P)===!0&&(O.multiplyScalar(1/O.w),P.multiplyScalar(1/P.w),o=d(),o.id=z.id,o.v1.positionScreen.copy(O),o.v2.positionScreen.copy(P),o.z=Math.max(O.z,P.z),o.renderOrder=z.renderOrder,o.material=z.material,o.object=z,z.material.vertexColors===h.VertexColors&&(o.vertexColors[0].copy(z.geometry.colors[_]),o.vertexColors[1].copy(z.geometry.colors[_-1])),D.elements.push(o)))}}else if(z instanceof h.Sprite){F.set(s.elements[12],s.elements[13],s.elements[14],1),F.applyMatrix4(K);var ya=1/F.w;F.z*=ya,F.z>=-1&&F.z<=1&&(q=e(),q.id=z.id,q.x=F.x*ya,q.y=F.y*ya,q.z=F.z,q.renderOrder=z.renderOrder,q.object=z,q.rotation=z.rotation,q.scale.x=z.scale.x*Math.abs(q.x-(F.x+t.projectionMatrix.elements[0])/(F.w+t.projectionMatrix.elements[12])),q.scale.y=z.scale.y*Math.abs(q.y-(F.y+t.projectionMatrix.elements[5])/(F.w+t.projectionMatrix.elements[13])),q.material=z.material,D.elements.push(q))}}return w===!0&&D.elements.sort(f),D}},h.SpriteCanvasMaterial=function(a){h.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new h.Color(16777215),this.program=function(a,b){},this.setValues(a)},h.SpriteCanvasMaterial.prototype=Object.create(h.Material.prototype),h.SpriteCanvasMaterial.prototype.constructor=h.SpriteCanvasMaterial,h.SpriteCanvasMaterial.prototype.clone=function(){var a=new h.SpriteCanvasMaterial;return a.copy(this),a.color.copy(this.color),a.program=this.program,a},r.GraphRenderer=function(a){function b(a,b,c){i(c.opacity),j(c.blending);var d=b.scale.x*H,g=b.scale.y*I,k=.5*Math.sqrt(d*d+g*g);if(W.min.set(a.x-k,a.y-k),W.max.set(a.x+k,a.y+k),c instanceof h.SpriteMaterial||c instanceof h.ParticleSystemMaterial){var l=c.map;if(null!==l){l.hasEventListener("update",e)===!1&&(void 0!==l.image&&l.image.width>0&&f(l),l.addEventListener("update",e));var m=T[l.id];o(void 0!==m?m:"rgba( 0, 0, 0, 1 )");var p=l.image,q=p.width*l.offset.x,r=p.height*l.offset.y,s=p.width*l.repeat.x,t=p.height*l.repeat.y,u=d/s,v=g/t;J.save(),J.translate(a.x,a.y),0!==c.rotation&&J.rotate(c.rotation),J.translate(-d/2,-g/2),J.scale(u,v),J.translate(-q,-r),J.fillRect(q,r,s,t),J.restore()}else o(c.color.getStyle()),J.save(),J.translate(a.x,a.y),0!==c.rotation&&J.rotate(c.rotation),J.scale(d,-g),J.fillRect(-.5,-.5,1,1),J.restore()}else c instanceof h.SpriteCanvasMaterial&&(n(c.color.getStyle()),o(c.color.getStyle()),J.save(),J.translate(a.x,a.y),0!==c.rotation&&J.rotate(c.rotation),J.scale(d,g),c.program(J),J.restore())}function c(a,b,c,e){if(i(e.opacity),j(e.blending),k(e.linewidth),l(e.linecap),m(e.linejoin),0!=C.DISPLAY_EDGE&&0!=e.opacity){var f=c.object._edge.source,g=c.object._edge.target;if(f&&g){var o=b.positionScreen.x-a.positionScreen.x,p=b.positionScreen.y-a.positionScreen.y;if(0!=o||0!=p){var q=a.positionScreen.x,r=b.positionScreen.x,s=a.positionScreen.y,t=b.positionScreen.y,u=q<r,v=Math.sqrt(Math.pow(o,2)+Math.pow(p,2)),w=Math.atan((t-s)/(r-q));q==r?t-s>0?w+=Math.PI/2:t<s&&(w-=Math.PI/2):q>r&&(w+=Math.PI),J.save(),J.translate(a.positionScreen.x,a.positionScreen.y+5),J.rotate(w),J.scale(1,-1);e.opacity;if(e.vertexColors!==h.VertexColors)J.strokeStyle=e.color.getStyle();else{var x=c.vertexColors[0].getStyle(),y=c.vertexColors[1].getStyle();if(x===y)J.strokeStyle=x;else{try{var z=J.createLinearGradient(0,0,v,0);z.addColorStop(0,x),z.addColorStop(1,y)}catch(a){z=x}J.strokeStyle=z}}"dashed"==e.lineType?J.setLineDash([e.dashSize,e.gapSize]):J.setLineDash([]),J.beginPath(),J.moveTo(0,0),J.lineTo(v,0),J.closePath(),J.stroke(),W.expandByScalar(2*e.linewidth),J.setLineDash([]);var A="";J.translate(v/2,0),C.DISPLAY_EDGE_LABEL&&e.label_visible&&(J.save(),A=c.object._edge.label,A||(A=u?g.label+" <--- "+f.label:f.label+" ---> "+g.label),u||J.scale(-1,-1),J.textAlign=e.textAlign,J.font=e.font,J.fillStyle=e.fontFillStyle,J.fillText(A,0,-2),J.restore());var B=3;if(C.DISPLAY_ARROW_END&&e.orientation_visible){var D=1.6*(g._scale/g._distance*1e3+B);J.save(),J.translate(-v/2+D,0),J.scale(-B,-B),n(y),d(0,.5,0,-.5,1,0),J.stroke(),J.restore()}if(C.DISPLAY_ARROW_INIT&&e.orientation_visible){var D=1.6*(f._scale/f._distance*1e3+B)+5;J.save(),J.translate(v/2-D,0),J.scale(-B,-B),n(x),d(0,.5,0,-.5,1,0),J.stroke(),J.restore()}J.restore()}}}}function d(a,b,c,d,e,f){J.beginPath(),J.moveTo(a,b),J.lineTo(c,d),J.lineTo(e,f),J.closePath()}function e(a){f(a.target)}function f(a){var b=a.wrapS===h.RepeatWrapping,c=a.wrapT===h.RepeatWrapping,d=a.image,e=document.createElement("canvas");e.width=d.width,e.height=d.height;var f=e.getContext("2d");f.setTransform(1,0,0,-1,0,d.height),f.drawImage(d,0,0),T[a.id]=J.createPattern(e,b===!0&&c===!0?"repeat":b===!0&&c===!1?"repeat-x":b===!1&&c===!0?"repeat-y":"no-repeat")}function g(a,b,c){var d,e=b.x-a.x,f=b.y-a.y,g=e*e+f*f;0!==g&&(d=c/Math.sqrt(g),e*=d,f*=d,b.x+=e,b.y+=f,a.x-=e,a.y-=f)}function i(a){M!==a&&(J.globalAlpha=a,M=a)}function j(a){N!==a&&(a===h.NormalBlending?J.globalCompositeOperation="source-over":a===h.AdditiveBlending?J.globalCompositeOperation="lighter":a===h.SubtractiveBlending&&(J.globalCompositeOperation="darker"),N=a)}function k(a){Q!==a&&(J.lineWidth=a,Q=a)}function l(a){R!==a&&(J.lineCap=a,R=a)}function m(a){S!==a&&(J.lineJoin=a,S=a)}function n(a){O!==a&&(J.strokeStyle=a,O=a)}function o(a){P!==a&&(J.fillStyle=a,P=a)}console.log("gviz.CanvasRenderer based on THREE ",h.REVISION);h.Math.smoothstep;a=a||{};var p,q,r,s,t,u,v,w,x,y,z,A,B,C=this,D=new h.Projector,E=void 0!==a.canvas?a.canvas:document.createElement("canvas"),F=E.width,G=E.height,H=Math.floor(F/2),I=Math.floor(G/2),J=E.getContext("2d",{alpha:a.alpha===!0}),K=new h.Color(0),L=0,M=1,N=0,O=null,P=null,Q=null,R=null,S=null,T=(new h.RenderableVertex,new h.RenderableVertex,new h.Color,new h.Color,new h.Color,new h.Color,new h.Color,new h.Color,new h.Color,new h.Color,{}),U=new h.Box2,V=new h.Box2,W=new h.Box2,X=(new h.Color,new h.Color,new h.Color,new h.Vector3,new h.Vector3,new h.Matrix3),Y=16;w=document.createElement("canvas"),w.width=w.height=2,x=w.getContext("2d"),x.fillStyle="rgba(0,0,0,1)",x.fillRect(0,0,2,2),y=x.getImageData(0,0,2,2),z=y.data,A=document.createElement("canvas"),A.width=A.height=Y,B=A.getContext("2d"),B.translate(-Y/2,-Y/2),B.scale(Y,Y),Y--,this.DISPLAY_EDGE=!0,this.DISPLAY_EDGE_LABEL=!0,this.DISPLAY_ARROW_INIT=!0,this.DISPLAY_ARROW_END=!0,this.ENABLE_FOG=!0,void 0===J.setLineDash&&(void 0!==J.mozDash?J.setLineDash=function(a){J.mozDash=null!==a[0]?a:null}:J.setLineDash=function(){}),this.domElement=E,this.devicePixelRatio=void 0!==a.devicePixelRatio?a.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setSize=function(a,b,c){F=a*this.devicePixelRatio,G=b*this.devicePixelRatio,H=Math.floor(F/2),I=Math.floor(G/2),E.width=F,E.height=G,1!==this.devicePixelRatio&&c!==!1&&(E.style.width=a+"px",E.style.height=b+"px"),U.min.set(-H,-I),U.max.set(H,I),V.min.set(-H,-I),V.max.set(H,I),M=1,N=0,O=null,P=null,Q=null,R=null,S=null},this.setClearColor=function(a,b){K.set(a),L=void 0!==b?b:1,V.min.set(-H,-I),V.max.set(H,I)},this.setClearColorHex=function(a,b){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(a,b)},this.getMaxAnisotropy=function(){return 0},this.clear=function(){J.setTransform(1,0,0,-1,H,I),V.isEmpty()===!1&&(V.intersect(U),V.expandByScalar(2),L<1&&J.clearRect(0|V.min.x,0|V.min.y,V.max.x-V.min.x|0,V.max.y-V.min.y|0),L>0&&(j(h.NormalBlending),i(1),o("rgba("+Math.floor(255*K.r)+","+Math.floor(255*K.g)+","+Math.floor(255*K.b)+","+L+")"),J.fillRect(0|V.min.x,0|V.min.y,V.max.x-V.min.x|0,V.max.y-V.min.y|0)),V.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(a,d){if(d instanceof h.Camera==!1)return void console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");this.autoClear===!0&&this.clear(),J.setTransform(1,0,0,-1,H,I),C.info.render.vertices=0,C.info.render.faces=0,p=D.projectScene(a,d,this.sortObjects,this.sortElements),q=p.elements,r=p.lights,s=d,X.getNormalMatrix(d.matrixWorldInverse);for(var e=0,f=q.length;e<f;e++){var i=q[e],j=i.material;if(void 0!==j&&j.visible!==!1){if(W.makeEmpty(),i instanceof h.RenderableSprite){t=i,t.x*=H,t.y*=I,i.object.x=t.x,i.object.y=t.y;var k=new h.Vector3;k.setFromMatrixPosition(i.object.matrixWorld),k.project(d),k.x=k.x*H+H,k.y=-(k.y*I)+I,i.object.screenX=k.x,i.object.screenY=k.y,b(t,i,j)}else if(i instanceof h.RenderableLine)t=i.v1,u=i.v2,t.positionScreen.x*=H,t.positionScreen.y*=I,u.positionScreen.x*=H,u.positionScreen.y*=I,W.setFromPoints([t.positionScreen,u.positionScreen]),U.intersectsBox(W)===!0&&c(t,u,i,j);else if(i instanceof h.RenderableFace){if(t=i.v1,u=i.v2,v=i.v3,t.positionScreen.z<-1||t.positionScreen.z>1)continue;if(u.positionScreen.z<-1||u.positionScreen.z>1)continue;if(v.positionScreen.z<-1||v.positionScreen.z>1)continue;t.positionScreen.x*=H,t.positionScreen.y*=I,u.positionScreen.x*=H,u.positionScreen.y*=I,v.positionScreen.x*=H,v.positionScreen.y*=I,j.overdraw>0&&(g(t.positionScreen,u.positionScreen,j.overdraw),g(u.positionScreen,v.positionScreen,j.overdraw),g(v.positionScreen,t.positionScreen,j.overdraw)),W.setFromPoints([t.positionScreen,u.positionScreen,v.positionScreen]),U.intersectsBox(W)===!0&&renderFace3(t,u,v,0,1,2,i,j)}V.union(W)}}J.setTransform(1,0,0,1,0,0)}},r.Layout.ForceDirected={run:function(a,b){var c,d,e,f,g,i,j,k,l,m,n,o,p,q,r,s;for(j=a,b=b||{},c=b.hasOwnProperty("iterations")?b.iterations:1e4,d=b.hasOwnProperty("forceStrength")?b.forceStrength:10,e=.01,f=2,g=50,n=new h.Vector3,a.vs.each(function(a){a.position=new h.Vector3(Math.random(),Math.random(),Math.random()),a.force=new h.Vector3(Math.random(),Math.random(),Math.random())}),i=function(){e-=.01/c;var b=a.vs.elements,i=a.vs.elements;for(l=0;l<b.length;l+=1)for(m=0;m<b.length;m+=1)l!==m&&(p=b[l],q=b[m],n.subVectors(q.position,p.position),o=n.length(),o<.1&&(n.set(Math.random(),Math.random(),Math.random()).multiplyScalar(.1).addScalar(.1),o=n.length()),o<g&&(n.multiplyScalar(d*d/(o*o)),p.force.sub(n.clone().multiplyScalar(q.scale.x)),q.force.add(n.clone().multiplyScalar(p.scale.x))));for(l=0;l<i.length;l+=1)p=b[i[l].source],q=b[i[l].target],n.subVectors(q.position,p.position),o=n.length(),o<.1&&(n.set(h.Math.randFloat(.1,.2),h.Math.randFloat(.1,.2),h.Math.randFloat(.1,.2)),o=n.length()),o=Math.min(o,g),n.multiplyScalar((o*o-d*d)/(o*d)),p.force.add(n.clone().multiplyScalar(q.scale.x)),q.force.sub(n.clone().multiplyScalar(p.scale.x));for(l=0;l<b.length;l+=1)p=b[l],p.force.multiplyScalar(e),p.force.setX(h.Math.clamp(p.force.x,-f,f)),p.force.setY(h.Math.clamp(p.force.y,-f,f)),p.force.setZ(h.Math.clamp(p.force.z,-f,f)),p.position.add(p.force),p.force.set(0,0,0);for(l=0;l<i.length;l+=1)r=i[l],p=b[r.source],q=b[r.target],o=q.position.distanceTo(p.position),r.position.addVectors(p.position,q.position).divideScalar(2),r.lookAt(q.position),r.scale.z=o,j.directed&&(s=j.arrows[l],s.position.copy(r.position),s.lookAt(q.position))},k=0;k<c;k+=1)setTimeout(i,0)}},s});