/*!  09-06-2018 */

!function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","cello","tween","threejs","pdgconst"],function(i,n,o,r,a,s){return t(e,i,n,o,r,a,s)}):e.Gviz=t(e,_,Backbone,Cello,TWEEN,THREE,Const)}(this,function(e,t,n,o,r,a,s){a.TrackballControls=function(e,t){function i(e){!1!==u.enabled&&(window.removeEventListener("keydown",i),v=f,f===m.NONE&&(e.keyCode!==u.keys[m.ROTATE]||u.noRotate?e.keyCode!==u.keys[m.ZOOM]||u.noZoom?e.keyCode!==u.keys[m.PAN]||u.noPan||(f=m.PAN):f=m.ZOOM:f=m.ROTATE))}function n(e){!1!==u.enabled&&(f=v,window.addEventListener("keydown",i,!1))}function o(e){!1!==u.enabled&&(_MOUSEDOWN=!0,e.preventDefault(),e.stopPropagation(),f===m.NONE&&(f=e.button),f!==m.ROTATE||u.noRotate?f!==m.ZOOM||u.noZoom?f!==m.PAN||u.noPan||(O.copy(D(e.pageX,e.pageY)),z.copy(O)):(S.copy(D(e.pageX,e.pageY)),E.copy(S)):(x.copy(R(e.pageX,e.pageY)),y.copy(x)),document.addEventListener("mousemove",r,!1),document.addEventListener("mouseup",s,!1),u.dispatchEvent(L))}function r(e){!1!==u.enabled&&(e.preventDefault(),e.stopPropagation(),f!==m.ROTATE||u.noRotate?f!==m.ZOOM||u.noZoom?f!==m.PAN||u.noPan||z.copy(D(e.pageX,e.pageY)):E.copy(D(e.pageX,e.pageY)):(y.copy(x),x.copy(R(e.pageX,e.pageY))))}function s(e){!1!==u.enabled&&(_MOUSEDOWN=!1,e.preventDefault(),e.stopPropagation(),f=m.NONE,document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s),u.dispatchEvent(C))}function l(e){if(!1!==u.enabled){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),S.y+=.01*t,u.dispatchEvent(L),u.dispatchEvent(C)}}function c(e){if(!1!==u.enabled){switch(e.touches.length){case 1:f=m.TOUCH_ROTATE,x.copy(R(e.touches[0].pageX,e.touches[0].pageY)),y.copy(x);break;case 2:f=m.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;M=T=Math.sqrt(t*t+i*i);var n=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;O.copy(D(n,o)),z.copy(O);break;default:f=m.NONE}u.dispatchEvent(L)}}function d(e){if(!1!==u.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:y.copy(x),x.copy(R(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;M=Math.sqrt(t*t+i*i);var n=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;z.copy(D(n,o));break;default:f=m.NONE}}function h(e){if(!1!==u.enabled){switch(e.touches.length){case 1:y.copy(x),x.copy(R(e.touches[0].pageX,e.touches[0].pageY));break;case 2:T=M=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;z.copy(D(t,i)),O.copy(z)}f=m.NONE,u.dispatchEvent(C)}}function p(e){e.preventDefault()}var u=this,m={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=5e3,this.keys=[65,83,68],this.AUTO_ROTATE=!1,this.autoRotateSpeed=.005,this.target=new a.Vector3;var g=new a.Vector3,f=m.NONE,v=m.NONE,_=new a.Vector3,y=new a.Vector2,x=new a.Vector2,w=new a.Vector3,b=0,S=new a.Vector2,E=new a.Vector2,T=0,M=0,O=new a.Vector2,z=new a.Vector2;_MOUSEDOWN=!1,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var A={type:"change"},L={type:"start"},C={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var D=function(){var e=new a.Vector2;return function(t,i){return e.set((t-u.screen.left)/u.screen.width,(i-u.screen.top)/u.screen.height),e}}(),R=function(){var e=new a.Vector2;return function(t,i){return e.set((t-.5*u.screen.width-u.screen.left)/(.5*u.screen.width),(u.screen.height+2*(u.screen.top-i))/u.screen.width),e}}();this.rotateCamera=function(){var e,t=new a.Vector3,i=new a.Quaternion,n=new a.Vector3,o=new a.Vector3,r=new a.Vector3,s=new a.Vector3;return function(){this.AUTO_ROTATE&&!_MOUSEDOWN&&(x.x=y.x+this.autoRotateSpeed),s.set(x.x-y.x,x.y-y.y,0),(e=s.length())?(_.copy(u.object.position).sub(u.target),n.copy(_).normalize(),o.copy(u.object.up).normalize(),r.crossVectors(o,n).normalize(),o.setLength(x.y-y.y),r.setLength(x.x-y.x),s.copy(o.add(r)),t.crossVectors(s,_).normalize(),e*=u.rotateSpeed,i.setFromAxisAngle(t,e),_.applyQuaternion(i),u.object.up.applyQuaternion(i),w.copy(t),b=e):!u.staticMoving&&b&&(b*=Math.sqrt(1-u.dynamicDampingFactor),_.copy(u.object.position).sub(u.target),i.setFromAxisAngle(w,b),_.applyQuaternion(i),u.object.up.applyQuaternion(i)),y.copy(x)}}(),this.zoomCamera=function(){var e;f===m.TOUCH_ZOOM_PAN?(e=T/M,T=M,_.multiplyScalar(e)):1!==(e=1+(E.y-S.y)*u.zoomSpeed)&&e>0&&(_.multiplyScalar(e),u.staticMoving?S.copy(E):S.y+=(E.y-S.y)*this.dynamicDampingFactor)},this.panCamera=function(){var e=new a.Vector2,t=new a.Vector3,i=new a.Vector3;return function(){e.copy(z).sub(O),e.lengthSq()&&(e.multiplyScalar(_.length()*u.panSpeed),i.copy(_).cross(u.object.up).setLength(e.x),i.add(t.copy(u.object.up).setLength(e.y)),u.object.position.add(i),u.target.add(i),u.staticMoving?O.copy(z):O.add(e.subVectors(z,O).multiplyScalar(u.dynamicDampingFactor)))}}(),this.checkDistances=function(){u.noZoom&&u.noPan||(_.lengthSq()>u.maxDistance*u.maxDistance&&(u.object.position.addVectors(u.target,_.setLength(u.maxDistance)),S.copy(E)),_.lengthSq()<u.minDistance*u.minDistance&&(u.object.position.addVectors(u.target,_.setLength(u.minDistance)),S.copy(E)))},this.update=function(){_.subVectors(u.object.position,u.target),u.noRotate||u.rotateCamera(),u.noZoom||u.zoomCamera(),u.noPan||u.panCamera(),u.object.position.addVectors(u.target,_),u.checkDistances(),u.object.lookAt(u.target),g.distanceToSquared(u.object.position)>1e-6&&(u.dispatchEvent(A),g.copy(u.object.position))},this.reset=function(){f=m.NONE,v=m.NONE,u.target.copy(u.target0),u.object.position.copy(u.position0),u.object.up.copy(u.up0),_.subVectors(u.object.position,u.target),u.object.lookAt(u.target),u.dispatchEvent(A),g.copy(u.object.position)},this.dispose=function(){this.domElement.removeEventListener("contextmenu",p,!1),this.domElement.removeEventListener("mousedown",o,!1),this.domElement.removeEventListener("mousewheel",l,!1),this.domElement.removeEventListener("DOMMouseScroll",l,!1),this.domElement.removeEventListener("touchstart",c,!1),this.domElement.removeEventListener("touchend",h,!1),this.domElement.removeEventListener("touchmove",d,!1),document.removeEventListener("mousemove",r,!1),document.removeEventListener("mouseup",s,!1),document.removeEventListener("mouseout",s,!1),window.removeEventListener("keydown",i,!1),window.removeEventListener("keyup",n,!1)},this.domElement.addEventListener("contextmenu",p,!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",l,!1),this.domElement.addEventListener("DOMMouseScroll",l,!1),this.domElement.addEventListener("touchstart",c,!1),this.domElement.addEventListener("touchend",h,!1),this.domElement.addEventListener("touchmove",d,!1),window.addEventListener("keydown",i,!1),window.addEventListener("keyup",n,!1),this.handleResize(),this.update()},a.TrackballControls.prototype=Object.create(a.EventDispatcher.prototype),a.TrackballControls.prototype.constructor=a.TrackballControls;var a=window.THREE,r=window.TWEEN,l=o.utils.hsvToRgb,c=o.utils.rgbToHsv,d=function(e,t,i){i|=1;var n=-1,o=0,r=e.split(" ");r.length;for(var a in r){if(a=parseInt(a),o+=r[a].length,n=a,o+a>t&&n>=i)break;n+=1}return[r.slice(0,n).join(" "),r.slice(n).join(" ")]},h=function(e,t){var i=parseInt(/([0-9]*)px/.exec(e)[1]);return i+=parseInt(t),e.replace(/[0-9]+(.*)/,i+"$1")},p=function(e,i,n){if(t.isArray(n)&&3==n.length)style="rgb("+n.join(",")+")";else if(t.isArray(n)&&2==n.length){style=e.createLinearGradient(-.5,-.5,.5,.5);for(var o in n)style.addColorStop(o,n[o])}else if("gradient:"==n.substring(0,9)){var r=new a.Color(n.substring(9)),s=c(r.r,r.g,r.b),d="rgb("+l(s[0],s[1],60).join(",")+")";style=e.createLinearGradient(-.5,-.5,.5,.5),style.addColorStop(0,d),style.addColorStop(1,r.getStyle())}else style=n;e[i]=style},u=function(e,t){var i=[],n=[],o={},r="",a=[{form:e.label,css:".normal-font"}];if(e.format_label&&(a=e.format_label(t.textLength)),void 0===a)return[];a.length&&(r+=(o=a[0]).form);for(var s=t.line_max_length;a.length||r.length;){var l=d(r,s,1),c=l[0],h=l[1];h||(h=""),!c.length&&h.length&&(c=h,h=""),(s-=c.length)<=0&&(i.length,n.length>0&&i.push(n),n=[],s=t.line_max_length),c&&c.length&&n.push({form:c,css:o.css}),h.length&&c.length?(i.push(n),r=h,s=t.line_max_length,n=[]):h.length<=s?(h.length&&(n.push({form:h,css:o.css}),s-=(h="").length),0===s&&(i.push(n),n=[],s=line_max_length),a.length&&a.shift(),r=a.length?(o=a[0]).form:""):r=h}return n.length&&i.push(n),i},m={Layout:{}};m.hexcolor=function(e){var i=t.map(e,function(e){return e/255});return new a.Color(i[0],i[1],i[2]).getHex()},m.csscolor=function(e){var i=t.map(e,function(e){return e/255});return new a.Color(i[0],i[1],i[2]).getStyle()},m.DEFAULTS={show_nodes:!0,show_edges:!0,show_text:!0,show_images:!0,background_color:11184810,user_font_size:3,user_vtx_size:1,initial_size:10,initial_z:1400,raycaster_precision:2,adaptive_zoom:!1,use_material_transitions:!0,force_position_no_delay:!1,node_material_transition_delay:100,edge_material_transition_delay:200,auto_rotate:!1,debug:!1},m.ThreeViz=n.View.extend({initialize:function(e){var i=this;attrs=t.extend({},m.DEFAULTS,e),attrs.el||(attrs.el="#vz_threejs_main"+Math.round(1e4*Math.random())),this.show_nodes=attrs.show_nodes,this.show_edges=attrs.show_edges,this.show_images=attrs.show_images,this.show_text=attrs.show_text,this.DISPLAY_EDGE_LABEL=attrs.DISPLAY_EDGE_LABEL||!0,this.DISPLAY_ARROW_INIT=attrs.DISPLAY_ARROW_INIT||!1,this.DISPLAY_ARROW_END=attrs.DISPLAY_ARROW_END||!1,this.AUTO_FOCUS=attrs.AUTO_FOCUS,this.ENABLE_FOG=attrs.ENABLE_FOG,this.auto_rotate=attrs.auto_rotate||!1,this.initial_size=attrs.initial_size,this.initial_z=attrs.initial_z,this.user_vtx_size=attrs.user_vtx_size,this.user_font_size=attrs.user_font_size,this.background_color=attrs.background_color,this.render_node=attrs.render_node||m.ThreeVizHelpers.render_node,this.wnode_scale=attrs.wnode_scale||m.ThreeVizHelpers.wnode_scale,this.raycaster_precision=attrs.raycaster_precision,this.force_position_no_delay=attrs.force_position_no_delay,this.edge_materials={},this.node_materials={},this.use_material_transitions=attrs.use_material_transitions,this.node_material_transition_delay=attrs.node_material_transition_delay,this.edge_material_transition_delay=attrs.edge_material_transition_delay;var n=function(e,n){t.each(e,function(e){var o=t.keys(e)[0];i.add_material(n,o,e[o])})};return n(m.ThreeVizHelpers.edge_materials,"edge"),n(m.ThreeVizHelpers.node_materials,"node"),attrs.materials&&(attrs.materials.node&&n(attrs.materials.node,"node"),attrs.materials.edge&&n(attrs.materials.edge,"edge")),this.adaptive_zoom=attrs.adaptive_zoom,this.debug=attrs.debug,this._width=attrs.width||-1,this._height=attrs.height||-1,o.get(this,"width",function(){var e=i.$el.width();return e<=0&&(e=$(window).width()),i._width>0?i._width:e}),o.get(this,"height",function(){var e=i.$el.height();return e<=0&&(e=$(window).height()),i._height>0?i._height:e}),this.clear_color=new a.Color(attrs.background_color),this._inited=!1,this.wnodes=[],this.wedges=[],this.wnidx={},this.weidx={},this.WINDOWVISIBLE=!0,this.MOUSEDOWN=!1,this.MOUSEHASMOVED=!1,this.ANIMATE=!1,this.intersected=null,this.program_factory=function(e){var t=i.render_node;return function(n){t(i,e,n)}},this},enable:function(){var e,i,n,r,s=this;new a.Vector2;(e=new a.PerspectiveCamera(40,this.width/this.height,10,1e4)).position.x=0,e.position.y=0,e.position.z=this.initial_z,(n=new a.Scene).autoUpdate=!0,(i=new a.TrackballControls(e,this.el)).rotateSpeed=5,i.zoomSpeed=4,i.panSpeed=3,i.noZoom=!1,i.noPan=!1,i.staticMoving=!0,i.dynamicDampingFactor=.3,i.minDistance=50,i.autoRotateSpeed=.002,i.AUTO_ROTATE=this.auto_rotate,(r=new m.GraphRenderer({antialias:!0})).sortObjects=!0,r.setSize(this.width,this.height),r.DISPLAY_EDGE=this.show_edges,r.DISPLAY_EDGE_LABEL=!0,r.DISPLAY_ARROW_INIT=!0,r.DISPLAY_ARROW_END=!0,r.ENABLE_FOG=!0,this.camera=e,this.controls=i,this.scene=n,this.renderer=r,this.changeFocusSpeed=1e3,this.changeCoordSpeed=800,this.fogDistance=800,t.bindAll(this,"animate","render","resize_rendering"),t.bindAll(this,"onMouseMove","onMouseUp","onMouseDown","onMouseOut","onDblClick"),this.listenTo(o.utils.asEvents(window),"focus",function(e){s.WINDOWVISIBLE=!0}),this.listenTo(o.utils.asEvents(window),"blur",function(e){s.WINDOWVISIBLE=!1}),this.listenTo(this.model,"change",function(){s.request_animation()}),this.listenTo(this.model.vs,"remove",function(e){s.stopListening(e,"change:coords")}),r.domElement.addEventListener("mousemove",this.onMouseMove,!1),r.domElement.addEventListener("mousedown",this.onMouseDown,!1),r.domElement.addEventListener("mouseout",this.onMouseOut,!1),r.domElement.addEventListener("mouseup",this.onMouseUp,!1),r.domElement.addEventListener("dblclick",this.onDblClick,!1);var l=function(e){s.request_animation(1e3)};return r.domElement.addEventListener("mousewheel",l,!1),r.domElement.addEventListener("DOMMouseScroll",l,!1),r.domElement.addEventListener("touchstart",function(e){s.MOUSEDOWN=!0,s.request_animation()},!1),r.domElement.addEventListener("touchend",function(e){s.MOUSEDOWN=!1},!1),r.domElement.className.split(" ").indexOf("pdg-renderer")<0&&(this.renderer.domElement.className+=" pdg-renderer"),this.el.appendChild(r.domElement),(this._width<0||this._height<0)&&this.listenTo(o.utils.asEvents(window),"resize",this.resize_rendering),this.set_clear_color(this.clear_color.getStyle()),this.renderer=r,this._inited=!0,this},set_clear_color:function(e){var t=new a.Color(e);this.background_style=t.getStyle(),this.renderer.setClearColor(t.getHex()),$(this.renderer.domElement).css("background-color",t.getStyle()),this.clear_color=t},resize_rendering:function(){if(this._inited){var e=this.width,t=this.height;this.controls.handleResize(),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.request_animation()}},clean:function(){var e,i,n=this.scene.children,o=this.scene;for(i=n.length-1;i>=0;i--)e=n[i],t.has(e,"_type")&&o.remove(e);this.wnodes=[],this.wedges=[],this.wnidx={},this.weidx={},this.request_animation()},append_node:function(e){var t=this,i=new a.Sprite;t.wnidx[e.id]=i,i.position=new a.Vector3(0,0,0),i.scale.x=i.scale.y=t.wnode_scale(e),i._type="vertex",i._node=e,i._edges=[],i.program_material=t.get_material(t.node_materials,e),i.material=new a.SpriteCanvasMaterial({program:t.program_factory(i)}),t.listenTo(e,"change:coords",function(){t.setPosition(i.position,e.get("coords"),this.changeCoordSpeed,r.Easing.Elastic.OutIn)}),t.listenTo(e,"change:color",function(){i.material_needs_update=!0,t.request_animation()}),t.listenTo(e,"rmflag",function(){i.material_needs_update=!0,t.request_animation()}),t.listenTo(e,"addflag",function(){i.material_needs_update=!0,t.request_animation()}),t.wnodes.push(i),t.scene.add(i)},remove_node:function(e){var t=this.wnidx[e.id];this.scene.remove(t),delete this.wnidx[e.id],this.request_animation()},remove_edge:function(e){var t=this.weidx[e.id];this.scene.remove(t),delete this.weidx[e.id],console.log("gviz remove edge",e),this.request_animation()},append_edge:function(e){if(!(e.id in this.weidx)){var t=this,i=t.wnidx[e.source.id],n=t.wnidx[e.target.id];if(void 0!==i&&void 0!==n){var o=new a.Geometry;o.vertices.push(i.position.clone()),o.vertices.push(n.position.clone());var s=r.Easing.Circular.In,l=new a.LineBasicMaterial({}),c=new a.Line(o,l);c._type="edge",c._edge=e,t.set_line_material(c),this.weidx[e.id]=c,t.scene.add(c);var d=function(){o.computeBoundingSphere(),t.set_line_material(c)};t.listenTo(e.source,"change:coords",function(){e.collection&&t.setPosition(o.vertices[0],e.source.get("coords"),this.changeCoordSpeed,s,d)}),t.listenTo(e.target,"change:coords",function(){e.collection&&t.setPosition(o.vertices[1],e.target.get("coords"),this.changeCoordSpeed,s,d)}),t.listenTo(e,"rmflag",function(e,i){t.set_line_material(c),t.request_animation()}),t.listenTo(e,"addflag",function(e,i,n){t.set_line_material(c),t.request_animation()})}else console.log("edge without source or target")}},add_material:function(e,t,i){return this.set_material(e,t,i)},set_material:function(e,i,n){var r=["node","edge"];o.assert(t.indexOf(r,e)>-1,["Wrong material type",r]),o.log("GViz: Adding material",e,i),i in this[e+"_materials"]?t.extend(this[e+"_materials"][i],n):this[e+"_materials"][i]=n},set_materials:function(e,i){_this=this;var n=["node","edge"];o.assert(t.indexOf(n,e)>-1,["Wrong material type",n]),t.each(i,function(i){var n=t.keys(i)[0];_this.set_material(e,n,i[n])})},get_material:function(e,n){var o=n.flags||{},r=t.filter(t.keys(e),function(e){return"."==e.substring(0,1)}),a=t.extend({},e.default),s=!0;r=t.sortBy(r,function(e){return e.split(".").length}),t.each(r,function(n){for(css_classes=t(n.split(".")).rest(1),s=!0,i=0;i<css_classes.length;i++)if(!t(o).contains(css_classes[i])){s=!1;break}s&&(a=t.extend(a,e[n]))});for(k in a){var l=a[k];if(t.isString(l)&&"get:"==l.substring(0,4)){c=l.substring(4);l=n.get(c)}else if(t.isString(l)&&"prop:"==l.substring(0,5)){var c=l.substring(5);l=n.properties.get(c)}else if(t.isFunction(l))try{l=l(n)}catch(e){l=0}a[k]=l}return n.nodetype&&(a.text_lines=u(n,a)),null==a.shape&&(a.shape="circle"),a.id=n.id,a},set_node_material:function(e){var t=this.wnidx[e.id],i=this.get_material(this.node_materials,e),n={opacity:i.opacity,scale:i.scale,fontScale:i.fontScale};if(this.use_material_transitions&&this.node_material_transition_delay>0)i.opacity=t.program_material.opacity,i.scale=t.program_material.scale,i.fontScale=t.program_material.fontScale,tween=new r.Tween(i).to(n,this.node_material_transition_delay).start();else for(k in n)i[k]=n[k];t.program_material=i,t.material_needs_update=!1},set_line_material:function(e){var i=e._edge;if(null!=i){var n,o=this.get_material(this.edge_materials,i),s=null;t.isArray(o.color)&&2==o.color.length?(n=[new a.Color(o.color[0]),new a.Color(o.color[1])],s=a.VertexColors):n=new a.Color(o.color),e.material.linecap=o.linecap,e.material.linejoin=o.linejoin,e.material.lineType=o.lineType,e.material.dashSize=o.dashSize,e.material.gapSize=o.gapSize,e.material.vertexColors=s,e.geometry.colors=n,e.material.color=n,e.material.label_visible=o.label_visible,e.material.font=o.font,e.material.fontFillStyle=o.fontFillStyle,e.material.textAlign=o.textAlign,e.material.orientation_visible=o.orientation_visible;var l={opacity:o.opacity,linewidth:o.lineWidth};if(this.use_material_transitions&&this.edge_material_transition_delay>0)tween=new r.Tween(e.material).to(l,this.edge_material_transition_delay).start();else for(k in l)e.material[k]=l[k]}},setPosition:function(e,i,n,o,a){this.force_position_no_delay&&(n=0);var a=a||null,o=o||r.Easing.Circular.In,s={};if(t.isArray(i)?(i.length,i.push(0),s.x=1e3*i[0],s.y=1e3*i[1],s.z=1e3*i[2]):s=i,n)tween=new r.Tween(e).to(s,n).easing(o).onComplete(a).start();else for(k in s)e[k]=s[k]},increase_vertex_size:function(){this.user_vtx_size=Math.min(25,1.5*this.user_vtx_size),this.request_animation(100)},decrease_vertex_size:function(){this.user_vtx_size=Math.max(.1,this.user_vtx_size/1.5),this.request_animation(100)},increase_font_size:function(){this.user_font_size=Math.min(25,this.user_font_size+1),this.request_animation(100)},decrease_font_size:function(){this.user_font_size=Math.max(-5,this.user_font_size-1),this.request_animation(100)},collapse:function(e,t,i){if(this.scene.children.length>0){e|=0,i|=0;for(var t=t||r.Easing.Circular.In,n={x:0,y:0,z:0},o=0;o<this.wnodes.length;o++){var a=this.wnodes[o];this.setPosition(a.position,n,e,t,i)}for(o=0;o<this.wedges.length;o++){var s=this.wedges[o];this.setPosition(s.geometry.vertices[0],n,e,t,i),this.setPosition(s.geometry.vertices[1],n,e,t,i)}this.request_animation()}},setFocus:function(e){null==e&&(e=new a.Vector3(0,0,0)),tween=new r.Tween(this.controls.target).to(e,this.changeFocusSpeed).start()},request_animation:function(e){if(e){this.ANIMATE=!0,this._animate_timeout_id&&(clearTimeout(this._animate_timeout_id),this._animate_timeout_id=null);var t=this;this._animate_timeout_id=setTimeout(function(){t.ANIMATE=!1},e)}this._timeout_id&&(clearTimeout(this._timeout_id),this._timeout_id=null,requestAnimationFrame(this.animate))},animate:function(){this.render();var e=r.getAll().length>0;if((this.ANIMATE||e||this.MOUSEDOWN||this.controls.AUTO_ROTATE)&&this.WINDOWVISIBLE)requestAnimationFrame(this.animate);else{var t=this;this._timeout_id=setTimeout(function(){requestAnimationFrame(t.animate)},5e3)}return this},render:function(){this.controls.update(),r.update();var e=this.renderer.domElement,t=e.getContext("2d");return t.globalAlpha=1,t.fillStyle=this.background_style,t.fillRect(0,0,e.width,e.height),this.renderer.DISPLAY_EDGE=this.show_edges,this.renderer.DISPLAY_EDGE_LABEL=this.show_edges&&this.DISPLAY_EDGE_LABEL,this.renderer.DISPLAY_ARROW_INIT=this.show_edges&&this.DISPLAY_ARROW_INIT,this.renderer.DISPLAY_ARROW_END=this.show_edges&&this.DISPLAY_ARROW_END,this.renderer.ENABLE_FOG=this.ENABLE_FOG,this.renderer.render(this.scene,this.camera),this.renderClustersLabels(t),this.debug&&this.print_debug(),this},renderClustersLabels:function(e){if(this.clustering){var t=this;for(var i in this.clustering.clusters.models){var n=this.clustering.clusters.models[i],o=0,r={x:0,y:0,minX:1e5,maxX:0,minY:1e5,maxY:0};n.members.vs.models.forEach(function(e,i){var n=t.wnidx[e.id];if(n&&!(n.screenX<0)){var a=n.screenX,s=n.screenY;o++,r.y+=s,r.x+=a,r.minX=Math.min(a,r.minX),r.maxX=Math.max(a,r.maxX)}});var a="Cluster "+i;if((n.labels||n.labels.length)&&(a=n.labels.map(function(e){return e.label}).join(", ")),a.length){e.font=Math.min(25,14+o)+"px Arial",e.lineWidth=3;var s=e.measureText(a).width,l=e.measureText("M").width;r.y=r.y/o,r.x=1==o?r.x-s/2:r.minX+(r.maxX-r.minX-s)/2,e.beginPath(),e.rect(r.x-8,r.y-5-l,s+16,l+16),e.fillStyle="rgba(200,200,200, 0.5)",e.fill();var c="rgb("+n.color.join(",")+")";e.fillStyle=c,e.strokeStyle="#333",e.strokeText(a,r.x,r.y),e.fillText(a,r.x,r.y)}}}},print_debug:function(){var e=$(".gviz-debug",this.$el),t=$("<div></div>").append(["camera.x:"+this.camera.position.x+"<br/>","camera.y:"+this.camera.position.y+"<br/>","camera.z:"+this.camera.position.z+"<br/>","user_vtx_size:"+this.user_vtx_size+"<br/>","<br/>"]),i=this.intersected;if(i){var n=this.wnidx[i.id],o=i;t.append("<h3>"+i._type+"</h3>"),n?t.append("obj.id:"+o.get("id")+"<br/>").append("obj.x:"+n.position.x+"<br/>").append("obj.y:"+n.position.y+"<br/>").append("obj.z:"+n.position.z+"<br/>").append("<br/>").append("neighbors:"+o.get("neighbors")+"<br/>").append("<br/>").append("flags:"+o.get("flags")+"<br/>").append("<br/>").append("distance:"+o._distance+"<br/>").append("ratio:"+o._ratio+"<br/>").append("scale:"+this.wnode_scale(o)+"<br/>").append("wscale:"+n.scale.x+"<br/>").append("material scale:"+n.program_material.scale+"<br/>").append("font scale:"+n.program_material.fontScale+"<br/>").append("<br/>"):t.append("flags:"+i.get("flags")+"<br/>")}e.html(t)},getMouseOnCanvas:function(e,t){return{x:e.clientX-t.left,y:e.clientY-t.top}},onMouseMove:function(e){e.preventDefault(),this.MOUSEHASMOVED=!0;if(!1===this.MOUSEDOWN){var t=this.el.getBoundingClientRect(),i=this.getMouseOnCanvas(e,t),n={x:i.x/$("canvas",this.$el).width()*2-1,y:-i.y/$("canvas",this.$el).height()*2+1},o=new a.Raycaster;o.linePrecision=this.raycaster_precision,o.setFromCamera(n,this.camera);var r=null,s=o.intersectObjects(this.scene.children);if(s.length>0){for(var l in s){var c=s[l].object;if(c.material&&0!=c.material.opacity&&c.visible){var d=c._type;if("vertex"==d){r=c._node,this.trigger("vertex:mouseover",r,e);break}if("edge"==d){r=c._edge,this.trigger("edge:mouseover",r,e);break}}}null==r&&this.trigger("intersectOff",this.intersected,e)}else this.trigger("intersectOff",this.intersected,e);this.intersected=r}},onMouseDown:function(e){e.preventDefault(),this.MOUSEDOWN=!0,this.MOUSEHASMOVED=!1,this.request_animation()},onMouseUp:function(e){e.preventDefault();var t=null;!1===this.MOUSEHASMOVED&&(this.intersected instanceof o.Edge?t="edge":this.intersected instanceof o.Vertex&&(t="vertex"),t&&this.trigger(t+":click",this.intersected,e),this.trigger("click",this.intersected,e)),this.MOUSEDOWN=!1},onMouseOut:function(e){e.preventDefault(),this.MOUSEDOWN=!1},onDblClick:function(e){n.trigger("dblclick",this.intersected,e);var t=null;this.intersected instanceof o.Edge?t="edge":this.intersected instanceof o.Vertex&&(t="vertex"),t?this.trigger(t+":dblclick",this.intersected,e):this.controls.AUTO_ROTATE=!this.controls.AUTO_ROTATE}}),m.ThreeVizHelpers={PI2:2*Math.PI,SPLIT_LABEL_RE:/^(.{4,15}) (.*)/m,to_color:function(e){if(t.isArray(e))return new a.Color(e[0],e[1],e[2])},meanColor:function(){var e=g=b=0;for(var t in arguments){var i=arguments[t];e+=i.r,g+=i.g,b+=i.b}return mean=new a.Color,mean.r=e/arguments.length,mean.g=g/arguments.length,mean.b=b/arguments.length,mean},wnode_scale:function(e){var t=e.get("SIZE");return this.user_vtx_size*t},render_node:function(e,i,n){var o=e,r=i._node;i.material_needs_update&&e.set_node_material(r);var a=i.program_material;if(a.opacity&&a.visible){if(n.globalAlpha=a.opacity,e.ENABLE_FOG&&null==r.flags[1]){var s=i.position.clone();s.add(e.camera.position),e.camera.worldToLocal(s);var l=1;l*=s.z>=-1?1:Math.exp(s.z/o.fogDistance),n.globalAlpha=a.opacity*l}var c=e.wnode_scale(r);if(e.adaptive_zoom){var d=e.camera.position.distanceTo(i.position),u=c/10;c=u+(1*c-u)*(0==d?1:d/1e3),r._scale=c}if(i.scale.x!=c&&(i.scale.x=c,i.scale.y=c),n.scale(1,-1),n.save(),e.show_nodes){var g=/^(rect:)([0-9/.]+),([0-9/.]+)/,f=null,v=a.scale,_=v,y=v;if(n.scale(v,v),r._scale*=v,"circle"==a.shape)n.beginPath(),n.arc(0,0,1,0,m.ThreeVizHelpers.PI2,!0),n.closePath();else if("square"==a.shape)n.beginPath(),n.moveTo(-1,-1),n.lineTo(-1,1),n.lineTo(1,1),n.lineTo(1,-1),n.lineTo(-1,-1),n.closePath();else if("losange"==a.shape||"diamond"==a.shape)n.beginPath(),n.moveTo(0,-1),n.lineTo(-1,0),n.lineTo(0,1),n.lineTo(1,0),n.closePath();else if("triangle"==a.shape||"triangle-top"==a.shape)n.beginPath(),n.moveTo(0,-1),n.lineTo(-1,1),n.lineTo(1,1),n.closePath();else if("triangle-bottom"==a.shape)n.beginPath(),n.moveTo(0,1),n.lineTo(-1,-1),n.lineTo(1,-1),n.closePath();else if(null!=(f=g.exec(a.shape))){var x=_=f[2],w=y=f[3];n.beginPath(),n.moveTo(-x,-w),n.lineTo(-x,w),n.lineTo(x,w),n.lineTo(x,-w),n.lineTo(-x,-w),n.closePath()}if(a.fillStyle&&(p(n,"fillStyle",a.fillStyle),n.fill()),e.show_images&&a.image){var b=document.getElementById("img"+a.id);b&&b.width&&(n.clip(),n.drawImage(b,-_,-y,2*_,2*y))}a.lineWidth>0&&a.strokeStyle&&(n.lineWidth=a.lineWidth,p(n,"strokeStyle",a.strokeStyle),n.stroke())}if(n.restore(),e.show_text&&a.textVisible){n.save();var S=a.text_lines;for(var E in S){n.save();var T=0,M=0,O=0,z=0|a.textPaddingX,A=0|a.textPaddingY,L=1;t.each(S[E],function(i){var r=o.node_materials[i.css].font;r=h(r,e.user_font_size),n.font=r,L=t.max([L,parseInt(/([0-9]*)px/.exec(r)[1])]),O+=n.measureText(i.form).width}),M="center"==a.textVerticalAlign?1:"bottom"==a.textVerticalAlign?0:.5,"left"==a.textAlign?(n.translate(1*a.scale,0),T=0):"right"==a.textAlign?(n.translate(-1*a.scale,0),T=0-O):(n.translate(0,1),T=O/-2+0),n.scale(a.fontScale,a.fontScale);var C=n.measureText("M").width;M=M-(S.length-1)*C/2+E*C,t.each(S[E],function(t,i){var r=o.node_materials[t.css],a=0|r.paddingRelX,s=(r.paddingRelY,h(r.font,e.user_font_size));parseInt(/([0-9]*)px/.exec(s)[1]);n.font=s;var l=T+z+a,c=M-A;r.fontFillStyle&&(p(n,"fillStyle",r.fontFillStyle),n.fillText(t.form,l,c)),r.fontStrokeStyle&&r.fontStrokeWidth&&(p(n,"strokeStyle",r.fontStrokeStyle),n.lineWidth=r.fontStrokeWidth,n.strokeText(t.form,l,c));var d=n.measureText(t.form).width;T+=d}),n.restore()}n.restore()}}},edge_materials:[{default:{lineWidth:2,linecap:"butt",linejoin:"bevel",lineType:"plain",dashSize:2,gapSize:5,opacity:.61,color:function(e){return[m.hexcolor(e.source.get("color")),m.hexcolor(e.target.get("color"))]},label_visible:!1,font:"normal 12px Arial",fontFillStyle:"#4C4D00",textAlign:"center",orientation_visible:!1}}],node_materials:[{default:{visible:!0,scale:1,z:1,opacity:1,line_max_length:15,shape:"circle",image:"prop:image",fillStyle:function(e){return"gradient:"+m.csscolor(e.get("color"))},strokeStyle:function(e){return"gradient:"+m.csscolor(e.get("color"))},lineWidth:.1,textLength:20,textVisible:!0,textAlign:"center",textVerticalAlign:"center",fontScale:.1,font:"normal 10px Arial",fontFillStyle:"#333",fontStrokeStyle:"#333",fontStrokeWidth:.1,paddingRelY:0,paddingRelX:2}},{".normal-font":{font:"normal 10px Arial",fontFillStyle:"#333",fontStrokeStyle:"#333",fontStrokeWidth:.1,paddingRelY:0,paddingRelX:2}}]};var f=m;return f.SimpleViz=function(e,i){i.model=e;var o=new f.ThreeViz(i);return o.on("click",function(e,t){null==e&&(n.trigger(s.unselect_nodes),n.trigger(s.unselect_edges),o.AUTO_FOCUS&&o.setFocus())}),o.on("vertex:click",function(t,i){if(t&&t.id&&t.has_flag&&0==t.has_flag("disabled")){var o=e.vs.by_flag("selected");1==o.length&&i.ctrlKey&&n.trigger(s.ui_create_edge,{source:o[0],target:t}),n.trigger(s.select_node,t)}}),o.on("vertex:mouseover",function(e,t){e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger("vertex:mouseover",e,t)}),o.on("vertex:dblclick",function(e,t){e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger("engine:expand_prox",{expand:[e.id],weights:[1]})}),o.on("edge:mouseover",function(e,t){e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger("edge:mouseover",e,t)}),o.on("edge:click",function(e,t){console.log("edge:click",e,t),e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger(s.select_edge,e,t)}),o.on("dblclick",function(e,t){console.log("dblclick",e,t)}),o.on("intersectOff",function(t,i){t&&t.id&&t.has_flag&&0==t.has_flag("disabled")&&(e.es.remove_flag("intersected"),e.vs.remove_flag("intersected"),t.edgetype&&n.trigger("edge:mouseout",t,i),t.nodetype&&n.trigger("vertex:mouseout",t,i),o.request_animation())}),n.listenTo(n,"vertex:mouseout",function(e,t){e&&e.id&&e.remove_flag("intersected")}),n.listenTo(n,"vertex:mouseover",function(t,i){t&&t.id&&(e.vs.set_intersected(null!==t?t:[]),e.es.set_intersected(t.incident(4,!1)),t.has_flag("selected")&&(this.vertex_menu=t),o.request_animation())}),n.listenTo(n,"engine:request_animation",function(){o.request_animation()}),n.listenTo(n,"edge:mouseover",function(t,i){t&&t.id&&(e.vs.set_intersected([]),e.es.set_intersected(null!==t?t:[]))}),n.listenTo(n,"edge:mouseout",function(e,t){e&&e.id&&e.remove_flag("intersected")}),o.listenTo(e.vs,"reset",function(){console.log("padagraph-gviz","vs reset"),o.collapse(500),o.clean(),o.camera.position.x=0,o.camera.position.y=0,o.camera.position.z=o.initial_z,o.camera.lookAt(new a.Vector3(0,0,0))}),o.listenTo(e.es,"add",function(e){o.append_edge(e),o.listenTo(e,"addflag:selected",function(){e.add_flag("es-bolder",{silent:!0}),e.add_flag("es-mo-adjacent")}),o.listenTo(e,"rmflag:selected",function(){e.remove_flag("es-bolder",{silent:!0}),e.remove_flag("es-mo-adjacent")}),o.listenTo(e,"addflag:intersected",function(){e.add_flag("es-bolder")}),o.listenTo(e,"rmflag:intersected",function(){e.remove_flag("es-bolder")})}),o.listenTo(e.es,"remove",function(e,t){e.remove_flag("intersected",{silent:!0}),e.remove_flag("selected",{silent:!0}),e.remove_flag("disabled"),o.remove_edge(e)}.bind(this)),o.listenTo(e.vs,"remove",function(e){e.remove_flag("intersected",{silent:!0}),e.remove_flag("selected",{silent:!0}),e.remove_flag("disabled"),o.remove_node(e)}.bind(this)),o.listenTo(e.vs,"add",function(i){_size=function(e){return e.get("properties").has("size")?parseFloat(e.get("properties").get("size")):1};var n=t.map(e.vs.models,_size).sort();n=n[n.length/2|1],t.each(e.vs.models,function(e){e.set("SIZE",_size(e)/n*9)}),o.append_node(i),o.listenTo(i,"addflag:intersected",function(){var n=i.neighbors();n.push(i),e.vs.add_flag("mo-faded",t(e.vs.models).difference(n)),e.vs.add_flag("mo-adjacent",t(n).without(i));var r=e.incident(i);e.es.add_flag("es-mo-adjacent",r,!1),e.es.add_flag("es-mo-faded",t.difference(e.es.models,r),!1),o.request_animation()}),o.listenTo(i,"rmflag:intersected",function(){e.vs.remove_flag("mo-faded",e.vs.models),e.vs.remove_flag("mo-adjacent"),e.es.remove_flag("es-mo-adjacent",e.es.models),e.es.remove_flag("es-mo-faded"),e.es.remove_flag("es-bolder"),o.request_animation()}),o.listenTo(i,"addflag:selected",function(n){n.collection.remove_flag("selected",t(e.vs.models).without(n));var r=i.neighbors();n.collection.add_flag("sel-faded",t(e.vs.models).difference(r)),n.collection.add_flag("sel-adjacent",t(r).without(n));var a=e.incident(n);e.es.add_flag("es-bolder",a,{silent:!0}),e.es.add_flag("es-sel-adjacent",a,{silent:!0}),e.es.add_flag("es-sel-faded",t(e.es.models).difference(a)),o.request_animation()}),e.listenTo(i,"rmflag:selected",function(t){e.vs.remove_flag("mo-faded"),e.vs.remove_flag("sel-faded"),e.vs.remove_flag("sel-adjacent"),e.es.remove_flag("es-bolder"),e.es.remove_flag("es-sel-adjacent"),e.es.remove_flag("es-sel-faded"),e.es.remove_flag("es-mo-faded")})}.bind(this)),o},a.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},a.RenderableFace=function(){this.id=0,this.v1=new a.RenderableVertex,this.v2=new a.RenderableVertex,this.v3=new a.RenderableVertex,this.normalModel=new a.Vector3,this.vertexNormalsModel=[new a.Vector3,new a.Vector3,new a.Vector3],this.vertexNormalsLength=0,this.color=new a.Color,this.material=null,this.uvs=[new a.Vector2,new a.Vector2,new a.Vector2],this.z=0,this.renderOrder=0},a.RenderableVertex=function(){this.position=new a.Vector3,this.positionWorld=new a.Vector3,this.positionScreen=new a.Vector4,this.visible=!0},a.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},a.RenderableLine=function(){this.id=0,this.v1=new a.RenderableVertex,this.v2=new a.RenderableVertex,this.vertexColors=[new a.Color,new a.Color],this.material=null,this.z=0,this.renderOrder=0},a.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new a.Vector2,this.material=null,this.renderOrder=0},a.Projector=function(){function e(){if(c===x){var e=new a.RenderableObject;return y.push(e),x++,c++,e}return y[c++]}function t(){if(h===b){var e=new a.RenderableVertex;return w.push(e),b++,h++,e}return w[h++]}function i(){if(u===E){var e=new a.RenderableFace;return S.push(e),E++,u++,e}return S[u++]}function n(){if(g===M){var e=new a.RenderableLine;return T.push(e),M++,g++,e}return T[g++]}function o(){if(v===z){var e=new a.RenderableSprite;return O.push(e),z++,v++,e}return O[v++]}function r(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function s(e,t){var i=0,n=1,o=e.z+e.w,r=t.z+t.w,a=-e.z+e.w,s=-t.z+t.w;return o>=0&&r>=0&&a>=0&&s>=0||!(o<0&&r<0||a<0&&s<0)&&(o<0?i=Math.max(i,o/(o-r)):r<0&&(n=Math.min(n,o/(o-r))),a<0?i=Math.max(i,a/(a-s)):s<0&&(n=Math.min(n,a/(a-s))),!(n<i)&&(e.lerp(t,i),t.lerp(e,1-n),!0))}var l,c,d,h,p,u,m,g,f,v,_,y=[],x=0,w=[],b=0,S=[],E=0,T=[],M=0,O=[],z=0,A={objects:[],lights:[],elements:[]},L=new a.Vector3,C=new a.Vector4,D=new a.Box3(new a.Vector3(-1,-1,-1),new a.Vector3(1,1,1)),R=new a.Box3,V=new Array(3),k=(new Array(4),new a.Matrix4),j=new a.Matrix4,P=new a.Matrix4,N=new a.Matrix3,I=new a.Frustum,W=new a.Vector4,F=new a.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var Y=new function(){var e=[],o=[],r=null,s=null,l=new a.Matrix3,c=function(e){var t=e.position,i=e.positionWorld,n=e.positionScreen;i.copy(t).applyMatrix4(_),n.copy(i).applyMatrix4(j);var o=1/n.w;n.x*=o,n.y*=o,n.z*=o,e.visible=n.x>=-1&&n.x<=1&&n.y>=-1&&n.y<=1&&n.z>=-1&&n.z<=1},h=function(e,t,i){return!0===e.visible||!0===t.visible||!0===i.visible||(V[0]=e.positionScreen,V[1]=t.positionScreen,V[2]=i.positionScreen,D.isIntersectionBox(R.setFromPoints(V)))},u=function(e,t,i){return(i.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(i.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0};return{setObject:function(t){s=(r=t).material,l.getNormalMatrix(r.matrixWorld),e.length=0,o.length=0},projectVertex:c,checkTriangleVisibility:h,checkBackfaceCulling:u,pushVertex:function(e,i,n){(d=t()).position.set(e,i,n),c(d)},pushNormal:function(t,i,n){e.push(t,i,n)},pushUv:function(e,t){o.push(e,t)},pushLine:function(e,t){var i=w[e],o=w[t];(m=n()).id=r.id,m.v1.copy(i),m.v2.copy(o),m.z=(i.positionScreen.z+o.positionScreen.z)/2,m.renderOrder=r.renderOrder,m.material=r.material,A.elements.push(m)},pushTriangle:function(t,n,c){var d=w[t],m=w[n],g=w[c];if(!1!==h(d,m,g)&&(s.side===a.DoubleSide||!0===u(d,m,g))){(p=i()).id=r.id,p.v1.copy(d),p.v2.copy(m),p.v3.copy(g),p.z=(d.positionScreen.z+m.positionScreen.z+g.positionScreen.z)/3,p.renderOrder=r.renderOrder,p.normalModel.fromArray(e,3*t),p.normalModel.applyMatrix3(l).normalize();for(var f=0;f<3;f++){var v=p.vertexNormalsModel[f];v.fromArray(e,3*arguments[f]),v.applyMatrix3(l).normalize(),p.uvs[f].fromArray(o,2*arguments[f])}p.vertexNormalsLength=3,p.material=r.material,A.elements.push(p)}}}};this.projectScene=function(d,y,x,b){u=0,g=0,v=0,A.elements.length=0,!0===d.autoUpdate&&d.updateMatrixWorld(),null===y.parent&&y.updateMatrixWorld(),k.copy(y.matrixWorldInverse.getInverse(y.matrixWorld)),j.multiplyMatrices(y.projectionMatrix,k),I.setFromMatrix(j),c=0,A.objects.length=0,A.lights.length=0,d.traverseVisible(function(t){if(t instanceof a.Light)A.lights.push(t);else if(t instanceof a.Mesh||t instanceof a.Line||t instanceof a.Sprite){if(!1===t.material.visible)return;!1!==t.frustumCulled&&!0!==I.intersectsObject(t)||((l=e()).id=t.id,l.object=t,L.setFromMatrixPosition(t.matrixWorld),L.applyProjection(j),l.z=L.z,l.renderOrder=t.renderOrder,A.objects.push(l))}}),!0===x&&A.objects.sort(r);for(var S=0,E=A.objects.length;S<E;S++){var T=A.objects[S].object,M=T.geometry;if(Y.setObject(T),_=T.matrixWorld,h=0,T instanceof a.Mesh){if(M instanceof a.BufferGeometry){var O=M.attributes,z=M.groups;if(void 0===O.position)continue;for(var D=0,R=(we=O.position.array).length;D<R;D+=3)Y.pushVertex(we[D],we[D+1],we[D+2]);if(void 0!==O.normal)for(var V=O.normal.array,D=0,R=V.length;D<R;D+=3)Y.pushNormal(V[D],V[D+1],V[D+2]);if(void 0!==O.uv)for(var B=O.uv.array,D=0,R=B.length;D<R;D+=2)Y.pushUv(B[D],B[D+1]);if(null!==M.index){var U=M.index.array;if(z.length>0)for(S=0;S<z.length;S++)for(var q=z[S],D=q.start,R=q.start+q.count;D<R;D+=3)Y.pushTriangle(U[D],U[D+1],U[D+2]);else for(var D=0,R=U.length;D<R;D+=3)Y.pushTriangle(U[D],U[D+1],U[D+2])}else for(var D=0,R=we.length/3;D<R;D+=3)Y.pushTriangle(D,D+1,D+2)}else if(M instanceof a.Geometry){var X=M.vertices,G=M.faces,H=M.faceVertexUvs[0];N.getNormalMatrix(_);for(var Z=T.material,$=Z instanceof a.MeshFaceMaterial,Q=!0===$?T.material:null,J=0,K=X.length;J<K;J++){var ee=X[J];if(L.copy(ee),!0===Z.morphTargets)for(var te=M.morphTargets,ie=T.morphTargetInfluences,ne=0,oe=te.length;ne<oe;ne++){var re=ie[ne];if(0!==re){var ae=te[ne].vertices[J];L.x+=(ae.x-ee.x)*re,L.y+=(ae.y-ee.y)*re,L.z+=(ae.z-ee.z)*re}}Y.pushVertex(L.x,L.y,L.z)}for(var se=0,le=G.length;se<le;se++){var ce=G[se];if(void 0!==(Z=!0===$?Q.materials[ce.materialIndex]:T.material)){var de=Z.side,he=w[ce.a],pe=w[ce.b],ue=w[ce.c];if(!1!==Y.checkTriangleVisibility(he,pe,ue)){var me=Y.checkBackfaceCulling(he,pe,ue);if(de!==a.DoubleSide){if(de===a.FrontSide&&!1===me)continue;if(de===a.BackSide&&!0===me)continue}(p=i()).id=T.id,p.v1.copy(he),p.v2.copy(pe),p.v3.copy(ue),p.normalModel.copy(ce.normal),!1!==me||de!==a.BackSide&&de!==a.DoubleSide||p.normalModel.negate(),p.normalModel.applyMatrix3(N).normalize();for(var ge=ce.vertexNormals,fe=0,ve=Math.min(ge.length,3);fe<ve;fe++){var _e=p.vertexNormalsModel[fe];_e.copy(ge[fe]),!1!==me||de!==a.BackSide&&de!==a.DoubleSide||_e.negate(),_e.applyMatrix3(N).normalize()}p.vertexNormalsLength=ge.length;var ye=H[se];if(void 0!==ye)for(var xe=0;xe<3;xe++)p.uvs[xe].copy(ye[xe]);p.color=ce.color,p.material=Z,p.z=(he.positionScreen.z+pe.positionScreen.z+ue.positionScreen.z)/3,p.renderOrder=T.renderOrder,A.elements.push(p)}}}}}else if(T instanceof a.Line){if(M instanceof a.BufferGeometry){if(void 0!==(O=M.attributes).position){for(var we=O.position.array,D=0,R=we.length;D<R;D+=3)Y.pushVertex(we[D],we[D+1],we[D+2]);if(null!==M.index)for(var D=0,R=(U=M.index.array).length;D<R;D+=2)Y.pushLine(U[D],U[D+1]);else for(var be=T instanceof a.LineSegments?2:1,D=0,R=we.length/3-1;D<R;D+=be)Y.pushLine(D,D+1)}}else if(M instanceof a.Geometry){if(P.multiplyMatrices(j,_),0===(X=T.geometry.vertices).length)continue;(he=t()).positionScreen.copy(X[0]).applyMatrix4(P);for(var be=T instanceof a.LineSegments?2:1,J=1,K=X.length;J<K;J++)(he=t()).positionScreen.copy(X[J]).applyMatrix4(P),(J+1)%be>0||(pe=w[h-2],W.copy(he.positionScreen),F.copy(pe.positionScreen),!0===s(W,F)&&(W.multiplyScalar(1/W.w),F.multiplyScalar(1/F.w),(m=n()).id=T.id,m.v1.positionScreen.copy(W),m.v2.positionScreen.copy(F),m.z=Math.max(W.z,F.z),m.renderOrder=T.renderOrder,m.material=T.material,m.object=T,T.material.vertexColors===a.VertexColors&&(m.vertexColors[0].copy(T.geometry.colors[J]),m.vertexColors[1].copy(T.geometry.colors[J-1])),A.elements.push(m)))}}else if(T instanceof a.Sprite){C.set(_.elements[12],_.elements[13],_.elements[14],1),C.applyMatrix4(j);var Se=1/C.w;C.z*=Se,C.z>=-1&&C.z<=1&&((f=o()).id=T.id,f.x=C.x*Se,f.y=C.y*Se,f.z=C.z,f.renderOrder=T.renderOrder,f.object=T,f.rotation=T.rotation,f.scale.x=T.scale.x*Math.abs(f.x-(C.x+y.projectionMatrix.elements[0])/(C.w+y.projectionMatrix.elements[12])),f.scale.y=T.scale.y*Math.abs(f.y-(C.y+y.projectionMatrix.elements[5])/(C.w+y.projectionMatrix.elements[13])),f.material=T.material,A.elements.push(f))}}return!0===b&&A.elements.sort(r),A}},a.SpriteCanvasMaterial=function(e){a.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new a.Color(16777215),this.program=function(e,t){},this.setValues(e)},a.SpriteCanvasMaterial.prototype=Object.create(a.Material.prototype),a.SpriteCanvasMaterial.prototype.constructor=a.SpriteCanvasMaterial,a.SpriteCanvasMaterial.prototype.clone=function(){var e=new a.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},m.GraphRenderer=function(e){function t(e,t,i){l(i.opacity),c(i.blending);var n=t.scale.x*D,s=t.scale.y*R,d=.5*Math.sqrt(n*n+s*s);if(G.min.set(e.x-d,e.y-d),G.max.set(e.x+d,e.y+d),i instanceof a.SpriteMaterial||i instanceof a.ParticleSystemMaterial){var h=i.map;if(null!==h){!1===h.hasEventListener("update",o)&&(void 0!==h.image&&h.image.width>0&&r(h),h.addEventListener("update",o));var p=U[h.id];m(void 0!==p?p:"rgba( 0, 0, 0, 1 )");var g=h.image,f=g.width*h.offset.x,v=g.height*h.offset.y,_=g.width*h.repeat.x,y=g.height*h.repeat.y,x=n/_,w=s/y;V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.translate(-n/2,-s/2),V.scale(x,w),V.translate(-f,-v),V.fillRect(f,v,_,y),V.restore()}else m(i.color.getStyle()),V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.scale(n,-s),V.fillRect(-.5,-.5,1,1),V.restore()}else i instanceof a.SpriteCanvasMaterial&&(u(i.color.getStyle()),m(i.color.getStyle()),V.save(),V.translate(e.x,e.y),0!==i.rotation&&V.rotate(i.rotation),V.scale(n,s),i.program(V),V.restore())}function i(e,t,i,o){if(l(o.opacity),c(o.blending),d(o.linewidth),h(o.linecap),p(o.linejoin),0!=O.DISPLAY_EDGE&&0!=o.opacity){var r=i.object._edge.source,s=i.object._edge.target;if(r&&s){var m=t.positionScreen.x-e.positionScreen.x,g=t.positionScreen.y-e.positionScreen.y;if(0!=m||0!=g){var f=e.positionScreen.x,v=t.positionScreen.x,_=e.positionScreen.y,y=t.positionScreen.y,x=f<v,w=Math.sqrt(Math.pow(m,2)+Math.pow(g,2)),b=Math.atan((y-_)/(v-f));f==v?y-_>0?b+=Math.PI/2:y<_&&(b-=Math.PI/2):f>v&&(b+=Math.PI),V.save(),V.translate(e.positionScreen.x,e.positionScreen.y+5),V.rotate(b),V.scale(1,-1);o.opacity;if(o.vertexColors!==a.VertexColors)V.strokeStyle=o.color.getStyle();else{var S=i.vertexColors[0].getStyle(),E=i.vertexColors[1].getStyle();if(S===E)V.strokeStyle=S;else{try{var T=V.createLinearGradient(0,0,w,0);T.addColorStop(0,S),T.addColorStop(1,E)}catch(e){T=S}V.strokeStyle=T}}"dashed"==o.lineType?V.setLineDash([o.dashSize,o.gapSize]):V.setLineDash([]),V.beginPath(),V.moveTo(0,0),V.lineTo(w,0),V.closePath(),V.stroke(),G.expandByScalar(2*o.linewidth),V.setLineDash([]);var M="";V.translate(w/2,0),O.DISPLAY_EDGE_LABEL&&o.label_visible&&(V.save(),(M=i.object._edge.label)||(M=x?s.label+" <--- "+r.label:r.label+" ---\x3e "+s.label),x||V.scale(-1,-1),V.textAlign=o.textAlign,V.font=o.font,V.fillStyle=o.fontFillStyle,V.fillText(M,0,-2),V.restore());if(O.DISPLAY_ARROW_END&&o.orientation_visible){z=1.6*(s._scale/s._distance*1e3+3);V.save(),V.translate(-w/2+z,0),V.scale(-3,-3),u(E),n(0,.5,0,-.5,1,0),V.stroke(),V.restore()}if(O.DISPLAY_ARROW_INIT&&o.orientation_visible){var z=1.6*(r._scale/r._distance*1e3+3)+5;V.save(),V.translate(w/2-z,0),V.scale(-3,-3),u(S),n(0,.5,0,-.5,1,0),V.stroke(),V.restore()}V.restore()}}}}function n(e,t,i,n,o,r){V.beginPath(),V.moveTo(e,t),V.lineTo(i,n),V.lineTo(o,r),V.closePath()}function o(e){r(e.target)}function r(e){var t=e.wrapS===a.RepeatWrapping,i=e.wrapT===a.RepeatWrapping,n=e.image,o=document.createElement("canvas");o.width=n.width,o.height=n.height;var r=o.getContext("2d");r.setTransform(1,0,0,-1,0,n.height),r.drawImage(n,0,0),U[e.id]=V.createPattern(o,!0===t&&!0===i?"repeat":!0===t&&!1===i?"repeat-x":!1===t&&!0===i?"repeat-y":"no-repeat")}function s(e,t,i){var n,o=t.x-e.x,r=t.y-e.y,a=o*o+r*r;0!==a&&(o*=n=i/Math.sqrt(a),r*=n,t.x+=o,t.y+=r,e.x-=o,e.y-=r)}function l(e){P!==e&&(V.globalAlpha=e,P=e)}function c(e){N!==e&&(e===a.NormalBlending?V.globalCompositeOperation="source-over":e===a.AdditiveBlending?V.globalCompositeOperation="lighter":e===a.SubtractiveBlending&&(V.globalCompositeOperation="darker"),N=e)}function d(e){F!==e&&(V.lineWidth=e,F=e)}function h(e){Y!==e&&(V.lineCap=e,Y=e)}function p(e){B!==e&&(V.lineJoin=e,B=e)}function u(e){I!==e&&(V.strokeStyle=e,I=e)}function m(e){W!==e&&(V.fillStyle=e,W=e)}console.log("gviz.CanvasRenderer based on THREE ",a.REVISION);a.Math.smoothstep;e=e||{};var g,f,v,_,y,x,w,b,S,E,T,M,O=this,z=new a.Projector,A=void 0!==e.canvas?e.canvas:document.createElement("canvas"),L=A.width,C=A.height,D=Math.floor(L/2),R=Math.floor(C/2),V=A.getContext("2d",{alpha:!0===e.alpha}),k=new a.Color(0),j=0,P=1,N=0,I=null,W=null,F=null,Y=null,B=null,U=(new a.RenderableVertex,new a.RenderableVertex,new a.Color,new a.Color,new a.Color,new a.Color,new a.Color,new a.Color,new a.Color,new a.Color,{}),q=new a.Box2,X=new a.Box2,G=new a.Box2,H=(new a.Color,new a.Color,new a.Color,new a.Vector3,new a.Vector3,new a.Matrix3),Z=16;(b=document.createElement("canvas")).width=b.height=2,(S=b.getContext("2d")).fillStyle="rgba(0,0,0,1)",S.fillRect(0,0,2,2),(E=S.getImageData(0,0,2,2)).data,(T=document.createElement("canvas")).width=T.height=Z,(M=T.getContext("2d")).translate(-Z/2,-Z/2),M.scale(Z,Z),Z--,this.DISPLAY_EDGE=!0,this.DISPLAY_EDGE_LABEL=!0,this.DISPLAY_ARROW_INIT=!0,this.DISPLAY_ARROW_END=!0,this.ENABLE_FOG=!0,void 0===V.setLineDash&&(void 0!==V.mozDash?V.setLineDash=function(e){V.mozDash=null!==e[0]?e:null}:V.setLineDash=function(){}),this.domElement=A,this.devicePixelRatio=void 0!==e.devicePixelRatio?e.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setSize=function(e,t,i){L=e*this.devicePixelRatio,C=t*this.devicePixelRatio,D=Math.floor(L/2),R=Math.floor(C/2),A.width=L,A.height=C,1!==this.devicePixelRatio&&!1!==i&&(A.style.width=e+"px",A.style.height=t+"px"),q.min.set(-D,-R),q.max.set(D,R),X.min.set(-D,-R),X.max.set(D,R),P=1,N=0,I=null,W=null,F=null,Y=null,B=null},this.setClearColor=function(e,t){k.set(e),j=void 0!==t?t:1,X.min.set(-D,-R),X.max.set(D,R)},this.setClearColorHex=function(e,t){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getMaxAnisotropy=function(){return 0},this.clear=function(){V.setTransform(1,0,0,-1,D,R),!1===X.isEmpty()&&(X.intersect(q),X.expandByScalar(2),j<1&&V.clearRect(0|X.min.x,0|X.min.y,X.max.x-X.min.x|0,X.max.y-X.min.y|0),j>0&&(c(a.NormalBlending),l(1),m("rgba("+Math.floor(255*k.r)+","+Math.floor(255*k.g)+","+Math.floor(255*k.b)+","+j+")"),V.fillRect(0|X.min.x,0|X.min.y,X.max.x-X.min.x|0,X.max.y-X.min.y|0)),X.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,n){if(n instanceof a.Camera!=!1){!0===this.autoClear&&this.clear(),V.setTransform(1,0,0,-1,D,R),O.info.render.vertices=0,O.info.render.faces=0,g=z.projectScene(e,n,this.sortObjects,this.sortElements),f=g.elements,v=g.lights,_=n,H.getNormalMatrix(n.matrixWorldInverse);for(var o=0,r=f.length;o<r;o++){var l=f[o],c=l.material;if(void 0!==c&&!1!==c.visible){if(G.makeEmpty(),l instanceof a.RenderableSprite){(y=l).x*=D,y.y*=R,l.object.x=y.x,l.object.y=y.y;var d=new a.Vector3;d.setFromMatrixPosition(l.object.matrixWorld),d.project(n),d.x=d.x*D+D,d.y=-d.y*R+R,l.object.screenX=d.x,l.object.screenY=d.y,t(y,l,c)}else if(l instanceof a.RenderableLine)y=l.v1,x=l.v2,y.positionScreen.x*=D,y.positionScreen.y*=R,x.positionScreen.x*=D,x.positionScreen.y*=R,G.setFromPoints([y.positionScreen,x.positionScreen]),!0===q.intersectsBox(G)&&i(y,x,l,c);else if(l instanceof a.RenderableFace){if(y=l.v1,x=l.v2,w=l.v3,y.positionScreen.z<-1||y.positionScreen.z>1)continue;if(x.positionScreen.z<-1||x.positionScreen.z>1)continue;if(w.positionScreen.z<-1||w.positionScreen.z>1)continue;y.positionScreen.x*=D,y.positionScreen.y*=R,x.positionScreen.x*=D,x.positionScreen.y*=R,w.positionScreen.x*=D,w.positionScreen.y*=R,c.overdraw>0&&(s(y.positionScreen,x.positionScreen,c.overdraw),s(x.positionScreen,w.positionScreen,c.overdraw),s(w.positionScreen,y.positionScreen,c.overdraw)),G.setFromPoints([y.positionScreen,x.positionScreen,w.positionScreen]),!0===q.intersectsBox(G)&&renderFace3(y,x,w,0,1,2,l,c)}X.union(G)}}V.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}},m.Layout.ForceDirected={run:function(e,t){var i,n,o,r,s,l,c,d,h,p,u,m,g,f;for(s=e,i=(t=t||{}).hasOwnProperty("iterations")?t.iterations:1e4,n=t.hasOwnProperty("forceStrength")?t.forceStrength:10,o=.01,2,50,h=new a.Vector3,e.vs.each(function(e){e.position=new a.Vector3(Math.random(),Math.random(),Math.random()),e.force=new a.Vector3(Math.random(),Math.random(),Math.random())}),r=function(){o-=.01/i;var t=e.vs.elements,r=e.vs.elements;for(c=0;c<t.length;c+=1)for(d=0;d<t.length;d+=1)c!==d&&(u=t[c],m=t[d],h.subVectors(m.position,u.position),(p=h.length())<.1&&(h.set(Math.random(),Math.random(),Math.random()).multiplyScalar(.1).addScalar(.1),p=h.length()),p<50&&(h.multiplyScalar(n*n/(p*p)),u.force.sub(h.clone().multiplyScalar(m.scale.x)),m.force.add(h.clone().multiplyScalar(u.scale.x))));for(c=0;c<r.length;c+=1)u=t[r[c].source],m=t[r[c].target],h.subVectors(m.position,u.position),(p=h.length())<.1&&(h.set(a.Math.randFloat(.1,.2),a.Math.randFloat(.1,.2),a.Math.randFloat(.1,.2)),p=h.length()),p=Math.min(p,50),h.multiplyScalar((p*p-n*n)/(p*n)),u.force.add(h.clone().multiplyScalar(m.scale.x)),m.force.sub(h.clone().multiplyScalar(u.scale.x));for(c=0;c<t.length;c+=1)(u=t[c]).force.multiplyScalar(o),u.force.setX(a.Math.clamp(u.force.x,-2,2)),u.force.setY(a.Math.clamp(u.force.y,-2,2)),u.force.setZ(a.Math.clamp(u.force.z,-2,2)),u.position.add(u.force),u.force.set(0,0,0);for(c=0;c<r.length;c+=1)g=r[c],u=t[g.source],m=t[g.target],p=m.position.distanceTo(u.position),g.position.addVectors(u.position,m.position).divideScalar(2),g.lookAt(m.position),g.scale.z=p,s.directed&&((f=s.arrows[c]).position.copy(g.position),f.lookAt(m.position))},l=0;l<i;l+=1)setTimeout(r,0)}},f});