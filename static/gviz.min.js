/*!  04-01-2021 */

!function(e,a){"function"==typeof define&&define.amd?define(["underscore","backbone","cello","tween","threejs","pdgconst"],function(e,t,i,n,o,r){return a(0,e,t,i,n,o,r)}):e.Gviz=a(0,_,Backbone,Cello,TWEEN,THREE,Const)}(this,function(e,O,n,a,c,Ee,s){Ee.TrackballControls=function(e,t){var r=this,a={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=5e3,this.keys=[65,83,68],this.AUTO_ROTATE=!1,this.autoRotateSpeed=.005,this.target=new Ee.Vector3;var i=new Ee.Vector3,s=a.NONE,n=a.NONE,o=new Ee.Vector3,l=new Ee.Vector2,c=new Ee.Vector2,d=new Ee.Vector3,h=0,p=new Ee.Vector2,u=new Ee.Vector2,m=0,g=0,f=new Ee.Vector2,v=new Ee.Vector2;_MOUSEDOWN=!1,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var _={type:"change"},y={type:"start"},x={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}},this.handleEvent=function(e){"function"==typeof this[e.type]&&this[e.type](e)};var w,b,S,E,T,M,O,z,A,L,C,D,R=(w=new Ee.Vector2,function(e,t){return w.set((e-r.screen.left)/r.screen.width,(t-r.screen.top)/r.screen.height),w}),V=(b=new Ee.Vector2,function(e,t){return b.set((e-.5*r.screen.width-r.screen.left)/(.5*r.screen.width),(r.screen.height+2*(r.screen.top-t))/r.screen.width),b});function k(e){!1!==r.enabled&&(window.removeEventListener("keydown",k),(n=s)===a.NONE&&(e.keyCode!==r.keys[a.ROTATE]||r.noRotate?e.keyCode!==r.keys[a.ZOOM]||r.noZoom?e.keyCode!==r.keys[a.PAN]||r.noPan||(s=a.PAN):s=a.ZOOM:s=a.ROTATE))}function P(e){!1!==r.enabled&&(s=n,window.addEventListener("keydown",k,!1))}function j(e){!1!==r.enabled&&(_MOUSEDOWN=!0,e.preventDefault(),e.stopPropagation(),s===a.NONE&&(s=e.button),s!==a.ROTATE||r.noRotate?s!==a.ZOOM||r.noZoom?s!==a.PAN||r.noPan||(f.copy(R(e.pageX,e.pageY)),v.copy(f)):(p.copy(R(e.pageX,e.pageY)),u.copy(p)):(c.copy(V(e.pageX,e.pageY)),l.copy(c)),document.addEventListener("mousemove",N,!1),document.addEventListener("mouseup",I,!1),r.dispatchEvent(y))}function N(e){!1!==r.enabled&&(e.preventDefault(),e.stopPropagation(),s!==a.ROTATE||r.noRotate?s!==a.ZOOM||r.noZoom?s!==a.PAN||r.noPan||v.copy(R(e.pageX,e.pageY)):u.copy(R(e.pageX,e.pageY)):(l.copy(c),c.copy(V(e.pageX,e.pageY))))}function I(e){!1!==r.enabled&&(_MOUSEDOWN=!1,e.preventDefault(),e.stopPropagation(),s=a.NONE,document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",I),r.dispatchEvent(x))}function W(e){if(!1!==r.enabled){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta?t=e.wheelDelta/40:e.detail&&(t=-e.detail/3),p.y+=.01*t,r.dispatchEvent(y),r.dispatchEvent(x)}}function F(e){if(!1!==r.enabled){switch(e.touches.length){case 1:s=a.TOUCH_ROTATE,c.copy(V(e.touches[0].pageX,e.touches[0].pageY)),l.copy(c);break;case 2:s=a.TOUCH_ZOOM_PAN;var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;g=m=Math.sqrt(t*t+i*i);var n=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;f.copy(R(n,o)),v.copy(f);break;default:s=a.NONE}r.dispatchEvent(y)}}function Y(e){if(!1!==r.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:l.copy(c),c.copy(V(e.touches[0].pageX,e.touches[0].pageY));break;case 2:var t=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY;g=Math.sqrt(t*t+i*i);var n=(e.touches[0].pageX+e.touches[1].pageX)/2,o=(e.touches[0].pageY+e.touches[1].pageY)/2;v.copy(R(n,o));break;default:s=a.NONE}}function B(e){if(!1!==r.enabled){switch(e.touches.length){case 1:l.copy(c),c.copy(V(e.touches[0].pageX,e.touches[0].pageY));break;case 2:m=g=0;var t=(e.touches[0].pageX+e.touches[1].pageX)/2,i=(e.touches[0].pageY+e.touches[1].pageY)/2;v.copy(R(t,i)),f.copy(v)}s=a.NONE,r.dispatchEvent(x)}}function U(e){e.preventDefault()}this.rotateCamera=(E=new Ee.Vector3,T=new Ee.Quaternion,M=new Ee.Vector3,O=new Ee.Vector3,z=new Ee.Vector3,A=new Ee.Vector3,function(){this.AUTO_ROTATE&&!_MOUSEDOWN&&(c.x=l.x+this.autoRotateSpeed),A.set(c.x-l.x,c.y-l.y,0),(S=A.length())?(o.copy(r.object.position).sub(r.target),M.copy(o).normalize(),O.copy(r.object.up).normalize(),z.crossVectors(O,M).normalize(),O.setLength(c.y-l.y),z.setLength(c.x-l.x),A.copy(O.add(z)),E.crossVectors(A,o).normalize(),S*=r.rotateSpeed,T.setFromAxisAngle(E,S),o.applyQuaternion(T),r.object.up.applyQuaternion(T),d.copy(E),h=S):!r.staticMoving&&h&&(h*=Math.sqrt(1-r.dynamicDampingFactor),o.copy(r.object.position).sub(r.target),T.setFromAxisAngle(d,h),o.applyQuaternion(T),r.object.up.applyQuaternion(T)),l.copy(c)}),this.zoomCamera=function(){var e;s===a.TOUCH_ZOOM_PAN?(e=m/g,m=g,o.multiplyScalar(e)):1!==(e=1+(u.y-p.y)*r.zoomSpeed)&&0<e&&(o.multiplyScalar(e),r.staticMoving?p.copy(u):p.y+=(u.y-p.y)*this.dynamicDampingFactor)},this.panCamera=(L=new Ee.Vector2,C=new Ee.Vector3,D=new Ee.Vector3,function(){L.copy(v).sub(f),L.lengthSq()&&(L.multiplyScalar(o.length()*r.panSpeed),D.copy(o).cross(r.object.up).setLength(L.x),D.add(C.copy(r.object.up).setLength(L.y)),r.object.position.add(D),r.target.add(D),r.staticMoving?f.copy(v):f.add(L.subVectors(v,f).multiplyScalar(r.dynamicDampingFactor)))}),this.checkDistances=function(){r.noZoom&&r.noPan||(o.lengthSq()>r.maxDistance*r.maxDistance&&(r.object.position.addVectors(r.target,o.setLength(r.maxDistance)),p.copy(u)),o.lengthSq()<r.minDistance*r.minDistance&&(r.object.position.addVectors(r.target,o.setLength(r.minDistance)),p.copy(u)))},this.update=function(){o.subVectors(r.object.position,r.target),r.noRotate||r.rotateCamera(),r.noZoom||r.zoomCamera(),r.noPan||r.panCamera(),r.object.position.addVectors(r.target,o),r.checkDistances(),r.object.lookAt(r.target),1e-6<i.distanceToSquared(r.object.position)&&(r.dispatchEvent(_),i.copy(r.object.position))},this.reset=function(){s=a.NONE,n=a.NONE,r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.up.copy(r.up0),o.subVectors(r.object.position,r.target),r.object.lookAt(r.target),r.dispatchEvent(_),i.copy(r.object.position)},this.dispose=function(){this.domElement.removeEventListener("contextmenu",U,!1),this.domElement.removeEventListener("mousedown",j,!1),this.domElement.removeEventListener("mousewheel",W,!1),this.domElement.removeEventListener("DOMMouseScroll",W,!1),this.domElement.removeEventListener("touchstart",F,!1),this.domElement.removeEventListener("touchend",B,!1),this.domElement.removeEventListener("touchmove",Y,!1),document.removeEventListener("mousemove",N,!1),document.removeEventListener("mouseup",I,!1),document.removeEventListener("mouseout",I,!1),window.removeEventListener("keydown",k,!1),window.removeEventListener("keyup",P,!1)},this.domElement.addEventListener("contextmenu",U,!1),this.domElement.addEventListener("mousedown",j,!1),this.domElement.addEventListener("mousewheel",W,!1),this.domElement.addEventListener("DOMMouseScroll",W,!1),this.domElement.addEventListener("touchstart",F,!1),this.domElement.addEventListener("touchend",B,!1),this.domElement.addEventListener("touchmove",Y,!1),window.addEventListener("keydown",k,!1),window.addEventListener("keyup",P,!1),this.handleResize(),this.update()},Ee.TrackballControls.prototype=Object.create(Ee.EventDispatcher.prototype),Ee.TrackballControls.prototype.constructor=Ee.TrackballControls;Ee=window.THREE,c=window.TWEEN;function h(e,t,i){i|=1;var n=-1,o=0,r=e.split(" ");for(var a in r.length,r){if(t<(o+=r[a=parseInt(a)].length)+(n=a)&&i<=n)break;n+=1}return[r.slice(0,n).join(" "),r.slice(n).join(" ")]}function z(e,t){var i=parseInt(/([0-9]*)px/.exec(e)[1]);return i+=parseInt(t),e.replace(/[0-9]+(.*)/,i+"$1")}function A(e,t,i){if(O.isArray(i)&&3==i.length)style="rgb("+i.join(",")+")";else if(O.isArray(i)&&2==i.length)for(var n in style=e.createLinearGradient(-.5,-.5,.5,.5),i)style.addColorStop(n,i[n]);else if("gradient:"==i.substring(0,9)){var o=new Ee.Color(i.substring(9)),r=d(o.r,o.g,o.b),a="rgb("+l(r[0],r[1],60).join(",")+")";style=e.createLinearGradient(-.5,-.5,.5,.5),style.addColorStop(0,a),style.addColorStop(1,o.getStyle())}else style=i;e[t]=style}var l=a.utils.hsvToRgb,d=a.utils.rgbToHsv,L={Layout:{},hexcolor:function(e){var t=O.map(e,function(e){return e/255});return new Ee.Color(t[0],t[1],t[2]).getHex()},csscolor:function(e){var t=O.map(e,function(e){return e/255});return new Ee.Color(t[0],t[1],t[2]).getStyle()},DEFAULTS:{show_nodes:!0,show_edges:!0,show_text:!0,show_images:!0,background_color:11184810,user_font_size:3,user_vtx_size:1,initial_size:10,initial_z:1400,raycaster_precision:2,adaptive_zoom:!1,use_material_transitions:!0,force_position_no_delay:!1,node_material_transition_delay:100,edge_material_transition_delay:200,auto_rotate:!1,debug:!1}};L.ThreeViz=n.View.extend({initialize:function(e){var n=this;attrs=O.extend({},L.DEFAULTS,e),attrs.el||(attrs.el="#vz_threejs_main"+Math.round(1e4*Math.random())),this.show_nodes=attrs.show_nodes,this.show_edges=attrs.show_edges,this.show_images=attrs.show_images,this.show_text=attrs.show_text,this.DISPLAY_EDGE_LABEL=attrs.DISPLAY_EDGE_LABEL||!0,this.DISPLAY_ARROW_INIT=attrs.DISPLAY_ARROW_INIT||!1,this.DISPLAY_ARROW_END=attrs.DISPLAY_ARROW_END||!1,this.AUTO_FOCUS=attrs.AUTO_FOCUS,this.ENABLE_FOG=attrs.ENABLE_FOG,this.auto_rotate=attrs.auto_rotate||!1,this.initial_size=attrs.initial_size,this.initial_z=attrs.initial_z,this.user_vtx_size=attrs.user_vtx_size,this.user_font_size=attrs.user_font_size,this.background_color=attrs.background_color,this.render_node=attrs.render_node||L.ThreeVizHelpers.render_node,this.wnode_scale=attrs.wnode_scale||L.ThreeVizHelpers.wnode_scale,this.raycaster_precision=attrs.raycaster_precision,this.force_position_no_delay=attrs.force_position_no_delay,this.edge_materials={},this.node_materials={},this.use_material_transitions=attrs.use_material_transitions,this.node_material_transition_delay=attrs.node_material_transition_delay,this.edge_material_transition_delay=attrs.edge_material_transition_delay;function t(e,i){O.each(e,function(e){var t=O.keys(e)[0];n.add_material(i,t,e[t])})}return t(L.ThreeVizHelpers.edge_materials,"edge"),t(L.ThreeVizHelpers.node_materials,"node"),attrs.materials&&(attrs.materials.node&&t(attrs.materials.node,"node"),attrs.materials.edge&&t(attrs.materials.edge,"edge")),this.adaptive_zoom=attrs.adaptive_zoom,this.debug=attrs.debug,this._width=attrs.width||-1,this._height=attrs.height||-1,a.get(this,"width",function(){var e=n.$el.width();return e<=0&&(e=$(window).width()),0<n._width?n._width:e}),a.get(this,"height",function(){var e=n.$el.height();return e<=0&&(e=$(window).height()),0<n._height?n._height:e}),this.clear_color=new Ee.Color(attrs.background_color),this._inited=!1,this.wnodes=[],this.wedges=[],this.wnidx={},this.weidx={},this.WINDOWVISIBLE=!0,this.MOUSEDOWN=!1,this.MOUSEHASMOVED=!1,this.ANIMATE=!1,this.intersected=null,this.program_factory=function(t){var i=n.render_node;return function(e){i(n,t,e)}},this},enable:function(){var e,t,i,n,o=this;new Ee.Vector2;(e=new Ee.PerspectiveCamera(40,this.width/this.height,10,1e4)).position.x=0,e.position.y=0,e.position.z=this.initial_z,(i=new Ee.Scene).autoUpdate=!0,(t=new Ee.TrackballControls(e,this.el)).rotateSpeed=5,t.zoomSpeed=4,t.panSpeed=3,t.noZoom=!1,t.noPan=!1,t.staticMoving=!0,t.dynamicDampingFactor=.3,t.minDistance=50,t.autoRotateSpeed=45e-5,t.AUTO_ROTATE=this.auto_rotate,(n=new L.GraphRenderer({antialias:!0})).sortObjects=!0,n.setSize(this.width,this.height),n.DISPLAY_EDGE=this.show_edges,n.DISPLAY_EDGE_LABEL=!0,n.DISPLAY_ARROW_INIT=!0,n.DISPLAY_ARROW_END=!0,n.ENABLE_FOG=!0,this.camera=e,this.controls=t,this.scene=i,this.renderer=n,this.changeFocusSpeed=1e3,this.changeCoordSpeed=800,this.fogDistance=800,O.bindAll(this,"animate","render","resize_rendering"),O.bindAll(this,"onMouseMove","onMouseUp","onMouseDown","onMouseOut","onDblClick"),this.listenTo(a.utils.asEvents(window),"focus",function(e){o.WINDOWVISIBLE=!0}),this.listenTo(a.utils.asEvents(window),"blur",function(e){o.WINDOWVISIBLE=!1}),this.listenTo(this.model,"change",function(){o.request_animation()}),this.listenTo(this.model.vs,"remove",function(e){o.stopListening(e,"change:coords")}),n.domElement.addEventListener("mousemove",this.onMouseMove,!1),n.domElement.addEventListener("mousedown",this.onMouseDown,!1),n.domElement.addEventListener("mouseout",this.onMouseOut,!1),n.domElement.addEventListener("mouseup",this.onMouseUp,!1),n.domElement.addEventListener("dblclick",this.onDblClick,!1);function r(e){o.request_animation(1e3)}return n.domElement.addEventListener("mousewheel",r,!1),n.domElement.addEventListener("DOMMouseScroll",r,!1),n.domElement.addEventListener("touchstart",function(e){o.MOUSEDOWN=!0,o.request_animation()},!1),n.domElement.addEventListener("touchend",function(e){o.MOUSEDOWN=!1},!1),n.domElement.className.split(" ").indexOf("pdg-renderer")<0&&(this.renderer.domElement.className+=" pdg-renderer"),this.el.appendChild(n.domElement),(this._width<0||this._height<0)&&this.listenTo(a.utils.asEvents(window),"resize",this.resize_rendering),this.set_clear_color(this.clear_color.getStyle()),this.renderer=n,this._inited=!0,this},set_clear_color:function(e){var t=new Ee.Color(e);this.background_style=t.getStyle(),this.renderer.setClearColor(t.getHex()),$(this.renderer.domElement).css("background-color",t.getStyle()),this.clear_color=t},resize_rendering:function(){if(this._inited){var e=this.width,t=this.height;this.controls.handleResize(),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.request_animation()}},clean:function(){var e,t,i=this.scene.children,n=this.scene;for(t=i.length-1;0<=t;t--)e=i[t],O.has(e,"_type")&&n.remove(e);this.wnodes=[],this.wedges=[],this.wnidx={},this.weidx={},this.request_animation()},append_node:function(e){var t=this,i=new Ee.Sprite;(t.wnidx[e.id]=i).position=new Ee.Vector3(0,0,0),i.scale.x=i.scale.y=t.wnode_scale(e),i._type="vertex",i._node=e,i._edges=[],i.program_material=t.get_material(t.node_materials,e),i.material=new Ee.SpriteCanvasMaterial({program:t.program_factory(i)}),t.listenTo(e,"change:coords",function(){t.setPosition(i.position,e.get("coords"),this.changeCoordSpeed,c.Easing.Elastic.OutIn)}),t.listenTo(e,"change:color",function(){i.material_needs_update=!0,t.request_animation()}),t.listenTo(e,"rmflag",function(){i.material_needs_update=!0,t.request_animation()}),t.listenTo(e,"addflag",function(){i.material_needs_update=!0,t.request_animation()}),t.wnodes.push(i),t.scene.add(i)},remove_node:function(e){var t=this.wnidx[e.id];this.scene.remove(t),delete this.wnidx[e.id],this.request_animation()},remove_edge:function(e){var t=this.weidx[e.id];this.scene.remove(t),delete this.weidx[e.id],console.log("gviz remove edge",e),this.request_animation()},append_edge:function(e){if(!(e.id in this.weidx)){var n=this,t=n.wnidx[e.source.id],i=n.wnidx[e.target.id];if(void 0!==t&&void 0!==i){var o=new Ee.Geometry;o.vertices.push(t.position.clone()),o.vertices.push(i.position.clone());var r=c.Easing.Circular.In,a=new Ee.LineBasicMaterial({}),s=new Ee.Line(o,a);s._type="edge",s._edge=e,n.set_line_material(s),this.weidx[e.id]=s,n.scene.add(s);function l(){o.computeBoundingSphere(),n.set_line_material(s)}n.listenTo(e.source,"change:coords",function(){e.collection&&n.setPosition(o.vertices[0],e.source.get("coords"),this.changeCoordSpeed,r,l)}),n.listenTo(e.target,"change:coords",function(){e.collection&&n.setPosition(o.vertices[1],e.target.get("coords"),this.changeCoordSpeed,r,l)}),n.listenTo(e,"rmflag",function(e,t){n.set_line_material(s),n.request_animation()}),n.listenTo(e,"addflag",function(e,t,i){n.set_line_material(s),n.request_animation()})}else console.log("edge without source or target")}},add_material:function(e,t,i){return this.set_material(e,t,i)},set_material:function(e,t,i){var n=["node","edge"];a.assert(-1<O.indexOf(n,e),["Wrong material type",n]),a.log("GViz: Adding material",e,t),t in this[e+"_materials"]?O.extend(this[e+"_materials"][t],i):this[e+"_materials"][t]=i},set_materials:function(i,e){_this=this;var t=["node","edge"];a.assert(-1<O.indexOf(t,i),["Wrong material type",t]),O.each(e,function(e){var t=O.keys(e)[0];_this.set_material(i,t,e[t])})},get_material:function(t,e){var n=e.flags||{},o=O.filter(O.keys(t),function(e){return"."==e.substring(0,1)}),r=O.extend({},t.default),a=!0;for(k in o=O.sortBy(o,function(e){return e.split(".").length}),O.each(o,function(e){for(css_classes=O(e.split(".")).rest(1),a=!0,i=0;i<css_classes.length;i++)if(!O(n).contains(css_classes[i])){a=!1;break}a&&(r=O.extend(r,t[e]))}),r){var s=r[k];if(O.isString(s)&&"get:"==s.substring(0,4)){var l=s.substring(4);s=e.get(l)}else if(O.isString(s)&&"prop:"==s.substring(0,5)){l=s.substring(5);s=e.properties.get(l)}else if(O.isFunction(s))try{s=s(e)}catch(e){s=0}r[k]=s}return e.nodetype&&(r.text_lines=function(e,t){var i=[],n=[],o={},r="",a=[{form:e.label,css:".normal-font"}];if(e.format_label&&(a=e.format_label(t.textLength)),void 0===a)return[];a.length&&(r+=(o=a[0]).form);for(var s=t.line_max_length;a.length||r.length;){var l=h(r,s,1),c=l[0],d=l[1];d=d||"",!c.length&&d.length&&(c=d,d=""),(s-=c.length)<=0&&(i.length,0<n.length&&i.push(n),n=[],s=t.line_max_length),c&&c.length&&n.push({form:c,css:o.css}),d.length&&c.length?(i.push(n),r=d,s=t.line_max_length,n=[]):r=d.length<=s?(d.length&&(n.push({form:d,css:o.css}),s-=(d="").length),0===s&&(i.push(n),n=[],s=line_max_length),a.length&&a.shift(),a.length?(o=a[0]).form:""):d}return n.length&&i.push(n),i}(e,r)),-1==L.SHAPES.indexOf(r.shape)&&(r.shape="circle"),r.id=e.id,r},set_node_material:function(e){var t=this.wnidx[e.id],i=this.get_material(this.node_materials,e),n={opacity:i.opacity,scale:i.scale,fontScale:i.fontScale};if(this.use_material_transitions&&0<this.node_material_transition_delay)i.opacity=t.program_material.opacity,i.scale=t.program_material.scale,i.fontScale=t.program_material.fontScale,tween=new c.Tween(i).to(n,this.node_material_transition_delay).start();else for(k in n)i[k]=n[k];t.program_material=i,t.material_needs_update=!1},set_line_material:function(e){var t=e._edge;if(null!=t){var i,n=this.get_material(this.edge_materials,t),o=null;O.isArray(n.color)&&2==n.color.length?(i=[new Ee.Color(n.color[0]),new Ee.Color(n.color[1])],o=Ee.VertexColors):i=new Ee.Color(n.color),e.material.linecap=n.linecap,e.material.linejoin=n.linejoin,e.material.lineType=n.lineType,e.material.dashSize=n.dashSize,e.material.gapSize=n.gapSize,e.material.vertexColors=o,e.geometry.colors=i,e.material.color=i,e.material.label_visible=n.label_visible,e.material.font=n.font,e.material.fontFillStyle=n.fontFillStyle,e.material.textAlign=n.textAlign,e.material.orientation_visible=n.orientation_visible;var r={opacity:n.opacity,linewidth:n.lineWidth};if(this.use_material_transitions&&0<this.edge_material_transition_delay)tween=new c.Tween(e.material).to(r,this.edge_material_transition_delay).start();else for(k in r)e.material[k]=r[k]}},setPosition:function(e,t,i,n,o){this.force_position_no_delay&&(i=0);o=o||null,n=n||c.Easing.Circular.In;var r={};if(O.isArray(t)?(t.length,t.push(0),r.x=1e3*t[0],r.y=1e3*t[1],r.z=1e3*t[2]):r=t,i)tween=new c.Tween(e).to(r,i).easing(n).onComplete(o).start();else for(k in r)e[k]=r[k]},increase_vertex_size:function(){this.user_vtx_size=Math.min(25,1.5*this.user_vtx_size),this.request_animation(100)},decrease_vertex_size:function(){this.user_vtx_size=Math.max(.1,this.user_vtx_size/1.5),this.request_animation(100)},increase_font_size:function(){this.user_font_size=Math.min(25,this.user_font_size+1),this.request_animation(100)},decrease_font_size:function(){this.user_font_size=Math.max(-5,this.user_font_size-1),this.request_animation(100)},collapse:function(e,t,i){if(0<this.scene.children.length){e|=0,i|=0;t=t||c.Easing.Circular.In;for(var n={x:0,y:0,z:0},o=0;o<this.wnodes.length;o++){var r=this.wnodes[o];this.setPosition(r.position,n,e,t,i)}for(o=0;o<this.wedges.length;o++){var a=this.wedges[o];this.setPosition(a.geometry.vertices[0],n,e,t,i),this.setPosition(a.geometry.vertices[1],n,e,t,i)}this.request_animation()}},setFocus:function(e){null==e&&(e=new Ee.Vector3(0,0,0)),tween=new c.Tween(this.controls.target).to(e,this.changeFocusSpeed).start()},request_animation:function(e){if(e){this.ANIMATE=!0,this._animate_timeout_id&&(clearTimeout(this._animate_timeout_id),this._animate_timeout_id=null);var t=this;this._animate_timeout_id=setTimeout(function(){t.ANIMATE=!1},e)}this._timeout_id&&(clearTimeout(this._timeout_id),this._timeout_id=null,requestAnimationFrame(this.animate))},animate:function(){this.render();var e=0<c.getAll().length;if((this.ANIMATE||e||this.MOUSEDOWN||this.controls.AUTO_ROTATE)&&this.WINDOWVISIBLE)requestAnimationFrame(this.animate);else{var t=this;this._timeout_id=setTimeout(function(){requestAnimationFrame(t.animate)},5e3)}return this},render:function(){this.controls.update(),c.update();var e=this.renderer.domElement,t=e.getContext("2d");return t.globalAlpha=1,t.fillStyle=this.background_style,t.fillRect(0,0,e.width,e.height),this.renderer.DISPLAY_EDGE=this.show_edges,this.renderer.DISPLAY_EDGE_LABEL=this.show_edges&&this.DISPLAY_EDGE_LABEL,this.renderer.DISPLAY_ARROW_INIT=this.show_edges&&this.DISPLAY_ARROW_INIT,this.renderer.DISPLAY_ARROW_END=this.show_edges&&this.DISPLAY_ARROW_END,this.renderer.ENABLE_FOG=this.ENABLE_FOG,this.renderer.render(this.scene,this.camera),this.renderClustersLabels(t),this.debug&&this.print_debug(),this},renderClustersLabels:function(e){if(this.clustering){var r=this;for(var t in this.clustering.clusters.models){var i=this.clustering.clusters.models[t],n=i.members.vs.models,a=0,s={x:0,y:0,minX:1e5,maxX:0,minY:1e5,maxY:0};n.forEach(function(e,t){var i=r.wnidx[e.id];if(i&&!(i.screenX<0)){var n=i.screenX,o=i.screenY;a++,s.y+=o,s.x+=n,s.minX=Math.min(n,s.minX),s.maxX=Math.max(n,s.maxX)}});var o="Cluster "+t;if(i.labels||i.labels.length)o=i.labels.map(function(e){return e.label}).join(", ");if(o.length){e.font=Math.min(25,14+a)+"px Arial",e.lineWidth=3;var l=e.measureText(o).width,c=e.measureText("M").width;s.y=s.y/a,s.x=1==a?s.x-l/2:s.minX+(s.maxX-s.minX-l)/2,e.beginPath(),e.rect(s.x-8,s.y-5-c,l+16,c+16),e.fillStyle="rgba(200,200,200, 0.5)",e.fill();var d="rgb("+i.color.join(",")+")";e.fillStyle=d,e.strokeStyle="#333",e.strokeText(o,s.x,s.y),e.fillText(o,s.x,s.y)}}}},print_debug:function(){var e=$(".gviz-debug",this.$el),t=$("<div></div>").append(["camera.x:"+this.camera.position.x+"<br/>","camera.y:"+this.camera.position.y+"<br/>","camera.z:"+this.camera.position.z+"<br/>","user_vtx_size:"+this.user_vtx_size+"<br/>","<br/>"]),i=this.intersected;if(i){var n=this.wnidx[i.id],o=i;t.append("<h3>"+i._type+"</h3>"),n?t.append("obj.id:"+o.get("id")+"<br/>").append("obj.x:"+n.position.x+"<br/>").append("obj.y:"+n.position.y+"<br/>").append("obj.z:"+n.position.z+"<br/>").append("<br/>").append("neighbors:"+o.get("neighbors")+"<br/>").append("<br/>").append("flags:"+o.get("flags")+"<br/>").append("<br/>").append("distance:"+o._distance+"<br/>").append("ratio:"+o._ratio+"<br/>").append("scale:"+this.wnode_scale(o)+"<br/>").append("wscale:"+n.scale.x+"<br/>").append("material scale:"+n.program_material.scale+"<br/>").append("font scale:"+n.program_material.fontScale+"<br/>").append("<br/>"):t.append("flags:"+i.get("flags")+"<br/>")}e.html(t)},getMouseOnCanvas:function(e,t){return{x:e.clientX-t.left,y:e.clientY-t.top}},onMouseMove:function(e){e.preventDefault();if(!(this.MOUSEHASMOVED=!0)===this.MOUSEDOWN){var t=this.el.getBoundingClientRect(),i=this.getMouseOnCanvas(e,t),n={x:i.x/$("canvas",this.$el).width()*2-1,y:2*-(i.y/$("canvas",this.$el).height())+1},o=new Ee.Raycaster;o.linePrecision=this.raycaster_precision,o.setFromCamera(n,this.camera);var r=null,a=o.intersectObjects(this.scene.children);if(0<a.length){for(var s in a){var l=a[s].object;if(l.material&&0!=l.material.opacity&&l.visible){var c=l._type;if("vertex"==c){r=l._node,this.trigger("vertex:mouseover",r,e);break}if("edge"==c){r=l._edge,this.trigger("edge:mouseover",r,e);break}}}null==r&&this.trigger("intersectOff",this.intersected,e)}else this.trigger("intersectOff",this.intersected,e);this.intersected=r}},onMouseDown:function(e){e.preventDefault(),this.MOUSEDOWN=!0,this.MOUSEHASMOVED=!1,this.request_animation()},onMouseUp:function(e){e.preventDefault();var t=null;!1===this.MOUSEHASMOVED&&(this.intersected instanceof a.Edge?t="edge":this.intersected instanceof a.Vertex&&(t="vertex"),t&&this.trigger(t+":click",this.intersected,e),this.trigger("click",this.intersected,e)),this.MOUSEDOWN=!1},onMouseOut:function(e){e.preventDefault(),this.MOUSEDOWN=!1},onDblClick:function(e){n.trigger("dblclick",this.intersected,e);var t=null;this.intersected instanceof a.Edge?t="edge":this.intersected instanceof a.Vertex&&(t="vertex"),t?this.trigger(t+":dblclick",this.intersected,e):this.controls.AUTO_ROTATE=!this.controls.AUTO_ROTATE}}),L.SHAPES="circle square losange diamond triangle triangle-top triangle-bottom".split(" "),L.ThreeVizHelpers={PI2:2*Math.PI,SPLIT_LABEL_RE:/^(.{4,15}) (.*)/m,to_color:function(e){if(O.isArray(e))return new Ee.Color(e[0],e[1],e[2])},meanColor:function(){var e=g=b=0;for(var t in arguments){var i=arguments[t];e+=i.r,g+=i.g,b+=i.b}return mean=new Ee.Color,mean.r=e/arguments.length,mean.g=g/arguments.length,mean.b=b/arguments.length,mean},wnode_scale:function(e){var t=e.get("SIZE");return this.user_vtx_size*t},render_node:function(c,e,d){var h=c,t=e._node;e.material_needs_update&&c.set_node_material(t);var i=e.program_material;if(i.opacity&&i.visible){if(d.globalAlpha=i.opacity,c.ENABLE_FOG&&null==t.flags[1]){var n=e.position.clone();n.add(c.camera.position),c.camera.worldToLocal(n);var o=1;o*=-1<=n.z?1:Math.exp(n.z/h.fogDistance),d.globalAlpha=i.opacity*o}var r=c.wnode_scale(t);if(c.adaptive_zoom){var a=c.camera.position.distanceTo(e.position),s=r/10;r=s+(+r-s)*(0==a?1:a/1e3),t._scale=r}if(e.scale.x!=r&&(e.scale.x=r,e.scale.y=r),d.scale(1,-1),d.save(),c.show_nodes){var l=null,p=i.scale,u=p,m=p;if(d.scale(p,p),t._scale*=p,"circle"==i.shape)d.beginPath(),d.arc(0,0,1,0,L.ThreeVizHelpers.PI2,!0),d.closePath();else if("square"==i.shape)d.beginPath(),d.moveTo(-1,-1),d.lineTo(-1,1),d.lineTo(1,1),d.lineTo(1,-1),d.lineTo(-1,-1),d.closePath();else if("losange"==i.shape||"diamond"==i.shape)d.beginPath(),d.moveTo(0,-1),d.lineTo(-1,0),d.lineTo(0,1),d.lineTo(1,0),d.closePath();else if("triangle"==i.shape||"triangle-top"==i.shape)d.beginPath(),d.moveTo(0,-1),d.lineTo(-1,1),d.lineTo(1,1),d.closePath();else if("triangle-bottom"==i.shape)d.beginPath(),d.moveTo(0,1),d.lineTo(-1,-1),d.lineTo(1,-1),d.closePath();else if(null!=(l=/^(rect:)([0-9/.]+),([0-9/.]+)/.exec(i.shape))){var g=u=l[2],f=m=l[3];d.beginPath(),d.moveTo(-g,-f),d.lineTo(-g,f),d.lineTo(g,f),d.lineTo(g,-f),d.lineTo(-g,-f),d.closePath()}if(i.fillStyle&&(A(d,"fillStyle",i.fillStyle),d.fill()),c.show_images&&i.image){var v=document.getElementById("img"+i.id);v&&v.width&&(d.clip(),d.drawImage(v,-u,-m,2*u,2*m))}0<i.lineWidth&&i.strokeStyle&&(d.lineWidth=i.lineWidth,A(d,"strokeStyle",i.strokeStyle),d.stroke())}if(d.restore(),c.show_text&&i.textVisible){d.save();var _=i.text_lines;for(var y in _){d.save();var x=0,w=0,b=0,S=0|i.textPaddingX,E=0|i.textPaddingY,T=1;O.each(_[y],function(e){var t=h.node_materials[e.css].font;t=z(t,c.user_font_size),d.font=t,T=O.max([T,parseInt(/([0-9]*)px/.exec(t)[1])]),b+=d.measureText(e.form).width}),w="center"==i.textVerticalAlign?1:"bottom"==i.textVerticalAlign?0:.5,x="left"==i.textAlign?(d.translate(+i.scale,0),0):"right"==i.textAlign?(d.translate(-1*i.scale,0),0-b):(d.translate(0,1),b/-2+0),d.scale(i.fontScale,i.fontScale);var M=d.measureText("M").width;w=w-(_.length-1)*M/2+y*M,O.each(_[y],function(e,t){var i=h.node_materials[e.css],n=0|i.paddingRelX,o=0|i.paddingRelY,r=z(i.font,c.user_font_size);parseInt(/([0-9]*)px/.exec(r)[1]);d.font=r;var a=x+S+n,s=w-E+o;i.fontFillStyle&&(A(d,"fillStyle",i.fontFillStyle),d.fillText(e.form,a,s)),i.fontStrokeStyle&&i.fontStrokeWidth&&(A(d,"strokeStyle",i.fontStrokeStyle),d.lineWidth=i.fontStrokeWidth,d.strokeText(e.form,a,s));var l=d.measureText(e.form).width;x+=l}),d.restore()}d.restore()}}},edge_materials:[{default:{lineWidth:2,linecap:"butt",linejoin:"bevel",lineType:"plain",dashSize:2,gapSize:5,opacity:.61,color:function(e){return[L.hexcolor(e.source.get("color")),L.hexcolor(e.target.get("color"))]},label_visible:!1,font:"normal 12px Arial",fontFillStyle:"#4C4D00",textAlign:"center",orientation_visible:!1}}],node_materials:[{default:{visible:!0,scale:1,z:1,opacity:1,line_max_length:15,shape:"circle",image:"prop:image",fillStyle:function(e){return"gradient:"+L.csscolor(e.get("color"))},strokeStyle:function(e){return"gradient:"+L.csscolor(e.get("color"))},lineWidth:.1,textLength:20,textVisible:!0,textAlign:"center",textVerticalAlign:"center",fontScale:.1,font:"normal 10px Arial",fontFillStyle:"#333",fontStrokeStyle:"#333",fontStrokeWidth:.1,paddingRelY:0,paddingRelX:2}},{".normal-font":{font:"normal 10px Arial",fontFillStyle:"#333",fontStrokeStyle:"#333",fontStrokeWidth:.1,paddingRelY:0,paddingRelX:2}}]};var t=L;return t.SimpleViz=function(o,e){e.model=o;var r=new t.ThreeViz(e);return r.on("click",function(e,t){null==e&&(n.trigger(s.unselect_nodes),n.trigger(s.unselect_edges),r.AUTO_FOCUS&&r.setFocus())}),r.on("vertex:click",function(e,t){if(e&&e.id&&e.has_flag&&0==e.has_flag("disabled")){var i=o.vs.by_flag("selected");1==i.length&&t.ctrlKey&&n.trigger(s.ui_create_edge,{source:i[0],target:e}),n.trigger(s.select_node,e)}}),r.on("vertex:mouseover",function(e,t){e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger("vertex:mouseover",e,t)}),r.on("vertex:dblclick",function(e,t){e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger("engine:expand_prox",{expand:[e.id],weights:[1]})}),r.on("edge:mouseover",function(e,t){e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger("edge:mouseover",e,t)}),r.on("edge:click",function(e,t){console.log("edge:click",e,t),e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&n.trigger(s.select_edge,e,t)}),r.on("dblclick",function(e,t){console.log("dblclick",e,t)}),r.on("intersectOff",function(e,t){e&&e.id&&e.has_flag&&0==e.has_flag("disabled")&&(o.es.remove_flag("intersected"),o.vs.remove_flag("intersected"),e.edgetype&&n.trigger("edge:mouseout",e,t),e.nodetype&&n.trigger("vertex:mouseout",e,t),r.request_animation())}),n.listenTo(n,"vertex:mouseout",function(e,t){e&&e.id&&e.remove_flag("intersected")}),n.listenTo(n,"vertex:mouseover",function(e,t){e&&e.id&&(o.vs.set_intersected(null!==e?e:[]),o.es.set_intersected(e.incident(4,!1)),e.has_flag("selected")&&(this.vertex_menu=e),r.request_animation())}),n.listenTo(n,"engine:request_animation",function(){r.request_animation()}),n.listenTo(n,"edge:mouseover",function(e,t){e&&e.id&&(o.vs.set_intersected([]),o.es.set_intersected(null!==e?e:[]))}),n.listenTo(n,"edge:mouseout",function(e,t){e&&e.id&&e.remove_flag("intersected")}),r.listenTo(o.vs,"reset",function(){console.log("padagraph-gviz","vs reset"),r.collapse(500),r.clean(),r.camera.position.x=0,r.camera.position.y=0,r.camera.position.z=r.initial_z,r.camera.lookAt(new Ee.Vector3(0,0,0))}),r.listenTo(o.es,"add",function(e){r.append_edge(e),r.listenTo(e,"addflag:selected",function(){e.add_flag("es-bolder",{silent:!0}),e.add_flag("es-mo-adjacent")}),r.listenTo(e,"rmflag:selected",function(){e.remove_flag("es-bolder",{silent:!0}),e.remove_flag("es-mo-adjacent")}),r.listenTo(e,"addflag:intersected",function(){e.add_flag("es-bolder")}),r.listenTo(e,"rmflag:intersected",function(){e.remove_flag("es-bolder")})}),r.listenTo(o.es,"remove",function(e,t){e.remove_flag("intersected",{silent:!0}),e.remove_flag("selected",{silent:!0}),e.remove_flag("disabled"),r.remove_edge(e)}.bind(this)),r.listenTo(o.vs,"remove",function(e){e.remove_flag("intersected",{silent:!0}),e.remove_flag("selected",{silent:!0}),e.remove_flag("disabled"),r.remove_node(e)}.bind(this)),r.listenTo(o.vs,"add",function(n){_size=function(e){return e.get("properties").has("size")?parseFloat(e.get("properties").get("size")):1};var t=O.map(o.vs.models,_size).sort();t=t[t.length/2|1],O.each(o.vs.models,function(e){e.set("SIZE",_size(e)/t*9)}),r.append_node(n),r.listenTo(n,"addflag:intersected",function(){var e=n.neighbors();e.push(n),o.vs.add_flag("mo-faded",O(o.vs.models).difference(e)),o.vs.add_flag("mo-adjacent",O(e).without(n));var t=o.incident(n);o.es.add_flag("es-mo-adjacent",t,!1),o.es.add_flag("es-mo-faded",O.difference(o.es.models,t),!1),r.request_animation()}),r.listenTo(n,"rmflag:intersected",function(){o.vs.remove_flag("mo-faded",o.vs.models),o.vs.remove_flag("mo-adjacent"),o.es.remove_flag("es-mo-adjacent",o.es.models),o.es.remove_flag("es-mo-faded"),o.es.remove_flag("es-bolder"),r.request_animation()}),r.listenTo(n,"addflag:selected",function(e){e.collection.remove_flag("selected",O(o.vs.models).without(e));var t=n.neighbors();e.collection.add_flag("sel-faded",O(o.vs.models).difference(t)),e.collection.add_flag("sel-adjacent",O(t).without(e));var i=o.incident(e);o.es.add_flag("es-bolder",i,{silent:!0}),o.es.add_flag("es-sel-adjacent",i,{silent:!0}),o.es.add_flag("es-sel-faded",O(o.es.models).difference(i)),r.request_animation()}),o.listenTo(n,"rmflag:selected",function(e){o.vs.remove_flag("mo-faded"),o.vs.remove_flag("sel-faded"),o.vs.remove_flag("sel-adjacent"),o.es.remove_flag("es-bolder"),o.es.remove_flag("es-sel-adjacent"),o.es.remove_flag("es-sel-faded"),o.es.remove_flag("es-mo-faded")})}.bind(this)),r},Ee.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},Ee.RenderableFace=function(){this.id=0,this.v1=new Ee.RenderableVertex,this.v2=new Ee.RenderableVertex,this.v3=new Ee.RenderableVertex,this.normalModel=new Ee.Vector3,this.vertexNormalsModel=[new Ee.Vector3,new Ee.Vector3,new Ee.Vector3],this.vertexNormalsLength=0,this.color=new Ee.Color,this.material=null,this.uvs=[new Ee.Vector2,new Ee.Vector2,new Ee.Vector2],this.z=0,this.renderOrder=0},Ee.RenderableVertex=function(){this.position=new Ee.Vector3,this.positionWorld=new Ee.Vector3,this.positionScreen=new Ee.Vector4,this.visible=!0},Ee.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},Ee.RenderableLine=function(){this.id=0,this.v1=new Ee.RenderableVertex,this.v2=new Ee.RenderableVertex,this.vertexColors=[new Ee.Color,new Ee.Color],this.material=null,this.z=0,this.renderOrder=0},Ee.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new Ee.Vector2,this.material=null,this.renderOrder=0},Ee.Projector=function(){var G,Z,o,$,Q,J,K,ee,te,ie,ne,oe=[],re=0,ae=[],t=0,i=[],n=0,r=[],a=0,s=[],l=0,se={objects:[],lights:[],elements:[]},le=new Ee.Vector3,ce=new Ee.Vector4,g=new Ee.Box3(new Ee.Vector3(-1,-1,-1),new Ee.Vector3(1,1,1)),f=new Ee.Box3,v=new Array(3),de=(new Array(4),new Ee.Matrix4),he=new Ee.Matrix4,pe=new Ee.Matrix4,ue=new Ee.Matrix3,me=new Ee.Frustum,ge=new Ee.Vector4,fe=new Ee.Vector4;this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var ve=new function(){function n(e){var t=e.position,i=e.positionWorld,n=e.positionScreen;i.copy(t).applyMatrix4(ne),n.copy(i).applyMatrix4(he);var o=1/n.w;n.x*=o,n.y*=o,n.z*=o,e.visible=-1<=n.x&&n.x<=1&&-1<=n.y&&n.y<=1&&-1<=n.z&&n.z<=1}function l(e,t,i){return!0===e.visible||!0===t.visible||!0===i.visible||(v[0]=e.positionScreen,v[1]=t.positionScreen,v[2]=i.positionScreen,g.isIntersectionBox(f.setFromPoints(v)))}function c(e,t,i){return(i.positionScreen.x-e.positionScreen.x)*(t.positionScreen.y-e.positionScreen.y)-(i.positionScreen.y-e.positionScreen.y)*(t.positionScreen.x-e.positionScreen.x)<0}var d=[],h=[],p=null,u=null,m=new Ee.Matrix3;return{setObject:function(e){u=(p=e).material,m.getNormalMatrix(p.matrixWorld),d.length=0,h.length=0},projectVertex:n,checkTriangleVisibility:l,checkBackfaceCulling:c,pushVertex:function(e,t,i){(o=_e()).position.set(e,t,i),n(o)},pushNormal:function(e,t,i){d.push(e,t,i)},pushUv:function(e,t){h.push(e,t)},pushLine:function(e,t){var i=ae[e],n=ae[t];(K=xe()).id=p.id,K.v1.copy(i),K.v2.copy(n),K.z=(i.positionScreen.z+n.positionScreen.z)/2,K.renderOrder=p.renderOrder,K.material=p.material,se.elements.push(K)},pushTriangle:function(e,t,i){var n=ae[e],o=ae[t],r=ae[i];if(!1!==l(n,o,r)&&(u.side===Ee.DoubleSide||!0===c(n,o,r))){(Q=ye()).id=p.id,Q.v1.copy(n),Q.v2.copy(o),Q.v3.copy(r),Q.z=(n.positionScreen.z+o.positionScreen.z+r.positionScreen.z)/3,Q.renderOrder=p.renderOrder,Q.normalModel.fromArray(d,3*e),Q.normalModel.applyMatrix3(m).normalize();for(var a=0;a<3;a++){var s=Q.vertexNormalsModel[a];s.fromArray(d,3*arguments[a]),s.applyMatrix3(m).normalize(),Q.uvs[a].fromArray(h,2*arguments[a])}Q.vertexNormalsLength=3,Q.material=p.material,se.elements.push(Q)}}}};function _e(){if($!==t)return ae[$++];var e=new Ee.RenderableVertex;return ae.push(e),t++,$++,e}function ye(){if(J!==n)return i[J++];var e=new Ee.RenderableFace;return i.push(e),n++,J++,e}function xe(){if(ee!==a)return r[ee++];var e=new Ee.RenderableLine;return r.push(e),a++,ee++,e}function we(){if(ie!==l)return s[ie++];var e=new Ee.RenderableSprite;return s.push(e),l++,ie++,e}function be(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id!==t.id?e.id-t.id:0}function Se(e,t){var i=0,n=1,o=e.z+e.w,r=t.z+t.w,a=-e.z+e.w,s=-t.z+t.w;return 0<=o&&0<=r&&0<=a&&0<=s||!(o<0&&r<0||a<0&&s<0)&&(o<0?i=Math.max(i,o/(o-r)):r<0&&(n=Math.min(n,o/(o-r))),a<0?i=Math.max(i,a/(a-s)):s<0&&(n=Math.min(n,a/(a-s))),!(n<i)&&(e.lerp(t,i),t.lerp(e,1-n),!0))}this.projectScene=function(e,t,i,n){ie=ee=J=0,!(se.elements.length=0)===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),de.copy(t.matrixWorldInverse.getInverse(t.matrixWorld)),he.multiplyMatrices(t.projectionMatrix,de),me.setFromMatrix(he),Z=0,se.objects.length=0,se.lights.length=0,e.traverseVisible(function(e){if(e instanceof Ee.Light)se.lights.push(e);else if(e instanceof Ee.Mesh||e instanceof Ee.Line||e instanceof Ee.Sprite){if(!1===e.material.visible)return;!1!==e.frustumCulled&&!0!==me.intersectsObject(e)||((G=function(){if(Z!==re)return oe[Z++];var e=new Ee.RenderableObject;return oe.push(e),re++,Z++,e}()).id=e.id,G.object=e,le.setFromMatrixPosition(e.matrixWorld),le.applyProjection(he),G.z=le.z,G.renderOrder=e.renderOrder,se.objects.push(G))}}),!0===i&&se.objects.sort(be);for(var o=0,r=se.objects.length;o<r;o++){var a=se.objects[o].object,s=a.geometry;if(ve.setObject(a),ne=a.matrixWorld,$=0,a instanceof Ee.Mesh){if(s instanceof Ee.BufferGeometry){var l=s.attributes,c=s.groups;if(void 0===l.position)continue;for(var d=0,h=(q=l.position.array).length;d<h;d+=3)ve.pushVertex(q[d],q[d+1],q[d+2]);if(void 0!==l.normal){var p=l.normal.array;for(d=0,h=p.length;d<h;d+=3)ve.pushNormal(p[d],p[d+1],p[d+2])}if(void 0!==l.uv){var u=l.uv.array;for(d=0,h=u.length;d<h;d+=2)ve.pushUv(u[d],u[d+1])}if(null!==s.index){var m=s.index.array;if(0<c.length)for(o=0;o<c.length;o++){var g=c[o];for(d=g.start,h=g.start+g.count;d<h;d+=3)ve.pushTriangle(m[d],m[d+1],m[d+2])}else for(d=0,h=m.length;d<h;d+=3)ve.pushTriangle(m[d],m[d+1],m[d+2])}else for(d=0,h=q.length/3;d<h;d+=3)ve.pushTriangle(d,d+1,d+2)}else if(s instanceof Ee.Geometry){var f=s.vertices,v=s.faces,_=s.faceVertexUvs[0];ue.getNormalMatrix(ne);for(var y=a.material,x=y instanceof Ee.MeshFaceMaterial,w=!0==x?a.material:null,b=0,S=f.length;b<S;b++){var E=f[b];if(le.copy(E),!0===y.morphTargets)for(var T=s.morphTargets,M=a.morphTargetInfluences,O=0,z=T.length;O<z;O++){var A=M[O];if(0!==A){var L=T[O].vertices[b];le.x+=(L.x-E.x)*A,le.y+=(L.y-E.y)*A,le.z+=(L.z-E.z)*A}}ve.pushVertex(le.x,le.y,le.z)}for(var C=0,D=v.length;C<D;C++){var R=v[C];if(void 0!==(y=!0==x?w.materials[R.materialIndex]:a.material)){var V=y.side,k=ae[R.a],P=ae[R.b],j=ae[R.c];if(!1!==ve.checkTriangleVisibility(k,P,j)){var N=ve.checkBackfaceCulling(k,P,j);if(V!==Ee.DoubleSide){if(V===Ee.FrontSide&&!1===N)continue;if(V===Ee.BackSide&&!0===N)continue}(Q=ye()).id=a.id,Q.v1.copy(k),Q.v2.copy(P),Q.v3.copy(j),Q.normalModel.copy(R.normal),!1!==N||V!==Ee.BackSide&&V!==Ee.DoubleSide||Q.normalModel.negate(),Q.normalModel.applyMatrix3(ue).normalize();for(var I=R.vertexNormals,W=0,F=Math.min(I.length,3);W<F;W++){var Y=Q.vertexNormalsModel[W];Y.copy(I[W]),!1!==N||V!==Ee.BackSide&&V!==Ee.DoubleSide||Y.negate(),Y.applyMatrix3(ue).normalize()}Q.vertexNormalsLength=I.length;var B=_[C];if(void 0!==B)for(var U=0;U<3;U++)Q.uvs[U].copy(B[U]);Q.color=R.color,Q.material=y,Q.z=(k.positionScreen.z+P.positionScreen.z+j.positionScreen.z)/3,Q.renderOrder=a.renderOrder,se.elements.push(Q)}}}}}else if(a instanceof Ee.Line){if(s instanceof Ee.BufferGeometry){if(void 0!==(l=s.attributes).position){var q;for(d=0,h=(q=l.position.array).length;d<h;d+=3)ve.pushVertex(q[d],q[d+1],q[d+2]);if(null!==s.index)for(d=0,h=(m=s.index.array).length;d<h;d+=2)ve.pushLine(m[d],m[d+1]);else{var X=a instanceof Ee.LineSegments?2:1;for(d=0,h=q.length/3-1;d<h;d+=X)ve.pushLine(d,d+1)}}}else if(s instanceof Ee.Geometry){if(pe.multiplyMatrices(he,ne),0===(f=a.geometry.vertices).length)continue;(k=_e()).positionScreen.copy(f[0]).applyMatrix4(pe);for(X=a instanceof Ee.LineSegments?2:1,b=1,S=f.length;b<S;b++)(k=_e()).positionScreen.copy(f[b]).applyMatrix4(pe),0<(b+1)%X||(P=ae[$-2],ge.copy(k.positionScreen),fe.copy(P.positionScreen),!0===Se(ge,fe)&&(ge.multiplyScalar(1/ge.w),fe.multiplyScalar(1/fe.w),(K=xe()).id=a.id,K.v1.positionScreen.copy(ge),K.v2.positionScreen.copy(fe),K.z=Math.max(ge.z,fe.z),K.renderOrder=a.renderOrder,K.material=a.material,(K.object=a).material.vertexColors===Ee.VertexColors&&(K.vertexColors[0].copy(a.geometry.colors[b]),K.vertexColors[1].copy(a.geometry.colors[b-1])),se.elements.push(K)))}}else if(a instanceof Ee.Sprite){ce.set(ne.elements[12],ne.elements[13],ne.elements[14],1),ce.applyMatrix4(he);var H=1/ce.w;ce.z*=H,-1<=ce.z&&ce.z<=1&&((te=we()).id=a.id,te.x=ce.x*H,te.y=ce.y*H,te.z=ce.z,te.renderOrder=a.renderOrder,te.object=a,te.rotation=a.rotation,te.scale.x=a.scale.x*Math.abs(te.x-(ce.x+t.projectionMatrix.elements[0])/(ce.w+t.projectionMatrix.elements[12])),te.scale.y=a.scale.y*Math.abs(te.y-(ce.y+t.projectionMatrix.elements[5])/(ce.w+t.projectionMatrix.elements[13])),te.material=a.material,se.elements.push(te))}}return!0===n&&se.elements.sort(be),se}},Ee.SpriteCanvasMaterial=function(e){Ee.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new Ee.Color(16777215),this.program=function(e,t){},this.setValues(e)},Ee.SpriteCanvasMaterial.prototype=Object.create(Ee.Material.prototype),Ee.SpriteCanvasMaterial.prototype.constructor=Ee.SpriteCanvasMaterial,Ee.SpriteCanvasMaterial.prototype.clone=function(){var e=new Ee.SpriteCanvasMaterial;return e.copy(this),e.color.copy(this.color),e.program=this.program,e},L.GraphRenderer=function(e){console.log("gviz.CanvasRenderer based on THREE ",Ee.REVISION);Ee.Math.smoothstep;e=e||{};var s,l,c,d,h,t,i,n,o,r,x=this,p=new Ee.Projector,a=void 0!==e.canvas?e.canvas:document.createElement("canvas"),u=a.width,m=a.height,g=Math.floor(u/2),f=Math.floor(m/2),w=a.getContext("2d",{alpha:!0===e.alpha}),v=new Ee.Color(0),_=0,y=1,b=0,S=null,E=null,T=null,M=null,O=null,z=(new Ee.RenderableVertex,new Ee.RenderableVertex,new Ee.Color,new Ee.Color,new Ee.Color,new Ee.Color,new Ee.Color,new Ee.Color,new Ee.Color,new Ee.Color,{}),A=new Ee.Box2,L=new Ee.Box2,C=new Ee.Box2,D=(new Ee.Color,new Ee.Color,new Ee.Color,new Ee.Vector3,new Ee.Vector3,new Ee.Matrix3),R=16;function V(e,t,i){W(i.opacity),F(i.blending);var n=t.scale.x*g,o=t.scale.y*f,r=.5*Math.sqrt(n*n+o*o);if(C.min.set(e.x-r,e.y-r),C.max.set(e.x+r,e.y+r),i instanceof Ee.SpriteMaterial||i instanceof Ee.ParticleSystemMaterial){var a=i.map;if(null!==a){!1===a.hasEventListener("update",j)&&(void 0!==a.image&&0<a.image.width&&N(a),a.addEventListener("update",j));var s=z[a.id];X(void 0!==s?s:"rgba( 0, 0, 0, 1 )");var l=a.image,c=l.width*a.offset.x,d=l.height*a.offset.y,h=l.width*a.repeat.x,p=l.height*a.repeat.y,u=n/h,m=o/p;w.save(),w.translate(e.x,e.y),0!==i.rotation&&w.rotate(i.rotation),w.translate(-n/2,-o/2),w.scale(u,m),w.translate(-c,-d),w.fillRect(c,d,h,p),w.restore()}else X(i.color.getStyle()),w.save(),w.translate(e.x,e.y),0!==i.rotation&&w.rotate(i.rotation),w.scale(n,-o),w.fillRect(-.5,-.5,1,1),w.restore()}else i instanceof Ee.SpriteCanvasMaterial&&(q(i.color.getStyle()),X(i.color.getStyle()),w.save(),w.translate(e.x,e.y),0!==i.rotation&&w.rotate(i.rotation),w.scale(n,o),i.program(w),w.restore())}function k(e,t,i,n){if(W(n.opacity),F(n.blending),Y(n.linewidth),B(n.linecap),U(n.linejoin),0!=x.DISPLAY_EDGE&&0!=n.opacity){var o=i.object._edge.source,r=i.object._edge.target;if(o&&r){var a=t.positionScreen.x-e.positionScreen.x,s=t.positionScreen.y-e.positionScreen.y;if(0!=a||0!=s){var l=e.positionScreen.x,c=t.positionScreen.x,d=e.positionScreen.y,h=t.positionScreen.y,p=l<c,u=Math.sqrt(Math.pow(a,2)+Math.pow(s,2)),m=Math.atan((h-d)/(c-l));l==c?0<h-d?m+=Math.PI/2:h<d&&(m-=Math.PI/2):c<l&&(m+=Math.PI),w.save(),w.translate(e.positionScreen.x,e.positionScreen.y+5),w.rotate(m),w.scale(1,-1);n.opacity;if(n.vertexColors!==Ee.VertexColors)w.strokeStyle=n.color.getStyle();else{var g=i.vertexColors[0].getStyle(),f=i.vertexColors[1].getStyle();if(g===f)w.strokeStyle=g;else{try{var v=w.createLinearGradient(0,0,u,0);v.addColorStop(0,g),v.addColorStop(1,f)}catch(e){v=g}w.strokeStyle=v}}"dashed"==n.lineType?w.setLineDash([n.dashSize,n.gapSize]):w.setLineDash([]),w.beginPath(),w.moveTo(0,0),w.lineTo(u,0),w.closePath(),w.stroke(),C.expandByScalar(2*n.linewidth),w.setLineDash([]);var _="";w.translate(u/2,0),x.DISPLAY_EDGE_LABEL&&n.label_visible&&(w.save(),_=(_=i.object._edge.label)||(p?r.label+" <--- "+o.label:o.label+" ---\x3e "+r.label),p||w.scale(-1,-1),w.textAlign=n.textAlign,w.font=n.font,w.fillStyle=n.fontFillStyle,w.fillText(_,0,-2),w.restore());if(x.DISPLAY_ARROW_END&&n.orientation_visible){var y=1.6*(r._scale/r._distance*1e3+3);w.save(),w.translate(-u/2+y,0),w.scale(-3,-3),q(f),P(0,.5,0,-.5,1,0),w.stroke(),w.restore()}if(x.DISPLAY_ARROW_INIT&&n.orientation_visible){y=1.6*(o._scale/o._distance*1e3+3)+5;w.save(),w.translate(u/2-y,0),w.scale(-3,-3),q(g),P(0,.5,0,-.5,1,0),w.stroke(),w.restore()}w.restore()}}}}function P(e,t,i,n,o,r){w.beginPath(),w.moveTo(e,t),w.lineTo(i,n),w.lineTo(o,r),w.closePath()}function j(e){N(e.target)}function N(e){var t=e.wrapS===Ee.RepeatWrapping,i=e.wrapT===Ee.RepeatWrapping,n=e.image,o=document.createElement("canvas");o.width=n.width,o.height=n.height;var r=o.getContext("2d");r.setTransform(1,0,0,-1,0,n.height),r.drawImage(n,0,0),z[e.id]=w.createPattern(o,!0==t&&!0==i?"repeat":!0==t&&!1==i?"repeat-x":!1==t&&!0==i?"repeat-y":"no-repeat")}function I(e,t,i){var n,o=t.x-e.x,r=t.y-e.y,a=o*o+r*r;0!=a&&(o*=n=i/Math.sqrt(a),r*=n,t.x+=o,t.y+=r,e.x-=o,e.y-=r)}function W(e){y!==e&&(w.globalAlpha=e,y=e)}function F(e){b!==e&&(e===Ee.NormalBlending?w.globalCompositeOperation="source-over":e===Ee.AdditiveBlending?w.globalCompositeOperation="lighter":e===Ee.SubtractiveBlending&&(w.globalCompositeOperation="darker"),b=e)}function Y(e){T!==e&&(w.lineWidth=e,T=e)}function B(e){M!==e&&(w.lineCap=e,M=e)}function U(e){O!==e&&(w.lineJoin=e,O=e)}function q(e){S!==e&&(w.strokeStyle=e,S=e)}function X(e){E!==e&&(w.fillStyle=e,E=e)}(t=document.createElement("canvas")).width=t.height=2,(i=t.getContext("2d")).fillStyle="rgba(0,0,0,1)",i.fillRect(0,0,2,2),n=i.getImageData(0,0,2,2),n.data,(o=document.createElement("canvas")).width=o.height=R,(r=o.getContext("2d")).translate(-R/2,-R/2),r.scale(R,R),R--,this.DISPLAY_EDGE=!0,this.DISPLAY_EDGE_LABEL=!0,this.DISPLAY_ARROW_INIT=!0,this.DISPLAY_ARROW_END=!0,this.ENABLE_FOG=!0,void 0===w.setLineDash&&(void 0!==w.mozDash?w.setLineDash=function(e){w.mozDash=null!==e[0]?e:null}:w.setLineDash=function(){}),this.domElement=a,this.devicePixelRatio=void 0!==e.devicePixelRatio?e.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setSize=function(e,t,i){u=e*this.devicePixelRatio,m=t*this.devicePixelRatio,g=Math.floor(u/2),f=Math.floor(m/2),a.width=u,a.height=m,1!==this.devicePixelRatio&&!1!==i&&(a.style.width=e+"px",a.style.height=t+"px"),A.min.set(-g,-f),A.max.set(g,f),L.min.set(-g,-f),L.max.set(g,f),y=1,b=0,O=M=T=E=S=null},this.setClearColor=function(e,t){v.set(e),_=void 0!==t?t:1,L.min.set(-g,-f),L.max.set(g,f)},this.setClearColorHex=function(e,t){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(e,t)},this.getMaxAnisotropy=function(){return 0},this.clear=function(){w.setTransform(1,0,0,-1,g,f),!1===L.isEmpty()&&(L.intersect(A),L.expandByScalar(2),_<1&&w.clearRect(0|L.min.x,0|L.min.y,L.max.x-L.min.x|0,L.max.y-L.min.y|0),0<_&&(F(Ee.NormalBlending),W(1),X("rgba("+Math.floor(255*v.r)+","+Math.floor(255*v.g)+","+Math.floor(255*v.b)+","+_+")"),w.fillRect(0|L.min.x,0|L.min.y,L.max.x-L.min.x|0,L.max.y-L.min.y|0)),L.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(e,t){if(t instanceof Ee.Camera!=!1){!0===this.autoClear&&this.clear(),w.setTransform(1,0,0,-1,g,f),x.info.render.vertices=0,x.info.render.faces=0,s=p.projectScene(e,t,this.sortObjects,this.sortElements),l=s.elements,s.lights,D.getNormalMatrix(t.matrixWorldInverse);for(var i=0,n=l.length;i<n;i++){var o=l[i],r=o.material;if(void 0!==r&&!1!==r.visible){if(C.makeEmpty(),o instanceof Ee.RenderableSprite){(c=o).x*=g,c.y*=f,o.object.x=c.x,o.object.y=c.y;var a=new Ee.Vector3;a.setFromMatrixPosition(o.object.matrixWorld),a.project(t),a.x=a.x*g+g,a.y=-a.y*f+f,o.object.screenX=a.x,o.object.screenY=a.y,V(c,o,r)}else if(o instanceof Ee.RenderableLine)c=o.v1,d=o.v2,c.positionScreen.x*=g,c.positionScreen.y*=f,d.positionScreen.x*=g,d.positionScreen.y*=f,C.setFromPoints([c.positionScreen,d.positionScreen]),!0===A.intersectsBox(C)&&k(c,d,o,r);else if(o instanceof Ee.RenderableFace){if(c=o.v1,d=o.v2,h=o.v3,c.positionScreen.z<-1||1<c.positionScreen.z)continue;if(d.positionScreen.z<-1||1<d.positionScreen.z)continue;if(h.positionScreen.z<-1||1<h.positionScreen.z)continue;c.positionScreen.x*=g,c.positionScreen.y*=f,d.positionScreen.x*=g,d.positionScreen.y*=f,h.positionScreen.x*=g,h.positionScreen.y*=f,0<r.overdraw&&(I(c.positionScreen,d.positionScreen,r.overdraw),I(d.positionScreen,h.positionScreen,r.overdraw),I(h.positionScreen,c.positionScreen,r.overdraw)),C.setFromPoints([c.positionScreen,d.positionScreen,h.positionScreen]),!0===A.intersectsBox(C)&&renderFace3(c,d,h,0,1,2,o,r)}L.union(C)}}w.setTransform(1,0,0,1,0,0)}else console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.")}},L.Layout.ForceDirected={run:function(i,e){var n,o,r,t,a,s,l,c,d,h,p,u,m,g;for(a=i,n=(e=e||{}).hasOwnProperty("iterations")?e.iterations:1e4,o=e.hasOwnProperty("forceStrength")?e.forceStrength:10,r=.01,d=new Ee.Vector3,i.vs.each(function(e){e.position=new Ee.Vector3(Math.random(),Math.random(),Math.random()),e.force=new Ee.Vector3(Math.random(),Math.random(),Math.random())}),t=function(){r-=.01/n;var e=i.vs.elements,t=i.vs.elements;for(l=0;l<e.length;l+=1)for(c=0;c<e.length;c+=1)l!==c&&(p=e[l],u=e[c],d.subVectors(u.position,p.position),(h=d.length())<.1&&(d.set(Math.random(),Math.random(),Math.random()).multiplyScalar(.1).addScalar(.1),h=d.length()),h<50&&(d.multiplyScalar(o*o/(h*h)),p.force.sub(d.clone().multiplyScalar(u.scale.x)),u.force.add(d.clone().multiplyScalar(p.scale.x))));for(l=0;l<t.length;l+=1)p=e[t[l].source],u=e[t[l].target],d.subVectors(u.position,p.position),(h=d.length())<.1&&(d.set(Ee.Math.randFloat(.1,.2),Ee.Math.randFloat(.1,.2),Ee.Math.randFloat(.1,.2)),h=d.length()),h=Math.min(h,50),d.multiplyScalar((h*h-o*o)/(h*o)),p.force.add(d.clone().multiplyScalar(u.scale.x)),u.force.sub(d.clone().multiplyScalar(p.scale.x));for(l=0;l<e.length;l+=1)(p=e[l]).force.multiplyScalar(r),p.force.setX(Ee.Math.clamp(p.force.x,-2,2)),p.force.setY(Ee.Math.clamp(p.force.y,-2,2)),p.force.setZ(Ee.Math.clamp(p.force.z,-2,2)),p.position.add(p.force),p.force.set(0,0,0);for(l=0;l<t.length;l+=1)m=t[l],p=e[m.source],u=e[m.target],h=u.position.distanceTo(p.position),m.position.addVectors(p.position,u.position).divideScalar(2),m.lookAt(u.position),m.scale.z=h,a.directed&&((g=a.arrows[l]).position.copy(m.position),g.lookAt(u.position))},s=0;s<n;s+=1)setTimeout(t,0)}},t});